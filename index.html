<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>গুডাউন ম্যানেজমেন্ট সিস্টেম</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signInAnonymously, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence // For admin persistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            onSnapshot, 
            updateDoc, 
            deleteDoc,
            Timestamp,
            orderBy,
            limit,
            writeBatch,
            // setLogLevel // Uncomment if needed
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", // Replace if not using __firebase_config
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // setLogLevel('debug'); // Uncomment for Firestore debugging if issues persist

        // --- Global State ---
        let currentUser = null;
        let currentSection = null; // 'Kitchen', 'Men', 'Family'
        let currentUserId = null; // Firebase UID
        let productsCache = [];
        let unsubscribeProductsListener = null;
        let unsubscribeOrdersListener = null;
        let unsubscribeNotificationsListener = null;
        let unsubscribeLowStockListener = null;
        let unsubscribeDeliveryRecordsListener = null;

        // --- Passcodes ---
        const PASSCODES = {
            KhamerK: "Kitchen",
            KhamerM: "Men",
            KhamerF: "Family"
        };

        // --- UI Elements ---
        const views = {
            loginView: document.getElementById('loginView'),
            adminDashboardView: document.getElementById('adminDashboardView'),
            userDashboardView: document.getElementById('userDashboardView'),
            loadingView: document.getElementById('loadingView')
        };

        const adminNavLinks = document.querySelectorAll('.admin-nav-link');
        const adminSections = {
            adminProductsSection: document.getElementById('adminProductsSection'),
            adminOrdersSection: document.getElementById('adminOrdersSection'),
            adminRestockSection: document.getElementById('adminRestockSection'),
            adminLowStockSection: document.getElementById('adminLowStockSection'),
            adminReportsSection: document.getElementById('adminReportsSection'),
            adminNotificationsSection: document.getElementById('adminNotificationsSection')
        };
        
        const userNavLinks = document.querySelectorAll('.user-nav-link');
        const userSections = {
            userPlaceOrderSection: document.getElementById('userPlaceOrderSection'),
            userMyOrdersSection: document.getElementById('userMyOrdersSection'),
            userNotificationsSection: document.getElementById('userNotificationsSection')
        };

        // Admin Login
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminEmailInput = document.getElementById('adminEmail');
        const adminPasswordInput = document.getElementById('adminPassword');

        // User Login
        const userLoginForm = document.getElementById('userLoginForm');
        const userPasscodeInput = document.getElementById('userPasscode');
        
        // Logout Buttons
        const adminLogoutButton = document.getElementById('adminLogoutButton');
        const userLogoutButton = document.getElementById('userLogoutButton');

        // Admin Products
        const addProductForm = document.getElementById('addProductForm');
        const productNameInput = document.getElementById('productName');
        const productQuantityInput = document.getElementById('productQuantity');
        const productUnitSelect = document.getElementById('productUnit'); // pieces or kg
        const productCategoryInput = document.getElementById('productCategory');
        const lowStockAlertInput = document.getElementById('lowStockAlert');
        const productsTableBody = document.getElementById('productsTableBody');
        const restockModal = document.getElementById('restockModal');
        const restockForm = document.getElementById('restockForm');
        const restockProductIdInput = document.getElementById('restockProductId');
        const restockProductNameSpan = document.getElementById('restockProductNameSpan');
        const restockQuantityInput = document.getElementById('restockQuantity');
        const damagedQuantityInput = document.getElementById('damagedQuantity');
        const closeRestockModalButton = document.getElementById('closeRestockModalButton');

        // Admin Orders
        const adminOrdersTableBody = document.getElementById('adminOrdersTableBody');
        const adminOrderFilterSelect = document.getElementById('adminOrderFilter');

        // Admin Low Stock
        const lowStockTableBody = document.getElementById('lowStockTableBody');
        
        // Admin Reports
        const deliveryReportTableBody = document.getElementById('deliveryReportTableBody');
        const reportMonthSelect = document.getElementById('reportMonthSelect');
        const cleanupOldRecordsButton = document.getElementById('cleanupOldRecordsButton');

        // Admin Notifications
        const adminNotificationsList = document.getElementById('adminNotificationsList');

        // User Place Order
        const userProductsListDiv = document.getElementById('userProductsList');
        const userShoppingCartDiv = document.getElementById('userShoppingCart');
        const placeOrderButton = document.getElementById('placeOrderButton');
        let shoppingCart = []; // { productId, name, quantity, unit, price (if any) }

        // User My Orders
        const userOrdersTableBody = document.getElementById('userOrdersTableBody');
        const userCancelItemModal = document.getElementById('userCancelItemModal');
        const userCancelItemForm = document.getElementById('userCancelItemForm');
        const userCancelOrderIdInput = document.getElementById('userCancelOrderId');
        const userCancelItemIdInput = document.getElementById('userCancelItemId'); // This will be product ID
        const userCancelItemNameSpan = document.getElementById('userCancelItemNameSpan');
        const userCancelReasonInput = document.getElementById('userCancelReason');
        const closeUserCancelModalButton = document.getElementById('closeUserCancelModalButton');
        
        // User Notifications
        const userNotificationsList = document.getElementById('userNotificationsList');
        const userSectionTitle = document.getElementById('userSectionTitle');


        // --- Utility Functions ---
        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
        }

        function showAdminSection(sectionName) {
            Object.values(adminSections).forEach(section => section.classList.add('hidden'));
            if (adminSections[sectionName]) {
                adminSections[sectionName].classList.remove('hidden');
            }
            adminNavLinks.forEach(link => {
                link.classList.remove('bg-blue-700', 'text-white');
                link.classList.add('text-blue-100', 'hover:bg-blue-600');
                if (link.dataset.section === sectionName) {
                    link.classList.add('bg-blue-700', 'text-white');
                }
            });
        }
        
        function showUserSection(sectionName) {
            Object.values(userSections).forEach(section => section.classList.add('hidden'));
            if (userSections[sectionName]) {
                userSections[sectionName].classList.remove('hidden');
            }
            userNavLinks.forEach(link => {
                link.classList.remove('bg-green-700', 'text-white');
                link.classList.add('text-green-100', 'hover:bg-green-600');
                if (link.dataset.section === sectionName) {
                    link.classList.add('bg-green-700', 'text-white');
                }
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');

            if (type === 'success') {
                toast.classList.add('bg-green-500');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-blue-500');
            }
            toast.classList.remove('hidden');
            toast.classList.add('animate-fadeInOut');


            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('animate-fadeInOut');
            }, 3000);
        }
        
        function generateId() { // Simple ID generator
            return Math.random().toString(36).substr(2, 9);
        }

        // --- Firebase Auth Logic ---
        onAuthStateChanged(auth, async (user) => {
            showView('loadingView');
            if (user) {
                currentUser = user;
                currentUserId = user.uid;

                if (user.email) { // Admin user
                    await loadAdminData();
                    showView('adminDashboardView');
                    showAdminSection('adminProductsSection');
                } else { // Anonymous user
                    const userSessionDocRef = doc(db, `/artifacts/${appId}/users/${user.uid}/session/data`); // MODIFIED PATH
                    try {
                        const docSnap = await getDoc(userSessionDocRef);
                        if (docSnap.exists() && docSnap.data() && docSnap.data().section) {
                            currentSection = docSnap.data().section;
                            userSectionTitle.textContent = `${currentSection} বিভাগ`;
                            await loadUserData();
                            showView('userDashboardView');
                            showUserSection('userPlaceOrderSection');
                        } else {
                            // Detailed logging for why sign out is happening
                            if (!docSnap.exists()) {
                                console.error(`SESSION DOC MISSING: No session data found for anonymous user UID: ${user.uid}. Path: ${userSessionDocRef.path}`);
                            } else if (!docSnap.data()) {
                                console.error(`SESSION DOC EMPTY: Session data is null/undefined for UID: ${user.uid}. Path: ${userSessionDocRef.path}. Data:`, docSnap.data());
                            } else if (!docSnap.data().section) {
                                console.error(`SECTION MISSING IN DOC: Section not found in user session data for UID: ${user.uid}. Path: ${userSessionDocRef.path}. Data:`, docSnap.data());
                            }
                            await performSignOut();
                        }
                    } catch (error) {
                        console.error(`Error fetching user session from Firestore for UID ${user.uid}: `, error);
                        showToast("সেশন পুনরুদ্ধার করতে সমস্যা হয়েছে।", "error");
                        await performSignOut();
                    }
                }
            } else {
                currentUser = null;
                currentUserId = null;
                currentSection = null;
                shoppingCart = [];
                cleanupListeners();
                showView('loginView');
            }
        });

        if (adminLoginForm) {
            adminLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = adminEmailInput.value;
                const password = adminPasswordInput.value;
                showView('loadingView');
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                    showToast("অ্যাডমিন লগইন সফল হয়েছে!", "success");
                } catch (error) {
                    console.error("Admin login error: ", error);
                    showToast(`লগইন ব্যর্থ: ${error.message}`, "error");
                    showView('loginView');
                }
            });
        }

        if (userLoginForm) {
            userLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const passcode = userPasscodeInput.value;
                const section = PASSCODES[passcode];
                showView('loadingView');

                if (section) {
                    try {
                        const userCredential = await signInAnonymously(auth);
                        currentUserId = userCredential.user.uid;
                        currentSection = section;
                        
                        const userSessionDocRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/session/data`); // MODIFIED PATH
                        await setDoc(userSessionDocRef, { 
                            section: currentSection, 
                            uid: currentUserId, 
                            loggedInAt: Timestamp.now() 
                        });
                        
                        // userSectionTitle.textContent = `${currentSection} বিভাগ`; // This will be set by onAuthStateChanged
                        showToast(`${section} বিভাগে লগইন সফল!`, "success");
                        // onAuthStateChanged will handle showing the user dashboard by reading the session.
                    } catch (error) {
                        console.error("User anonymous login error: ", error);
                        showToast(`লগইন ব্যর্থ: ${error.message}`, "error");
                        showView('loginView');
                    }
                } else {
                    showToast("অবৈধ পাসকোড!", "error");
                    showView('loginView');
                }
            });
        }
        
        async function performSignOut() {
            showView('loadingView');
            const userToSignOut = auth.currentUser; // Get user before signOut
            
            await signOut(auth); // This will trigger onAuthStateChanged

            // Optional: Clean up session document if user was anonymous and explicitly logged out
            // Note: This part is tricky because currentUserId might be null after signOut if onAuthStateChanged runs first.
            // It's safer to handle cleanup based on `userToSignOut` if needed.
            // For now, we'll leave the session doc, it doesn't cause harm.
            // if (userToSignOut && userToSignOut.isAnonymous) {
            //     try {
            //         const userSessionDocRef = doc(db, `/artifacts/${appId}/users/${userToSignOut.uid}/session/data`);
            //         // await deleteDoc(userSessionDocRef); // Uncomment if session doc should be deleted on logout
            //     } catch (error) {
            //         console.error("Error deleting user session on logout:", error);
            //     }
            // }
            showToast("সফলভাবে লগ আউট করা হয়েছে।", "info");
        }

        if (adminLogoutButton) adminLogoutButton.addEventListener('click', performSignOut);
        if (userLogoutButton) userLogoutButton.addEventListener('click', performSignOut);

        // --- Firestore Data Functions ---

        // PRODUCTS (Admin)
        async function addProduct(e) {
            e.preventDefault();
            const name = productNameInput.value;
            let quantity = parseFloat(productQuantityInput.value);
            const unit = productUnitSelect.value;
            const category = productCategoryInput.value;
            let lowStock = parseInt(lowStockAlertInput.value);

            if (!name || isNaN(quantity) || !category || isNaN(lowStock)) {
                showToast("অনুগ্রহ করে সকল আবশ্যক ফিল্ড পূরণ করুন।", "error");
                return;
            }
            if (quantity < 0 || lowStock < 0) {
                showToast("সংখ্যা এবং লো স্টক অ্যালার্ট ঋণাত্মক হতে পারবে না।", "error");
                return;
            }

            try {
                const newProdRef = doc(collection(db, `/artifacts/${appId}/public/data/products`));
                await setDoc(newProdRef, {
                    id: newProdRef.id,
                    name,
                    stock: quantity,
                    unit,
                    category,
                    lowStockAlertThreshold: lowStock,
                    isLowStockAlertIgnored: false,
                    createdAt: Timestamp.now(),
                    updatedAt: Timestamp.now()
                });
                showToast("পণ্য সফলভাবে যোগ করা হয়েছে!", "success");
                addProductForm.reset();
            } catch (error) {
                console.error("Error adding product: ", error);
                showToast("পণ্য যোগ করতে সমস্যা হয়েছে।", "error");
            }
        }
        if (addProductForm) addProductForm.addEventListener('submit', addProduct);

        function renderProductsTable(products) {
            productsCache = products; 
            if (!productsTableBody) return;
            productsTableBody.innerHTML = '';
            products.forEach(product => {
                const row = productsTableBody.insertRow();
                row.insertCell().textContent = product.name;
                row.insertCell().textContent = `${product.stock.toFixed(product.unit === 'kg' ? 2 : 0)} ${product.unit}`;
                row.insertCell().textContent = product.category;
                row.insertCell().textContent = product.lowStockAlertThreshold;
                
                const actionsCell = row.insertCell();
                actionsCell.classList.add('space-x-2');
                const restockButton = document.createElement('button');
                restockButton.textContent = 'রিস্টক';
                restockButton.classList.add('bg-green-500', 'hover:bg-green-700', 'text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-sm');
                restockButton.onclick = () => openRestockModal(product);
                actionsCell.appendChild(restockButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'ডিলিট';
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-700', 'text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-sm');
                deleteButton.onclick = () => deleteProduct(product.id, product.name);
                actionsCell.appendChild(deleteButton);
            });
        }
        
        async function deleteProduct(productId, productName) {
            const confirmModal = document.getElementById('customConfirmModal');
            const confirmMessage = document.getElementById('customConfirmMessage');
            const confirmYesButton = document.getElementById('customConfirmYes');
            const confirmNoButton = document.getElementById('customConfirmNo');

            confirmMessage.textContent = `আপনি কি "${productName}" পণ্যটি ডিলিট করতে চান?`;
            confirmModal.classList.remove('hidden');

            confirmYesButton.onclick = async () => {
                confirmModal.classList.add('hidden');
                try {
                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/products`, productId));
                    showToast(`"${productName}" পণ্যটি ডিলিট করা হয়েছে।`, "success");
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    showToast("পণ্য ডিলিট করতে সমস্যা হয়েছে।", "error");
                }
            };

            confirmNoButton.onclick = () => {
                confirmModal.classList.add('hidden');
            };
        }


        function openRestockModal(product) {
            if (!restockModal || !restockProductIdInput || !restockProductNameSpan) return;
            restockProductIdInput.value = product.id;
            restockProductNameSpan.textContent = product.name;
            restockForm.reset(); 
            document.getElementById('currentStockSpan').textContent = `${product.stock} ${product.unit}`;
            restockModal.classList.remove('hidden');
        }
        if (closeRestockModalButton) closeRestockModalButton.onclick = () => restockModal.classList.add('hidden');

        async function handleRestock(e) {
            e.preventDefault();
            const productId = restockProductIdInput.value;
            const quantityAdded = parseFloat(restockQuantityInput.value) || 0;
            const quantityDamaged = parseFloat(damagedQuantityInput.value) || 0;

            if (quantityAdded < 0 || quantityDamaged < 0) {
                showToast("সংখ্যা ঋণাত্মক হতে পারবে না।", "error");
                return;
            }
            if (quantityAdded === 0 && quantityDamaged === 0) {
                showToast("দয়া করে যোগকৃত বা ক্ষতিগ্রস্ত পণ্যের পরিমাণ লিখুন।", "error");
                return;
            }

            const productRef = doc(db, `/artifacts/${appId}/public/data/products`, productId);
            try {
                const productDoc = await getDoc(productRef);
                if (!productDoc.exists()) {
                    showToast("পণ্যটি খুঁজে পাওয়া যায়নি।", "error");
                    return;
                }
                const productData = productDoc.data();
                const currentStock = parseFloat(productData.stock);
                const newStock = currentStock + quantityAdded - quantityDamaged;

                if (newStock < 0) {
                    showToast("স্টক ক্ষতিগ্রস্ত পণ্যের পরিমাণের চেয়ে কম হতে পারে না।", "error");
                    return;
                }

                await updateDoc(productRef, {
                    stock: newStock,
                    updatedAt: Timestamp.now(),
                    isLowStockAlertIgnored: false 
                });

                const restockLogRef = collection(db, `/artifacts/${appId}/public/data/restockLog`);
                await addDoc(restockLogRef, {
                    productId: productId,
                    productName: productData.name,
                    quantityAdded: quantityAdded,
                    quantityDamagedReturned: quantityDamaged,
                    previousStock: currentStock,
                    newStock: newStock,
                    date: Timestamp.now(),
                    restockedBy: currentUser.email 
                });

                showToast("পণ্য সফলভাবে রিস্টক করা হয়েছে!", "success");
                restockModal.classList.add('hidden');
            } catch (error) {
                console.error("Error restocking product: ", error);
                showToast("পণ্য রিস্টক করতে সমস্যা হয়েছে।", "error");
            }
        }
        if (restockForm) restockForm.addEventListener('submit', handleRestock);

        // ORDERS (Admin & User)
        async function placeNewOrder() {
            if (shoppingCart.length === 0) {
                showToast("আপনার শপিং কার্ট খালি।", "error");
                return;
            }

            const orderItems = shoppingCart.map(item => ({
                productId: item.productId,
                productName: item.name,
                quantityOrdered: item.quantity,
                quantityDelivered: item.quantity, 
                unit: item.unit,
            }));

            try {
                const newOrderRef = doc(collection(db, `/artifacts/${appId}/public/data/orders`));
                await setDoc(newOrderRef, {
                    id: newOrderRef.id,
                    section: currentSection,
                    orderByUserId: currentUserId, 
                    items: orderItems,
                    status: "pending", 
                    orderDate: Timestamp.now(),
                    cancellationRequests: [] 
                });

                const batch = writeBatch(db);
                for (const item of orderItems) {
                    const productRef = doc(db, `/artifacts/${appId}/public/data/products`, item.productId);
                    const productDoc = await getDoc(productRef);
                    if (productDoc.exists()) {
                        const currentStock = productDoc.data().stock;
                        const newStock = currentStock - item.quantityOrdered;
                        if (newStock < 0) {
                            showToast(`"${item.productName}" পর্যাপ্ত পরিমাণে স্টকে নেই।`, "warning");
                            batch.update(productRef, { stock: 0, updatedAt: Timestamp.now() });
                        } else {
                             batch.update(productRef, { stock: newStock, updatedAt: Timestamp.now() });
                        }
                    }
                }
                await batch.commit();
                await addNotification("Admin", `নতুন অর্ডার #${newOrderRef.id.substring(0,6)} ${currentSection} বিভাগ থেকে এসেছে।`);
                showToast("অর্ডার সফলভাবে প্লেস করা হয়েছে!", "success");
                shoppingCart = [];
                renderShoppingCart();
            } catch (error) {
                console.error("Error placing order: ", error);
                showToast("অর্ডার প্লেস করতে সমস্যা হয়েছে।", "error");
            }
        }
        if (placeOrderButton) placeOrderButton.addEventListener('click', placeNewOrder);

        function renderAdminOrdersTable(orders) {
            if (!adminOrdersTableBody) return;
            adminOrdersTableBody.innerHTML = '';
            
            let filteredOrders = orders;
            const filterValue = adminOrderFilterSelect.value;
            if (filterValue !== "all") {
                filteredOrders = orders.filter(order => order.section === filterValue);
            }

            filteredOrders.forEach(order => {
                const row = adminOrdersTableBody.insertRow();
                row.insertCell().textContent = order.id.substring(0, 6);
                row.insertCell().textContent = order.section;
                row.insertCell().innerHTML = order.items.map(item => 
                    `<div>${item.productName} (অর্ডারকৃত: ${item.quantityOrdered}${item.unit}, ডেলিভারিকৃত: ${item.quantityDelivered}${item.unit})</div>`
                ).join('');
                row.insertCell().textContent = new Date(order.orderDate.seconds * 1000).toLocaleDateString('bn-BD');
                
                const statusCell = row.insertCell();
                const statusBadge = document.createElement('span');
                statusBadge.textContent = translateStatus(order.status);
                statusBadge.classList.add('px-2', 'py-1', 'text-xs', 'font-semibold', 'rounded-full');
                setStatusBadgeColor(statusBadge, order.status);
                statusCell.appendChild(statusBadge);

                if (order.cancellationRequests && order.cancellationRequests.filter(req => req.status === 'pending').length > 0) {
                    const crBadge = document.createElement('span');
                    crBadge.textContent = "বাতিলের অনুরোধ আছে";
                    crBadge.classList.add('ml-2', 'px-2', 'py-1', 'text-xs', 'font-semibold', 'rounded-full', 'bg-yellow-200', 'text-yellow-800');
                    statusCell.appendChild(crBadge);
                }

                const actionsCell = row.insertCell();
                actionsCell.classList.add('space-x-1', 'whitespace-nowrap');

                if (order.status === 'pending' || order.status === 'processing') {
                    const processButton = document.createElement('button');
                    processButton.textContent = 'প্রসেসিং';
                    processButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'py-1', 'px-2', 'rounded', 'text-sm');
                    processButton.onclick = () => updateOrderStatus(order.id, 'processing');
                    actionsCell.appendChild(processButton);

                    const deliverButton = document.createElement('button');
                    deliverButton.textContent = 'ডেলিভার';
                    deliverButton.classList.add('bg-green-500', 'hover:bg-green-700', 'text-white', 'py-1', 'px-2', 'rounded', 'text-sm');
                    deliverButton.onclick = () => markOrderDelivered(order); 
                    actionsCell.appendChild(deliverButton);
                }
                 if (order.status !== 'cancelled' && order.status !== 'delivered') {
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'বাতিল';
                    cancelButton.classList.add('bg-red-500', 'hover:bg-red-700', 'text-white', 'py-1', 'px-2', 'rounded', 'text-sm');
                    cancelButton.onclick = () => cancelOrder(order); 
                    actionsCell.appendChild(cancelButton);
                }

                const pendingRequests = order.cancellationRequests?.filter(req => req.status === 'pending');
                if (pendingRequests && pendingRequests.length > 0) {
                    pendingRequests.forEach(req => {
                        const reqDiv = document.createElement('div');
                        reqDiv.classList.add('mt-1', 'p-1', 'bg-yellow-100', 'rounded', 'text-xs');
                        const productForItem = order.items.find(i => i.productId === req.itemId);
                        reqDiv.innerHTML = `বাতিলের অনুরোধ: ${productForItem?.productName || req.itemId}. কারণ: ${req.reason || 'N/A'}`;
                        
                        const approveBtn = document.createElement('button');
                        approveBtn.textContent = 'অনুমোদন';
                        approveBtn.classList.add('bg-green-500', 'text-white', 'px-1', 'py-0.5', 'rounded', 'text-xs', 'ml-1');
                        approveBtn.onclick = () => handleCancellationRequest(order.id, req.itemId, true);
                        reqDiv.appendChild(approveBtn);

                        const rejectBtn = document.createElement('button');
                        rejectBtn.textContent = 'বাতিল করুন'; // Should be 'প্রত্যাখ্যান' (Reject)
                        rejectBtn.classList.add('bg-red-500', 'text-white', 'px-1', 'py-0.5', 'rounded', 'text-xs', 'ml-1');
                        rejectBtn.onclick = () => handleCancellationRequest(order.id, req.itemId, false);
                        reqDiv.appendChild(rejectBtn);
                        actionsCell.appendChild(reqDiv);
                    });
                }
            });
        }
        if(adminOrderFilterSelect) adminOrderFilterSelect.onchange = () => {
             // Re-fetch or re-filter orders when selection changes.
             // For simplicity, if using onSnapshot for all orders, it will re-render with the new filter.
             // If fetching manually, call loadAdminOrders() or similar.
             // The current onSnapshot approach for all orders means renderAdminOrdersTable will be called,
             // and it internally filters. So, just calling it again is not strictly needed if data hasn't changed,
             // but to ensure UI consistency if the listener isn't perfectly immediate:
             if (typeof loadAdminData === "function") { // Check if loadAdminData is available
                // loadAdminData(); // This re-attaches all listeners, might be too much.
                // A more targeted approach would be to just re-render the table with existing data if cached.
                // For now, the onSnapshot will eventually update.
             }
        };


        async function updateOrderStatus(orderId, status) {
            const orderRef = doc(db, `/artifacts/${appId}/public/data/orders`, orderId);
            try {
                await updateDoc(orderRef, { status: status, updatedAt: Timestamp.now() });
                showToast(`অর্ডার #${orderId.substring(0,6)} স্ট্যাটাস "${translateStatus(status)}" করা হয়েছে।`, "success");
                
                const orderDoc = await getDoc(orderRef);
                if(orderDoc.exists()){
                    const orderData = orderDoc.data();
                     await addNotification(orderData.section, `আপনার অর্ডার #${orderId.substring(0,6)} এর স্ট্যাটাস "${translateStatus(status)}" করা হয়েছে।`);
                }
            } catch (error) {
                console.error("Error updating order status: ", error);
                showToast("অর্ডার স্ট্যাটাস আপডেট করতে সমস্যা হয়েছে।", "error");
            }
        }

        async function markOrderDelivered(order) {
            const orderRef = doc(db, `/artifacts/${appId}/public/data/orders`, order.id);
            try {
                await updateDoc(orderRef, { status: 'delivered', deliveryDate: Timestamp.now(), updatedAt: Timestamp.now() });

                const batch = writeBatch(db);
                order.items.forEach(item => {
                    if (item.quantityDelivered > 0) { 
                        const deliveryRecordRef = doc(collection(db, `/artifacts/${appId}/public/data/deliveryRecords`));
                        batch.set(deliveryRecordRef, {
                            orderId: order.id,
                            productId: item.productId,
                            productName: item.productName,
                            quantityDelivered: item.quantityDelivered,
                            unit: item.unit,
                            section: order.section,
                            deliveredAt: Timestamp.now() 
                        });
                    }
                });
                await batch.commit();
                showToast(`অর্ডার #${order.id.substring(0,6)} ডেলিভার করা হয়েছে এবং রেকর্ড করা হয়েছে।`, "success");
                await addNotification(order.section, `আপনার অর্ডার #${order.id.substring(0,6)} ডেলিভার করা হয়েছে।`);
            } catch (error) {
                console.error("Error marking order delivered: ", error);
                showToast("অর্ডার ডেলিভার করতে সমস্যা হয়েছে।", "error");
            }
        }
        
        async function cancelOrder(order) { 
            const confirmModal = document.getElementById('customConfirmModal');
            const confirmMessage = document.getElementById('customConfirmMessage');
            const confirmYesButton = document.getElementById('customConfirmYes');
            const confirmNoButton = document.getElementById('customConfirmNo');

            confirmMessage.textContent = `আপনি কি অর্ডার #${order.id.substring(0,6)} (${order.section} বিভাগ) সম্পূর্ণ বাতিল করতে চান? বাতিলকৃত পণ্য স্টকে ফেরত যাবে।`;
            confirmModal.classList.remove('hidden');

            confirmYesButton.onclick = async () => {
                confirmModal.classList.add('hidden');
                const orderRef = doc(db, `/artifacts/${appId}/public/data/orders`, order.id);
                try {
                    const batch = writeBatch(db);
                    for (const item of order.items) {
                        const quantityToReturn = item.quantityDelivered > 0 ? item.quantityDelivered : item.quantityOrdered;
                        if (quantityToReturn > 0) {
                            const productRef = doc(db, `/artifacts/${appId}/public/data/products`, item.productId);
                            const productDoc = await getDoc(productRef);
                            if (productDoc.exists()) {
                                const currentStock = productDoc.data().stock;
                                batch.update(productRef, { stock: currentStock + quantityToReturn, updatedAt: Timestamp.now() });
                            }
                        }
                    }
                    batch.update(orderRef, { status: 'cancelled', items: order.items.map(i => ({...i, quantityDelivered: 0})), updatedAt: Timestamp.now() }); 
                    await batch.commit();

                    showToast(`অর্ডার #${order.id.substring(0,6)} বাতিল করা হয়েছে।`, "success");
                    await addNotification(order.section, `আপনার অর্ডার #${order.id.substring(0,6)} অ্যাডমিন দ্বারা বাতিল করা হয়েছে।`);
                } catch (error) {
                    console.error("Error cancelling order: ", error);
                    showToast("অর্ডার বাতিল করতে সমস্যা হয়েছে।", "error");
                }
            };
            confirmNoButton.onclick = () => {
                confirmModal.classList.add('hidden');
            };
        }

        async function handleCancellationRequest(orderId, itemId, approve) { 
            const orderRef = doc(db, `/artifacts/${appId}/public/data/orders`, orderId);
            try {
                const orderDoc = await getDoc(orderRef);
                if (!orderDoc.exists()) {
                    showToast("অর্ডার খুঁজে পাওয়া যায়নি।", "error"); return;
                }
                let orderData = orderDoc.data();
                let itemToCancel = orderData.items.find(item => item.productId === itemId);
                let request = orderData.cancellationRequests.find(req => req.itemId === itemId && req.status === 'pending');

                if (!itemToCancel || !request) {
                    showToast("বাতিলের অনুরোধ বা পণ্য খুঁজে পাওয়া যায়নি।", "error"); return;
                }

                const batch = writeBatch(db);

                if (approve) {
                    const productRef = doc(db, `/artifacts/${appId}/public/data/products`, itemToCancel.productId);
                    const productDocSnap = await getDoc(productRef);
                    if (productDocSnap.exists()) {
                        const currentStock = productDocSnap.data().stock;
                        batch.update(productRef, { stock: currentStock + itemToCancel.quantityOrdered, updatedAt: Timestamp.now() });
                    }
                    itemToCancel.quantityDelivered = 0; 
                    request.status = 'approved';
                    await addNotification(orderData.section, `আপনার অর্ডার #${orderId.substring(0,6)} এ ${itemToCancel.productName} এর বাতিলের অনুরোধ অনুমোদিত হয়েছে।`);
                    showToast(`${itemToCancel.productName} এর বাতিলের অনুরোধ অনুমোদিত।`, "success");
                } else {
                    request.status = 'rejected';
                    await addNotification(orderData.section, `আপনার অর্ডার #${orderId.substring(0,6)} এ ${itemToCancel.productName} এর বাতিলের অনুরোধ বাতিল করা হয়েছে।`); // Should be 'প্রত্যাখ্যান করা হয়েছে'
                    showToast(`${itemToCancel.productName} এর বাতিলের অনুরোধ প্রত্যাখ্যান করা হয়েছে।`, "info");
                }

                const updatedItems = orderData.items.map(i => i.productId === itemId ? itemToCancel : i);
                const updatedRequests = orderData.cancellationRequests.map(r => r.itemId === itemId && r.status === 'pending' ? request : r);
                
                let newOrderStatus = orderData.status;
                const allItemsEffectivelyCancelled = updatedItems.every(i => i.quantityDelivered === 0);
                if (allItemsEffectivelyCancelled) {
                    newOrderStatus = 'cancelled';
                } else if (updatedItems.some(i => i.quantityDelivered < i.quantityOrdered && i.quantityDelivered > 0)) {
                    newOrderStatus = 'partially_delivered'; 
                } else if (updatedItems.some(i => i.quantityDelivered === 0 && i.quantityOrdered > 0)) {
                     newOrderStatus = 'partially_cancelled';
                }

                batch.update(orderRef, { 
                    items: updatedItems, 
                    cancellationRequests: updatedRequests,
                    status: newOrderStatus,
                    updatedAt: Timestamp.now() 
                });
                await batch.commit();

            } catch (error) {
                console.error("Error handling cancellation request: ", error);
                showToast("বাতিলের অনুরোধ প্রক্রিয়া করতে সমস্যা হয়েছে।", "error");
            }
        }


        function renderUserOrdersTable(orders) {
            if (!userOrdersTableBody) return;
            userOrdersTableBody.innerHTML = '';
            orders.filter(order => order.orderByUserId === currentUserId && order.section === currentSection)
                  .forEach(order => {
                const row = userOrdersTableBody.insertRow();
                row.insertCell().textContent = order.id.substring(0, 6);
                row.insertCell().innerHTML = order.items.map(item => 
                    `<div>${item.productName} (অর্ডারকৃত: ${item.quantityOrdered}${item.unit}, ডেলিভারিকৃত: ${item.quantityDelivered}${item.unit})</div>`
                ).join('');
                row.insertCell().textContent = new Date(order.orderDate.seconds * 1000).toLocaleDateString('bn-BD');
                
                const statusCell = row.insertCell();
                const statusBadge = document.createElement('span');
                statusBadge.textContent = translateStatus(order.status);
                statusBadge.classList.add('px-2', 'py-1', 'text-xs', 'font-semibold', 'rounded-full');
                setStatusBadgeColor(statusBadge, order.status);
                statusCell.appendChild(statusBadge);

                order.items.forEach(item => {
                    const request = order.cancellationRequests?.find(r => r.itemId === item.productId);
                    if (request) {
                        const reqStatusSpan = document.createElement('span');
                        reqStatusSpan.classList.add('ml-2', 'text-xs');
                        if (request.status === 'pending') {
                            reqStatusSpan.textContent = `(${item.productName} বাতিলের অনুরোধ অপেক্ষমান)`;
                            reqStatusSpan.classList.add('text-yellow-600');
                        } else if (request.status === 'approved') {
                            reqStatusSpan.textContent = `(${item.productName} বাতিল অনুমোদিত)`;
                            reqStatusSpan.classList.add('text-green-600');
                        } else if (request.status === 'rejected') {
                            reqStatusSpan.textContent = `(${item.productName} বাতিল প্রত্যাখ্যান)`;
                            reqStatusSpan.classList.add('text-red-600');
                        }
                        statusCell.appendChild(document.createElement('br'));
                        statusCell.appendChild(reqStatusSpan);
                    }
                });

                const actionsCell = row.insertCell();
                if (order.status === 'delivered' || order.status === 'partially_delivered' || order.status === 'processing') {
                    order.items.forEach(item => {
                        const existingRequest = order.cancellationRequests?.find(r => r.itemId === item.productId && (r.status === 'pending' || r.status === 'approved'));
                        if (!existingRequest && item.quantityDelivered > 0) { 
                            const requestCancelButton = document.createElement('button');
                            requestCancelButton.textContent = `${item.productName} (${item.quantityDelivered}${item.unit}) বাতিল অনুরোধ`;
                            requestCancelButton.classList.add('bg-yellow-500', 'hover:bg-yellow-700', 'text-black', 'py-1', 'px-2', 'rounded', 'text-sm', 'mt-1', 'block');
                            requestCancelButton.onclick = () => openUserCancelItemModal(order.id, item);
                            actionsCell.appendChild(requestCancelButton);
                        }
                    });
                }
            });
        }

        function openUserCancelItemModal(orderId, item) {
            if (!userCancelItemModal) return;
            userCancelOrderIdInput.value = orderId;
            userCancelItemIdInput.value = item.productId; 
            userCancelItemNameSpan.textContent = `${item.productName} (ডেলিভারিকৃত: ${item.quantityDelivered}${item.unit})`;
            userCancelItemForm.reset(); 
            userCancelItemModal.classList.remove('hidden');
        }
        if(closeUserCancelModalButton) closeUserCancelModalButton.onclick = () => userCancelItemModal.classList.add('hidden');

        async function handleUserSubmitCancelRequest(e) {
            e.preventDefault();
            const orderId = userCancelOrderIdInput.value;
            const itemId = userCancelItemIdInput.value; 
            const reason = userCancelReasonInput.value;

            if (!reason) {
                showToast("অনুগ্রহ করে বাতিলের কারণ লিখুন।", "error");
                return;
            }

            const orderRef = doc(db, `/artifacts/${appId}/public/data/orders`, orderId);
            try {
                const orderDoc = await getDoc(orderRef);
                if (!orderDoc.exists()) {
                    showToast("অর্ডার খুঁজে পাওয়া যায়নি।", "error"); return;
                }
                let orderData = orderDoc.data();
                let itemToRequestCancel = orderData.items.find(i => i.productId === itemId);

                if (!itemToRequestCancel) {
                     showToast("পণ্যটি অর্ডারে খুঁজে পাওয়া যায়নি।", "error"); return;
                }

                let existingRequest = orderData.cancellationRequests?.find(r => r.itemId === itemId && r.status === 'pending');
                if (existingRequest) {
                    showToast("এই পণ্যের জন্য ইতিমধ্যে একটি বাতিলের অনুরোধ করা হয়েছে।", "warning");
                    userCancelItemModal.classList.add('hidden');
                    return;
                }
                
                const newRequest = {
                    itemId: itemId, 
                    requestedByUserId: currentUserId,
                    reason: reason,
                    requestedAt: Timestamp.now(),
                    status: 'pending' 
                };

                const updatedRequests = orderData.cancellationRequests ? [...orderData.cancellationRequests, newRequest] : [newRequest];
                
                await updateDoc(orderRef, {
                    cancellationRequests: updatedRequests,
                    updatedAt: Timestamp.now()
                });

                await addNotification("Admin", `অর্ডার #${orderId.substring(0,6)} এ ${itemToRequestCancel.productName} এর জন্য একটি বাতিলের অনুরোধ এসেছে। কারণ: ${reason}`);
                showToast("বাতিলের অনুরোধ সফলভাবে জমা দেওয়া হয়েছে!", "success");
                userCancelItemModal.classList.add('hidden');
            } catch (error) {
                console.error("Error submitting cancellation request: ", error);
                showToast("বাতিলের অনুরোধ জমা দিতে সমস্যা হয়েছে।", "error");
            }
        }
        if(userCancelItemForm) userCancelItemForm.addEventListener('submit', handleUserSubmitCancelRequest);


        // LOW STOCK (Admin)
        function renderLowStockTable(lowStockProducts) {
            if (!lowStockTableBody) return;
            lowStockTableBody.innerHTML = '';
            lowStockProducts.forEach(product => {
                if (product.stock < product.lowStockAlertThreshold && !product.isLowStockAlertIgnored) {
                    const row = lowStockTableBody.insertRow();
                    row.insertCell().textContent = product.name;
                    row.insertCell().textContent = `${product.stock} ${product.unit}`;
                    row.insertCell().textContent = product.lowStockAlertThreshold;
                    row.classList.add('bg-red-100', 'text-red-700');

                    const actionsCell = row.insertCell();
                    const ignoreButton = document.createElement('button');
                    ignoreButton.textContent = 'এলার্ট উপেক্ষা করুন';
                    ignoreButton.classList.add('bg-yellow-500', 'hover:bg-yellow-700', 'text-black', 'py-1', 'px-2', 'rounded', 'text-sm');
                    ignoreButton.onclick = () => ignoreLowStockAlert(product.id, true);
                    actionsCell.appendChild(ignoreButton);
                }
            });
        }
        
        async function ignoreLowStockAlert(productId, ignore) {
            const productRef = doc(db, `/artifacts/${appId}/public/data/products`, productId);
            try {
                await updateDoc(productRef, { 
                    isLowStockAlertIgnored: ignore,
                    updatedAt: Timestamp.now()
                });
                showToast(`পণ্যের লো স্টক অ্যালার্ট ${ignore ? 'উপেক্ষা করা হয়েছে' : 'পুনরায় সক্রিয় করা হয়েছে'}।`, "info");
            } catch (error) {
                console.error("Error updating low stock alert ignore status:", error);
                showToast("লো স্টক অ্যালার্ট স্ট্যাটাস আপডেট করতে সমস্যা হয়েছে।", "error");
            }
        }

        // NOTIFICATIONS (Admin & User)
        async function addNotification(target, message) { 
            try {
                const notificationsRef = collection(db, `/artifacts/${appId}/public/data/notifications`);
                await addDoc(notificationsRef, {
                    target: target, 
                    message: message,
                    isRead: false,
                    timestamp: Timestamp.now()
                });
            } catch (error) {
                console.error("Error adding notification: ", error);
            }
        }

        function renderNotifications(listElement, notifications) {
            if (!listElement) return;
            listElement.innerHTML = '';
            if (notifications.length === 0) {
                listElement.innerHTML = '<li class="text-gray-500">কোনো নতুন নোটিফিকেশন নেই।</li>';
                return;
            }
            notifications.forEach(notif => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="p-3 rounded-lg ${notif.isRead ? 'bg-gray-100' : 'bg-blue-50 shadow-md'}">
                        <p class="${notif.isRead ? 'text-gray-600' : 'text-blue-700 font-semibold'}">${notif.message}</p>
                        <small class="text-gray-500">${new Date(notif.timestamp.seconds * 1000).toLocaleString('bn-BD')}</small>
                        ${!notif.isRead ? '<button data-id="'+notif.id+'" class="mark-as-read-btn ml-2 text-xs text-blue-500 hover:underline">পঠিত হিসাবে চিহ্নিত করুন</button>' : ''}
                    </div>`;
                listElement.appendChild(li);
            });
            
            listElement.querySelectorAll('.mark-as-read-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const notifId = e.target.dataset.id;
                    markNotificationAsRead(notifId);
                });
            });
        }
        
        async function markNotificationAsRead(notificationId) {
            const notifRef = doc(db, `/artifacts/${appId}/public/data/notifications`, notificationId);
            try {
                await updateDoc(notifRef, { isRead: true });
            } catch (error) {
                console.error("Error marking notification as read:", error);
            }
        }

        // USER Shopping Cart
        function renderUserProducts(products) {
            if (!userProductsListDiv) return;
            userProductsListDiv.innerHTML = '';
            products.filter(p => p.stock > 0) 
                    .forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('p-4', 'border', 'rounded-lg', 'shadow', 'bg-white');
                productCard.innerHTML = `
                    <h3 class="text-lg font-semibold">${product.name}</h3>
                    <p class="text-sm text-gray-600">ক্যাটাগরি: ${product.category}</p>
                    <p class="text-sm text-gray-600">স্টক: ${product.stock.toFixed(product.unit === 'kg' ? 2 : 0)} ${product.unit}</p>
                    <div class="mt-2">
                        <input type="number" min="0" ${product.unit === 'kg' ? 'step="0.1"' : 'step="1"'} placeholder="পরিমাণ" class="w-full p-1 border rounded product-quantity-input" data-product-id="${product.id}">
                        <button class="add-to-cart-btn mt-2 w-full bg-green-500 hover:bg-green-700 text-white py-1 px-3 rounded text-sm" data-product-id="${product.id}">কার্টে যোগ করুন</button>
                    </div>
                `;
                userProductsListDiv.appendChild(productCard);
            });

            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    const quantityInput = document.querySelector(`.product-quantity-input[data-product-id="${productId}"]`);
                    const quantity = parseFloat(quantityInput.value);
                    const product = productsCache.find(p => p.id === productId);

                    if (product && quantity > 0) {
                        if (quantity > product.stock) {
                            showToast(`"${product.name}" এর জন্য পর্যাপ্ত স্টক নেই। সর্বোচ্চ ${product.stock} ${product.unit} অর্ডার করা যাবে।`, "error");
                            return;
                        }
                        addToCart(product, quantity);
                        quantityInput.value = ''; 
                    } else {
                        showToast("অনুগ্রহ করে সঠিক পরিমাণ লিখুন।", "error");
                    }
                });
            });
        }

        function addToCart(product, quantity) {
            const existingItem = shoppingCart.find(item => item.productId === product.id);
            if (existingItem) {
                if (existingItem.quantity + quantity > product.stock) {
                     showToast(`"${product.name}" এর জন্য পর্যাপ্ত স্টক নেই। কার্টে ইতিমধ্যে ${existingItem.quantity} ${product.unit} আছে।`, "error");
                     return;
                }
                existingItem.quantity += quantity;
            } else {
                shoppingCart.push({
                    productId: product.id,
                    name: product.name,
                    quantity: quantity,
                    unit: product.unit,
                    stock: product.stock 
                });
            }
            renderShoppingCart();
            showToast(`${quantity} ${product.unit} "${product.name}" কার্টে যোগ করা হয়েছে।`, "success");
        }

        function removeFromCart(productId) {
            shoppingCart = shoppingCart.filter(item => item.productId !== productId);
            renderShoppingCart();
        }
        
        function updateCartQuantity(productId, newQuantity) {
            const item = shoppingCart.find(item => item.productId === productId);
            const product = productsCache.find(p => p.id === productId);
            if (item && product) {
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else if (newQuantity > product.stock) {
                    showToast(`"${product.name}" এর জন্য পর্যাপ্ত স্টক নেই। সর্বোচ্চ ${product.stock} ${product.unit} অর্ডার করা যাবে।`, "error");
                    const inputElement = userShoppingCartDiv.querySelector(`input[data-product-id="${productId}"]`);
                    if(inputElement) inputElement.value = product.stock;
                    item.quantity = product.stock; 
                }
                 else {
                    item.quantity = newQuantity;
                }
            }
            renderShoppingCart();
        }


        function renderShoppingCart() {
            if (!userShoppingCartDiv) return;
            userShoppingCartDiv.innerHTML = '';
            if (shoppingCart.length === 0) {
                userShoppingCartDiv.innerHTML = '<p class="text-gray-500">আপনার শপিং কার্ট এখন খালি।</p>';
                placeOrderButton.classList.add('hidden');
                return;
            }
            
            placeOrderButton.classList.remove('hidden');
            const ul = document.createElement('ul');
            ul.classList.add('space-y-2');
            shoppingCart.forEach(item => {
                const li = document.createElement('li');
                li.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'border-b');
                li.innerHTML = `
                    <div>
                        <span class="font-semibold">${item.name}</span>
                        <input type="number" value="${item.quantity}" min="0" ${item.unit === 'kg' ? 'step="0.1"' : 'step="1"'} 
                               data-product-id="${item.productId}" 
                               class="cart-item-quantity-input ml-2 w-20 p-1 border rounded text-sm">
                        <span>${item.unit}</span>
                    </div>
                    <button class="remove-from-cart-btn text-red-500 hover:text-red-700 text-sm" data-product-id="${item.productId}">মুছে ফেলুন</button>
                `;
                ul.appendChild(li);
            });
            userShoppingCartDiv.appendChild(ul);

            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => removeFromCart(e.target.dataset.productId));
            });
            document.querySelectorAll('.cart-item-quantity-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const productId = e.target.dataset.productId;
                    const newQuantity = parseFloat(e.target.value);
                    updateCartQuantity(productId, newQuantity);
                });
            });
        }
        
        // REPORTS (Admin)
        function populateMonthFilter() {
            if (!reportMonthSelect) return;
            reportMonthSelect.innerHTML = ''; 
            const currentMonth = new Date().getMonth(); 
            const currentYear = new Date().getFullYear();

            for (let i = 0; i < 6; i++) { 
                const date = new Date(currentYear, currentMonth - i, 1);
                const monthYearValue = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; 
                const monthYearText = date.toLocaleDateString('bn-BD', { year: 'numeric', month: 'long' });
                
                const option = document.createElement('option');
                option.value = monthYearValue;
                option.textContent = monthYearText;
                reportMonthSelect.appendChild(option);
            }
            if (reportMonthSelect.options.length > 0) {
                 loadDeliveryReports(reportMonthSelect.value);
            }
        }
        
        if (reportMonthSelect) reportMonthSelect.onchange = (e) => loadDeliveryReports(e.target.value);

        async function loadDeliveryReports(selectedMonthYear) { 
            if (!deliveryReportTableBody) return;
            deliveryReportTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">রিপোর্ট লোড হচ্ছে...</td></tr>';

            if (!selectedMonthYear) {
                deliveryReportTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">রিপোর্টের জন্য মাস নির্বাচন করুন।</td></tr>';
                return;
            }

            const [year, month] = selectedMonthYear.split('-').map(Number);
            let startDate = new Date(year, month - 2, 20, 0, 0, 0, 0); 
            let endDate = new Date(year, month - 1, 20, 23, 59, 59, 999);
            
            const q = query(
                collection(db, `/artifacts/${appId}/public/data/deliveryRecords`),
                where("deliveredAt", ">=", Timestamp.fromDate(startDate)),
                where("deliveredAt", "<=", Timestamp.fromDate(endDate))
            );

            try {
                const querySnapshot = await getDocs(q);
                const records = [];
                querySnapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                records.sort((a, b) => b.deliveredAt.seconds - a.deliveredAt.seconds);
                renderDeliveryReportTable(records);
            } catch (error) {
                console.error("Error loading delivery reports: ", error);
                showToast("ডেলিভারি রিপোর্ট লোড করতে সমস্যা হয়েছে।", "error");
                deliveryReportTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">রিপোর্ট লোড করতে ব্যর্থ।</td></tr>';
            }
        }
        
        function renderDeliveryReportTable(records) {
            if (!deliveryReportTableBody) return;
            deliveryReportTableBody.innerHTML = '';

            if (records.length === 0) {
                deliveryReportTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">এই মাসের জন্য কোনো ডেলিভারি রেকর্ড নেই।</td></tr>';
                return;
            }
            
            const aggregatedData = {};
            records.forEach(record => {
                const key = `${record.section}-${record.productId}`;
                if (!aggregatedData[key]) {
                    aggregatedData[key] = {
                        section: record.section,
                        productName: record.productName,
                        unit: record.unit,
                        totalQuantity: 0
                    };
                }
                aggregatedData[key].totalQuantity += record.quantityDelivered;
            });

            Object.values(aggregatedData).forEach(item => {
                const row = deliveryReportTableBody.insertRow();
                row.insertCell().textContent = item.section;
                row.insertCell().textContent = item.productName;
                row.insertCell().textContent = `${item.totalQuantity.toFixed(item.unit === 'kg' ? 2 : 0)} ${item.unit}`;
            });
        }
        
        async function cleanupOldDeliveryRecords() {
            const confirmModal = document.getElementById('customConfirmModal');
            const confirmMessage = document.getElementById('customConfirmMessage');
            const confirmYesButton = document.getElementById('customConfirmYes');
            const confirmNoButton = document.getElementById('customConfirmNo');

            confirmMessage.textContent = `আপনি কি ৩ মাসের বেশি পুরনো সকল ডেলিভারি রেকর্ড মুছে ফেলতে চান? এই কাজটি ফেরানো যাবে না।`;
            confirmModal.classList.remove('hidden');
            
            confirmYesButton.onclick = async () => {
                confirmModal.classList.add('hidden');
                showView('loadingView'); 

                const threeMonthsAgo = new Date();
                let cutoffDate = new Date();
                cutoffDate.setMonth(cutoffDate.getMonth() - 3); 
                const currentDay = new Date().getDate();
                let targetMonth = new Date().getMonth(); 
                let targetYear = new Date().getFullYear();

                if (currentDay < 20) { 
                    targetMonth -= 1;
                    if (targetMonth < 0) {
                        targetMonth = 11;
                        targetYear -=1;
                    }
                }
                cutoffDate = new Date(targetYear, targetMonth - 3, 20, 0, 0, 0, 0);

                const q = query(
                    collection(db, `/artifacts/${appId}/public/data/deliveryRecords`),
                    where("deliveredAt", "<", Timestamp.fromDate(cutoffDate))
                );

                try {
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) {
                        showToast("কোনো পুরনো ডেলিভারি রেকর্ড (৩ মাসের বেশি) পাওয়া যায়নি।", "info");
                        if (currentUser && currentUser.email) showAdminSection('adminReportsSection');
                        else showView('loginView');
                        return;
                    }
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showToast(`${snapshot.size} টি পুরনো ডেলিভারি রেকর্ড সফলভাবে মুছে ফেলা হয়েছে।`, "success");
                    loadDeliveryReports(reportMonthSelect.value); 
                } catch (error) {
                    console.error("Error cleaning up old records: ", error);
                    showToast("পুরনো রেকর্ড মুছতে সমস্যা হয়েছে।", "error");
                } finally {
                     if (currentUser && currentUser.email) showAdminSection('adminReportsSection');
                     else showView('loginView'); 
                }
            };
            confirmNoButton.onclick = () => {
                confirmModal.classList.add('hidden');
            };
        }
        if(cleanupOldRecordsButton) cleanupOldRecordsButton.addEventListener('click', cleanupOldDeliveryRecords);


        // --- Helper Functions for UI ---
        function translateStatus(status) {
            const translations = {
                pending: "অপেক্ষমান",
                processing: "প্রসেসিং",
                delivered: "ডেলিভার সম্পন্ন",
                cancelled: "বাতিল",
                partially_cancelled: "আংশিক বাতিল",
                partially_delivered: "আংশিক ডেলিভার" 
            };
            return translations[status] || status;
        }

        function setStatusBadgeColor(element, status) {
            element.classList.remove('bg-yellow-200', 'text-yellow-800', 'bg-blue-200', 'text-blue-800', 'bg-green-200', 'text-green-800', 'bg-red-200', 'text-red-800', 'bg-purple-200', 'text-purple-800');
            switch (status) {
                case 'pending':
                    element.classList.add('bg-yellow-200', 'text-yellow-800');
                    break;
                case 'processing':
                    element.classList.add('bg-blue-200', 'text-blue-800');
                    break;
                case 'delivered':
                    element.classList.add('bg-green-200', 'text-green-800');
                    break;
                case 'cancelled':
                    element.classList.add('bg-red-200', 'text-red-800');
                    break;
                case 'partially_cancelled':
                case 'partially_delivered':
                    element.classList.add('bg-purple-200', 'text-purple-800');
                    break;
                default:
                    element.classList.add('bg-gray-200', 'text-gray-800');
            }
        }


        // --- Data Loading and Listeners ---
        function cleanupListeners() {
            if (unsubscribeProductsListener) unsubscribeProductsListener();
            if (unsubscribeOrdersListener) unsubscribeOrdersListener();
            if (unsubscribeNotificationsListener) unsubscribeNotificationsListener();
            if (unsubscribeLowStockListener) unsubscribeLowStockListener(); 
            if (unsubscribeDeliveryRecordsListener) unsubscribeDeliveryRecordsListener(); 
            
            unsubscribeProductsListener = null;
            unsubscribeOrdersListener = null;
            unsubscribeNotificationsListener = null;
            unsubscribeLowStockListener = null;
            unsubscribeDeliveryRecordsListener = null;
        }
        
        async function loadAdminData() {
            cleanupListeners(); 

            const productsQuery = query(collection(db, `/artifacts/${appId}/public/data/products`), orderBy("name"));
            unsubscribeProductsListener = onSnapshot(productsQuery, (snapshot) => {
                const products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                productsCache = products; 
                renderProductsTable(products); 
                renderLowStockTable(products); 
                if (currentSection && userProductsListDiv) { 
                    renderUserProducts(products); 
                }
            }, (error) => {
                console.error("Error fetching products: ", error);
                showToast("পণ্য লোড করতে সমস্যা হয়েছে।", "error");
            });

            const ordersQuery = query(collection(db, `/artifacts/${appId}/public/data/orders`), orderBy("orderDate", "desc"));
            unsubscribeOrdersListener = onSnapshot(ordersQuery, (snapshot) => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminOrdersTable(orders);
            }, (error) => {
                console.error("Error fetching admin orders: ", error);
                showToast("অর্ডার লোড করতে সমস্যা হয়েছে।", "error");
            });
            
            const adminNotificationsQuery = query(
                collection(db, `/artifacts/${appId}/public/data/notifications`), 
                where("target", "==", "Admin"), 
                orderBy("timestamp", "desc"),
                limit(20) 
            );
            unsubscribeNotificationsListener = onSnapshot(adminNotificationsQuery, (snapshot) => {
                const notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNotifications(adminNotificationsList, notifications);
            }, (error) => {
                console.error("Error fetching admin notifications: ", error);
            });

            populateMonthFilter();
        }

        async function loadUserData() {
            cleanupListeners();

            const productsQuery = query(collection(db, `/artifacts/${appId}/public/data/products`), orderBy("name"));
            unsubscribeProductsListener = onSnapshot(productsQuery, (snapshot) => {
                productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserProducts(productsCache); 
                renderShoppingCart(); 
            }, (error) => {
                console.error("Error fetching products for user: ", error);
                showToast("পণ্য লোড করতে সমস্যা হয়েছে।", "error");
            });

            const userOrdersQuery = query(
                collection(db, `/artifacts/${appId}/public/data/orders`), 
                where("orderByUserId", "==", currentUserId), 
                where("section", "==", currentSection),      
                orderBy("orderDate", "desc")
            );
            unsubscribeOrdersListener = onSnapshot(userOrdersQuery, (snapshot) => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserOrdersTable(orders);
            }, (error) => {
                console.error("Error fetching user orders: ", error);
                showToast("আপনার অর্ডারগুলো লোড করতে সমস্যা হয়েছে।", "error");
            });
            
            const userNotificationsQuery = query(
                collection(db, `/artifacts/${appId}/public/data/notifications`), 
                where("target", "==", currentSection), 
                orderBy("timestamp", "desc"),
                limit(20)
            );
            unsubscribeNotificationsListener = onSnapshot(userNotificationsQuery, (snapshot) => {
                const notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNotifications(userNotificationsList, notifications);
            }, (error) => {
                console.error("Error fetching user notifications: ", error);
            });
        }

        // --- Initial Setup ---
        adminNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionName = e.target.closest('a').dataset.section;
                showAdminSection(sectionName);
                if (sectionName === 'adminReportsSection') { 
                    loadDeliveryReports(reportMonthSelect.value);
                }
            });
        });
        
        userNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionName = e.target.closest('a').dataset.section;
                showUserSection(sectionName);
            });
        });

        window.onclick = function(event) {
            if (event.target == restockModal) {
                restockModal.classList.add('hidden');
            }
            if (event.target == userCancelItemModal) {
                userCancelItemModal.classList.add('hidden');
            }
            const confirmModal = document.getElementById('customConfirmModal');
            if (event.target == confirmModal) {
                confirmModal.classList.add('hidden');
            }
        }
        showView('loadingView'); 
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .admin-nav-link.active { background-color: #2563eb; color: white; } 
        .user-nav-link.active { background-color: #059669; color: white; } 

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fadeInOut {
            animation: fadeInOut 3s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loadingView" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold text-gray-700">লোড হচ্ছে...</p>
        </div>
    </div>

    <div id="toastNotification" class="fixed top-5 right-5 p-4 rounded-md text-white shadow-lg hidden z-50 max-w-sm">
        <p id="toastMessage">Toast message goes here.</p>
    </div>

    <div id="customConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">নিশ্চিত করুন</h3>
            <p id="customConfirmMessage" class="mb-6 text-gray-700">আপনি কি নিশ্চিত?</p>
            <div class="flex justify-end space-x-3">
                <button id="customConfirmNo" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">না</button>
                <button id="customConfirmYes" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">হ্যাঁ</button>
            </div>
        </div>
    </div>


    <div id="loginView" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">গুডাউন ম্যানেজমেন্ট সিস্টেম</h1>
            
            <div class="mb-10">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">অ্যাডমিন লগইন</h2>
                <form id="adminLoginForm" class="space-y-4">
                    <div>
                        <label for="adminEmail" class="block text-sm font-medium text-gray-600">ইমেইল</label>
                        <input type="email" id="adminEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="admin@example.com">
                    </div>
                    <div>
                        <label for="adminPassword" class="block text-sm font-medium text-gray-600">পাসওয়ার্ড</label>
                        <input type="password" id="adminPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="********">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">অ্যাডমিন লগইন</button>
                </form>
            </div>

            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">ইউজার লগইন</h2>
                <form id="userLoginForm" class="space-y-4">
                    <div>
                        <label for="userPasscode" class="block text-sm font-medium text-gray-600">পাসকোড</label>
                        <input type="password" id="userPasscode" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="বিভাগের পাসকোড">
                        <p class="mt-1 text-xs text-gray-500">কিচেন: KhamerK, পুরুষ: KhamerM, ফ্যামিলি: KhamerF</p>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">ইউজার লগইন</button>
                </form>
            </div>
        </div>
    </div>

    <div id="adminDashboardView" class="hidden">
        <div class="min-h-screen flex">
            <div class="w-64 bg-blue-800 text-blue-100 p-6 space-y-6">
                <h1 class="text-2xl font-semibold text-white border-b border-blue-700 pb-4">অ্যাডমিন প্যানেল</h1>
                <nav class="space-y-2">
                    <a href="#" data-section="adminProductsSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white">পণ্যসমূহ</a>
                    <a href="#" data-section="adminOrdersSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white">অর্ডারসমূহ</a>
                    <a href="#" data-section="adminRestockSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white">রিস্টক লগ (শীঘ্রই আসছে)</a>
                    <a href="#" data-section="adminLowStockSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white">লো স্টক অ্যালার্ট</a>
                    <a href="#" data-section="adminReportsSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white">রিপোর্ট</a>
                    <a href="#" data-section="adminNotificationsSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white">নোটিফিকেশন</a>
                </nav>
                <button id="adminLogoutButton" class="w-full mt-auto py-2 px-4 bg-red-600 hover:bg-red-700 rounded text-white font-medium transition duration-200">লগ আউট</button>
            </div>

            <div class="flex-1 p-10 bg-gray-50">
                <section id="adminProductsSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">পণ্য ব্যবস্থাপনা</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">নতুন পণ্য যোগ করুন</h3>
                        <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="productName" class="block text-sm font-medium text-gray-600">পণ্যের নাম</label>
                                <input type="text" id="productName" required class="mt-1 input-field">
                            </div>
                            <div>
                                <label for="productQuantity" class="block text-sm font-medium text-gray-600">পরিমাণ</label>
                                <input type="number" id="productQuantity" step="any" required class="mt-1 input-field">
                            </div>
                            <div>
                                <label for="productUnit" class="block text-sm font-medium text-gray-600">একক</label>
                                <select id="productUnit" class="mt-1 input-field">
                                    <option value="pieces">পিস</option>
                                    <option value="kg">কেজি</option>
                                    <option value="litre">লিটার</option>
                                    <option value="dozen">ডজন</option>
                                    <option value="packet">প্যাকেট</option>
                                </select>
                            </div>
                            <div>
                                <label for="productCategory" class="block text-sm font-medium text-gray-600">ক্যাটাগরি</label>
                                <input type="text" id="productCategory" required class="mt-1 input-field" placeholder="যেমন: চাল, ডাল, সাবান">
                            </div>
                            <div>
                                <label for="lowStockAlert" class="block text-sm font-medium text-gray-600">লো স্টক অ্যালার্ট সংখ্যা</label>
                                <input type="number" id="lowStockAlert" required class="mt-1 input-field">
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="w-full btn-primary">পণ্য যোগ করুন</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">সকল পণ্য</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="th-cell">নাম</th>
                                        <th class="th-cell">স্টক</th>
                                        <th class="th-cell">ক্যাটাগরি</th>
                                        <th class="th-cell">লো স্টক থ্রেশহোল্ড</th>
                                        <th class="th-cell">কার্যক্রম</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="adminOrdersSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">অর্ডারসমূহ</h2>
                     <div class="mb-4">
                        <label for="adminOrderFilter" class="mr-2 font-medium">ফিল্টার করুন:</label>
                        <select id="adminOrderFilter" class="p-2 border rounded-md">
                            <option value="all">সকল বিভাগ</option>
                            <option value="Kitchen">কিচেন</option>
                            <option value="Men">পুরুষ</option>
                            <option value="Family">ফ্যামিলি</option>
                        </select>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="th-cell">অর্ডার আইডি</th>
                                    <th class="th-cell">বিভাগ</th>
                                    <th class="th-cell">পণ্যসমূহ</th>
                                    <th class="th-cell">অর্ডারের তারিখ</th>
                                    <th class="th-cell">স্ট্যাটাস</th>
                                    <th class="th-cell">কার্যক্রম</th>
                                </tr>
                            </thead>
                            <tbody id="adminOrdersTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <section id="adminRestockSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">রিস্টক লগ</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <p class="text-gray-600">এই ফিচারটি শীঘ্রই আসছে...</p>
                    </div>
                </section>

                <section id="adminLowStockSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">লো স্টক অ্যালার্ট</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                         <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-red-50">
                                <tr>
                                    <th class="th-cell text-red-700">পণ্যের নাম</th>
                                    <th class="th-cell text-red-700">বর্তমান স্টক</th>
                                    <th class="th-cell text-red-700">লো স্টক থ্রেশহোল্ড</th>
                                    <th class="th-cell text-red-700">কার্যক্রম</th>
                                </tr>
                            </thead>
                            <tbody id="lowStockTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </section>

                <section id="adminReportsSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">ডেলিভারি রিপোর্ট</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <label for="reportMonthSelect" class="mr-2 font-medium">মাস নির্বাচন করুন (২০ তারিখ থেকে ২০ তারিখ):</label>
                                <select id="reportMonthSelect" class="p-2 border rounded-md"></select>
                            </div>
                            <button id="cleanupOldRecordsButton" class="btn-danger">৩ মাসের পুরনো রেকর্ড মুছুন</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="th-cell">বিভাগ</th>
                                        <th class="th-cell">পণ্যের নাম</th>
                                        <th class="th-cell">মোট ডেলিভারিকৃত পরিমাণ</th>
                                    </tr>
                                </thead>
                                <tbody id="deliveryReportTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <section id="adminNotificationsSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">নোটিফিকেশন</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <ul id="adminNotificationsList" class="space-y-3">
                        </ul>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="userDashboardView" class="hidden">
        <div class="min-h-screen flex">
            <div class="w-64 bg-green-800 text-green-100 p-6 space-y-6">
                <h1 id="userSectionTitle" class="text-2xl font-semibold text-white border-b border-green-700 pb-4">ইউজার প্যানেল</h1>
                <nav class="space-y-2">
                    <a href="#" data-section="userPlaceOrderSection" class="user-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-green-700 hover:text-white">অর্ডার করুন</a>
                    <a href="#" data-section="userMyOrdersSection" class="user-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-green-700 hover:text-white">আমার অর্ডারসমূহ</a>
                    <a href="#" data-section="userNotificationsSection" class="user-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-green-700 hover:text-white">নোটিফিকেশন</a>
                </nav>
                <button id="userLogoutButton" class="w-full mt-auto py-2 px-4 bg-red-600 hover:bg-red-700 rounded text-white font-medium transition duration-200">লগ আউট</button>
            </div>

            <div class="flex-1 p-10 bg-gray-50">
                <section id="userPlaceOrderSection" class="user-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">পণ্য অর্ডার করুন</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">উপলব্ধ পণ্যসমূহ</h3>
                            <div id="userProductsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto p-2">
                            </div>
                        </div>
                        <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">শপিং কার্ট</h3>
                            <div id="userShoppingCart" class="mb-4 max-h-[50vh] overflow-y-auto p-1">
                            </div>
                            <button id="placeOrderButton" class="w-full btn-primary hidden">অর্ডার প্লেস করুন</button>
                        </div>
                    </div>
                </section>

                <section id="userMyOrdersSection" class="user-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">আমার অর্ডারসমূহ</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="th-cell">অর্ডার আইডি</th>
                                    <th class="th-cell">পণ্যসমূহ</th>
                                    <th class="th-cell">অর্ডারের তারিখ</th>
                                    <th class="th-cell">স্ট্যাটাস</th>
                                    <th class="th-cell">কার্যক্রম</th>
                                </tr>
                            </thead>
                            <tbody id="userOrdersTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <section id="userNotificationsSection" class="user-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">নোটিফিকেশন</h2>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <ul id="userNotificationsList" class="space-y-3">
                        </ul>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="restockModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-30 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-6">পণ্য রিস্টক করুন: <span id="restockProductNameSpan" class="text-blue-600"></span></h3>
            <p class="mb-2 text-sm">বর্তমান স্টক: <span id="currentStockSpan" class="font-semibold"></span></p>
            <form id="restockForm" class="space-y-4">
                <input type="hidden" id="restockProductId">
                <div>
                    <label for="restockQuantity" class="block text-sm font-medium text-gray-700">নতুন যোগকৃত পরিমাণ</label>
                    <input type="number" id="restockQuantity" step="any" min="0" class="mt-1 input-field" placeholder="0">
                </div>
                <div>
                    <label for="damagedQuantity" class="block text-sm font-medium text-gray-700">ক্ষতিগ্রস্ত/ফেরতকৃত পরিমাণ (স্টক থেকে বাদ যাবে)</label>
                    <input type="number" id="damagedQuantity" step="any" min="0" class="mt-1 input-field" placeholder="0">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="closeRestockModalButton" class="btn-secondary">বন্ধ করুন</button>
                    <button type="submit" class="btn-primary">রিস্টক সম্পন্ন করুন</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="userCancelItemModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-30 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-6">পণ্যের ডেলিভারি বাতিলের অনুরোধ: <span id="userCancelItemNameSpan" class="text-green-600"></span></h3>
            <form id="userCancelItemForm" class="space-y-4">
                <input type="hidden" id="userCancelOrderId">
                <input type="hidden" id="userCancelItemId">
                <div>
                    <label for="userCancelReason" class="block text-sm font-medium text-gray-700">বাতিলের কারণ (যেমন: পণ্য কম পেয়েছি / পাইনি)</label>
                    <textarea id="userCancelReason" rows="3" required class="mt-1 input-field" placeholder="বিস্তারিত লিখুন..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="closeUserCancelModalButton" class="btn-secondary">বন্ধ করুন</button>
                    <button type="submit" class="btn-warning">অনুরোধ জমা দিন</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .input-field {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #D1D5DB; 
            border-radius: 0.375rem; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
        }
        .input-field:focus {
            outline: none;
            border-color: #3B82F6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); 
        }
        .btn-primary {
            padding: 0.5rem 1rem;
            background-color: #2563EB; 
            color: white;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1D4ED8; 
        }
        .btn-secondary {
            padding: 0.5rem 1rem;
            background-color: #D1D5DB; 
            color: #1F2937; 
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #9CA3AF; 
        }
        .btn-danger {
            padding: 0.5rem 1rem;
            background-color: #DC2626; 
            color: white;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #B91C1C; 
        }
         .btn-warning {
            padding: 0.5rem 1rem;
            background-color: #F59E0B; 
            color: white;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-warning:hover {
            background-color: #D97706; 
        }
        .th-cell {
            padding: 0.75rem 1rem; 
            text-align: left;
            font-size: 0.75rem; 
            font-weight: 600; 
            color: #4B5563; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>
</body>
</html>