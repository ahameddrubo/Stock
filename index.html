<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>গুদাম ম্যানেজমেন্ট সিস্টেম</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            getDocs, 
            onSnapshot, 
            query, 
            where, 
            serverTimestamp, 
            updateDoc,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Updated Firebase Configuration
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCa_bwrAn7_QImUbnrqj0wSHrWqspFiNBE",
            authDomain: "stock-mantain-d6427.firebaseapp.com",
            projectId: "stock-mantain-d6427",
            storageBucket: "stock-mantain-d6427.firebasestorage.app",
            messagingSenderId: "150865127526",
            appId: "1:150865127526:web:bb39866ca4acd9fbbb25a7",
            measurementId: "G-1P1LMBLZ88"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId; // Use appId from config if __app_id is not available
        
        let currentUserId = null;
        let currentPasscode = null; 
        let currentSector = null;   
        let isAdmin = false;
        let cart = [];
        let products = []; 
        let unsubscribeOrders = null; 
        let unsubscribeProducts = null;

        const loginForms = document.getElementById('loginForms');
        const userPasscodeLogin = document.getElementById('userPasscodeLogin');
        const adminEmailLogin = document.getElementById('adminEmailLogin');
        
        const userSection = document.getElementById('userSection');
        const adminSection = document.getElementById('adminSection');
        const productListDiv = document.getElementById('productList');
        const cartItemsDiv = document.getElementById('cartItems');
        const cartTotalSpan = document.getElementById('cartTotal');
        const adminOrdersDiv = document.getElementById('adminOrders');
        
        const passcodeEntry = document.getElementById('passcodeEntry');
        const userLoginButton = document.getElementById('userLoginButton');
        const adminEmailEntry = document.getElementById('adminEmailEntry');
        const adminPasswordEntry = document.getElementById('adminPasswordEntry');
        const adminLoginButton = document.getElementById('adminLoginButton');

        const logoutButton = document.getElementById('logoutButton');
        const placeOrderButton = document.getElementById('placeOrderButton');
        const messageDiv = document.getElementById('messageDiv');
        const currentViewSpan = document.getElementById('currentViewSpan');
        const adminSectorFilter = document.getElementById('adminSectorFilter');
        
        const loadingIndicator = document.getElementById('loadingIndicator'); 
        const adminLoadingIndicator = document.getElementById('adminLoadingIndicator'); 
        const productLoadingIndicator = document.getElementById('productLoadingIndicator'); 
        
        const orderSuccessModal = document.getElementById('orderSuccessModal');
        const closeOrderSuccessModalButton = document.getElementById('closeOrderSuccessModalButton');
        const orderSuccessMessage = document.getElementById('orderSuccessMessage');

        const addProductForm = document.getElementById('addProductForm');
        const productNameInput = document.getElementById('productName');
        const productDescriptionInput = document.getElementById('productDescription');
        const productPriceInput = document.getElementById('productPrice');
        const productCategoryInput = document.getElementById('productCategory');
        const productImageUrlInput = document.getElementById('productImageUrl');
        const addProductButton = document.getElementById('addProductButton');
        const addProductLoadingIndicator = document.getElementById('addProductLoadingIndicator');

        // --- Authentication and Initialization ---
        async function initializeAppSession() {
            onAuthStateChanged(auth, authStateChangedHandler); 

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) {
                    console.error("Error with custom token sign-in:", error);
                    if (!auth.currentUser) { 
                        await signInAnonymouslyIfNeeded();
                    }
                }
            } else {
                 await signInAnonymouslyIfNeeded();
            }
        }

        async function signInAnonymouslyIfNeeded() {
            if (!auth.currentUser) {
                try {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously for initial session.");
                } catch (error) {
                     console.error("Error during anonymous sign-in:", error);
                     showMessage('প্রাথমিক সেশনে সমস্যা হয়েছে। পৃষ্ঠা রিলোড করুন।', 'error', 0); // 0 for indefinite
                }
            }
        }
        
        async function authStateChangedHandler(user) {
            loadingIndicator.classList.remove('hidden'); // Show general loading while auth state resolves

            if (user) {
                currentUserId = user.uid;
                console.log("Auth State: UID:", currentUserId, "Anonymous:", user.isAnonymous, "Email:", user.email);
                isAdmin = false; 

                if (!user.isAnonymous && user.email) { 
                    const adminUserRef = doc(db, `artifacts/${appId}/public/data/admin_users`, user.uid);
                    try {
                        const adminDocSnap = await getDoc(adminUserRef);
                        if (adminDocSnap.exists()) {
                            isAdmin = true;
                            console.log("Admin user confirmed:", user.uid);
                            showAdminView();
                        } else {
                            console.log("User signed in with email but is not an admin:", user.uid);
                            await signOut(auth); 
                            showMessage('আপনি অ্যাডমিন হিসেবে অনুমোদিত নন।', 'error');
                            // onAuthStateChanged will fire again with user=null
                            loadingIndicator.classList.add('hidden');
                            return; 
                        }
                    } catch (error) {
                        console.error("Error checking admin status:", error);
                        await signOut(auth); 
                        showMessage('অ্যাডমিন স্ট্যাটাস যাচাই করতে সমস্যা হয়েছে।', 'error');
                        loadingIndicator.classList.add('hidden');
                        return;
                    }
                } else if (user.isAnonymous) { 
                    if (currentPasscode) {
                        showUserView();
                    } else {
                        showLoginView();
                    }
                } else { 
                    showLoginView();
                }
                
                await setupInitialProducts(); 
                listenToProducts();

            } else { 
                console.log("User is signed out.");
                currentUserId = null;
                isAdmin = false;
                currentPasscode = null; 
                currentSector = null;
                cart = []; 
                renderCart();
                showLoginView();
                if (unsubscribeProducts) { unsubscribeProducts(); unsubscribeProducts = null; }
                if (unsubscribeOrders) { unsubscribeOrders(); unsubscribeOrders = null; }
            }
            loadingIndicator.classList.add('hidden'); // Hide general loading
        }
        
        window.onload = initializeAppSession;

        // --- View Management ---
        function showLoginView() {
            loginForms.classList.remove('hidden');
            userSection.classList.add('hidden');
            adminSection.classList.add('hidden');
            logoutButton.classList.add('hidden');
            currentViewSpan.textContent = 'লগইন করুন';
            if (unsubscribeOrders) { 
                unsubscribeOrders();
                unsubscribeOrders = null;
            }
        }

        function showUserView() {
            loginForms.classList.add('hidden');
            userSection.classList.remove('hidden');
            adminSection.classList.add('hidden');
            logoutButton.classList.remove('hidden');
            currentViewSpan.textContent = `স্বাগতম! আপনার বর্তমান সেক্টর: ${currentSector}`;
        }

        function showAdminView() {
            loginForms.classList.add('hidden');
            userSection.classList.add('hidden');
            adminSection.classList.remove('hidden');
            logoutButton.classList.remove('hidden');
            currentViewSpan.textContent = `অ্যাডমিন প্যানেল (ব্যবহারকারী: ${auth.currentUser.email || auth.currentUser.uid.substring(0,10)+'...' })`;
            fetchAdminOrders(); 
        }
        
        // --- User (Passcode) Login ---
        userLoginButton.addEventListener('click', () => {
            const passcode = passcodeEntry.value.trim();
            if (!passcode) {
                showMessage('অনুগ্রহ করে পাসকোড প্রবেশ করান।', 'error');
                return;
            }

            if (!auth.currentUser || (auth.currentUser && !auth.currentUser.isAnonymous && !isAdmin)) {
                 console.warn("Passcode login attempt without clear anonymous session or while non-admin email user is signed in. This might indicate an issue.");
            }

            currentPasscode = passcode; 

            if (passcode === 'Khamer1') currentSector = 'কিচেন সেক্টর';
            else if (passcode === 'Khamer2') currentSector = 'পুরুষ সেক্টর';
            else if (passcode === 'Khamer3') currentSector = 'ফ্যামিলি সেক্টর';
            else {
                showMessage('ভুল পাসকোড। অনুগ্রহ করে সঠিক পাসকোড দিন।', 'error');
                currentPasscode = null;
                currentSector = null;
                return;
            }
            
            if(isAdmin) { 
                console.error("Admin flag true during passcode login. Resetting.");
                isAdmin = false; 
            }
            passcodeEntry.value = ''; 
            showUserView();
            showMessage(`"${currentSector}" হিসেবে লগইন সফল হয়েছে।`, 'success');
        });

        // --- Admin (Email/Password) Login ---
        adminLoginButton.addEventListener('click', async () => {
            const email = adminEmailEntry.value.trim();
            const password = adminPasswordEntry.value.trim();

            if (!email || !password) {
                showMessage('অনুগ্রহ করে অ্যাডমিন ইমেইল এবং পাসওয়ার্ড দিন।', 'error');
                return;
            }
            
            loadingIndicator.classList.remove('hidden');
            try {
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    await signOut(auth); 
                }
                await signInWithEmailAndPassword(auth, email, password);
                adminEmailEntry.value = '';
                adminPasswordEntry.value = '';
            } catch (error) {
                console.error("Admin login error:", error);
                showMessage(`অ্যাডমিন লগইন ব্যর্থ: ${error.code === 'auth/invalid-credential' ? 'ভুল ইমেইল অথবা পাসওয়ার্ড।' : error.message}`, 'error');
                await signInAnonymouslyIfNeeded();
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        // --- Logout ---
        logoutButton.addEventListener('click', async () => {
            loadingIndicator.classList.remove('hidden');
            const wasAdmin = isAdmin; 

            if (auth.currentUser && !auth.currentUser.isAnonymous) { 
                try {
                    await signOut(auth); 
                    showMessage(wasAdmin ? 'অ্যাডমিন সফলভাবে লগ আউট করেছেন।' : 'সফলভাবে লগ আউট করা হয়েছে।', 'info');
                } catch (error) {
                    console.error("Sign out error:", error);
                    showMessage(`লগ আউট করতে সমস্যা: ${error.message}`, 'error');
                }
            } else { 
                currentPasscode = null;
                currentSector = null;
                cart = []; 
                renderCart();
                showLoginView(); 
                showMessage('সফলভাবে লগ আউট করা হয়েছে।', 'info');
            }
            loadingIndicator.classList.add('hidden');
        });


        // --- Product Management (Real-time) ---
        async function setupInitialProducts() {
            const productsRef = collection(db, `artifacts/${appId}/public/data/products`);
            try {
                const snapshot = await getDocs(productsRef);
                if (snapshot.empty) {
                    console.log("No products found, setting up initial products...");
                    const initialProducts = [
                        { name: 'চাল (Rice)', category: 'কিচেন ক্যাটাগরি', price: 60, description: 'উচ্চ মানের বাসমতী চাল', imageUrl: 'https://placehold.co/300x200/FFFCCC/000000?text=চাল' },
                        { name: 'ডাল (Lentils)', category: 'কিচেন ক্যাটাগরি', price: 120, description: 'তাজা মুগ ডাল', imageUrl: 'https://placehold.co/300x200/FFFCCC/000000?text=ডাল' },
                        { name: 'সয়াবিন তেল (Soybean Oil)', category: 'কিচেন ক্যাটাগরি', price: 150, description: '৫ লিটার সয়াবিন তেল', imageUrl: 'https://placehold.co/300x200/FFFCCC/000000?text=তেল' },
                        { name: 'আলু (Potato)', category: 'কিচেন ক্যাটাগরি', price: 40, description: '১ কেজি তাজা আলু', imageUrl: 'https://placehold.co/300x200/FFFCCC/000000?text=আলু' },
                        { name: 'পেঁয়াজ (Onion)', category: 'কিচেন ক্যাটাগরি', price: 80, description: '১ কেজি দেশি পেঁয়াজ', imageUrl: 'https://placehold.co/300x200/FFFCCC/000000?text=পেঁয়াজ' },
                        { name: 'মুরগির মাংস (Chicken)', category: 'রেস্টুরেন্ট ক্যাটাগরি', price: 280, description: '১ কেজি ব্রয়লার মুরগি', imageUrl: 'https://placehold.co/300x200/E6F2FF/000000?text=মুরগি' },
                        { name: 'গরুর মাংস (Beef)', category: 'রেস্টুরেন্ট ক্যাটাগরি', price: 750, description: '১ কেজি গরুর মাংস (হাড়সহ)', imageUrl: 'https://placehold.co/300x200/E6F2FF/000000?text=গরুর+মাংস' },
                    ];
                    for (const product of initialProducts) {
                        await addDoc(productsRef, product);
                    }
                    console.log("Initial products added.");
                } else {
                    console.log("Products already exist or listener will populate.");
                }
            } catch (error) {
                console.error("Error setting up initial products: ", error);
            }
        }

        function listenToProducts() {
            if (unsubscribeProducts) unsubscribeProducts(); 

            productLoadingIndicator.classList.remove('hidden');
            const productsQuery = collection(db, `artifacts/${appId}/public/data/products`);
            
            unsubscribeProducts = onSnapshot(productsQuery, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(); 
                productLoadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Error listening to products: ", error);
                showMessage(`পণ্য আনতে সমস্যা হচ্ছে: ${error.message}`, 'error');
                productListDiv.innerHTML = '<p class="text-red-500">পণ্য লোড করা যায়নি।</p>';
                productLoadingIndicator.classList.add('hidden');
            });
        }

        function renderProducts() {
            productListDiv.innerHTML = ''; 
            if (products.length === 0 && !productLoadingIndicator.classList.contains('hidden')) {
                return;
            }
            if (products.length === 0) {
                 productListDiv.innerHTML = '<p class="text-gray-500">এখন কোনো পণ্য উপলব্ধ নেই। অ্যাডমিন শীঘ্রই পণ্য যোগ করবেন।</p>';
                return;
            }

            const categories = {
                'রেস্টুরেন্ট ক্যাটাগরি': products.filter(p => p.category === 'রেস্টুরেন্ট ক্যাটাগরি'),
                'কিচেন ক্যাটাগরি': products.filter(p => p.category === 'কিচেন ক্যাটাগরি')
            };

            for (const categoryName in categories) {
                const categoryProducts = categories[categoryName];
                if (categoryProducts.length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.className = 'text-2xl font-semibold mt-6 mb-4 text-blue-600';
                    categoryHeader.textContent = categoryName;
                    productListDiv.appendChild(categoryHeader);

                    const gridDiv = document.createElement('div');
                    gridDiv.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6';

                    categoryProducts.forEach(product => {
                        const productCard = document.createElement('div');
                        productCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden transform hover:scale-105 transition-transform duration-300';
                        productCard.innerHTML = `
                            <img src="${product.imageUrl || 'https://placehold.co/300x200/CCCCCC/000000?text=পণ্য'}" alt="${product.name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x200/CCCCCC/000000?text=ত্রুটি';">
                            <div class="p-4">
                                <h4 class="text-xl font-semibold text-gray-800 mb-1">${product.name}</h4>
                                <p class="text-sm text-gray-600 mb-2">${product.description || ''}</p>
                                <p class="text-lg font-bold text-green-600 mb-3">৳${product.price}</p>
                                <div class="flex items-center mb-3">
                                    <label for="quantity-${product.id}" class="mr-2 text-sm text-gray-700">পরিমাণ:</label>
                                    <input type="number" id="quantity-${product.id}" value="1" min="1" class="w-16 p-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button data-product-id="${product.id}" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out add-to-cart-btn">
                                    কার্টে যোগ করুন
                                </button>
                            </div>
                        `;
                        gridDiv.appendChild(productCard);
                    });
                    productListDiv.appendChild(gridDiv);
                }
            }
            
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.removeEventListener('click', handleAddToCart); 
                button.addEventListener('click', handleAddToCart);
            });
        }
        
        function handleAddToCart(e) {
            const productId = e.target.dataset.productId;
            const quantityInput = document.getElementById(`quantity-${productId}`);
            const quantity = parseInt(quantityInput.value);
            if (quantity > 0) {
                addToCart(productId, quantity);
            } else {
                showMessage('অনুগ্রহ করে সঠিক পরিমাণ নির্বাচন করুন।', 'error');
            }
        }

        // --- Cart Management ---
        function addToCart(productId, quantity = 1) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) existingItem.quantity += quantity;
            else cart.push({ ...product, quantity });
            renderCart();
            showMessage(`${product.name} (${quantity} টি) কার্টে যোগ করা হয়েছে।`, 'success', 1500);
        }
        function renderCart() {
            cartItemsDiv.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = '<tr><td colspan="5" class="py-3 px-4 text-center text-gray-500">আপনার কার্ট খালি।</td></tr>';
                cartTotalSpan.textContent = '0';
                placeOrderButton.disabled = true;
                placeOrderButton.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            cart.forEach((item, index) => {
                const itemRow = document.createElement('tr');
                itemRow.className = 'border-b border-gray-200 hover:bg-gray-50';
                itemRow.innerHTML = `
                    <td class="py-3 px-4 text-left">${item.name}</td>
                    <td class="py-3 px-4 text-center">
                        <input type="number" value="${item.quantity}" min="1" data-cart-item-id="${item.id}" class="w-16 p-1 border border-gray-300 rounded-md cart-item-quantity text-center">
                    </td>
                    <td class="py-3 px-4 text-right">৳${parseFloat(item.price).toFixed(2)}</td>
                    <td class="py-3 px-4 text-right">৳${(parseFloat(item.price) * item.quantity).toFixed(2)}</td>
                    <td class="py-3 px-4 text-center">
                        <button data-cart-item-index="${index}" class="text-red-500 hover:text-red-700 remove-from-cart-btn font-semibold">অপসারণ</button>
                    </td>
                `;
                cartItemsDiv.appendChild(itemRow);
                total += parseFloat(item.price) * item.quantity;
            });
            cartTotalSpan.textContent = total.toFixed(2);
            placeOrderButton.disabled = false;
            placeOrderButton.classList.remove('opacity-50', 'cursor-not-allowed');
            document.querySelectorAll('.cart-item-quantity').forEach(input => {
                input.removeEventListener('change', handleCartQuantityChange);
                input.addEventListener('change', handleCartQuantityChange);
            });
            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.removeEventListener('click', handleRemoveFromCart);
                button.addEventListener('click', handleRemoveFromCart);
            });
        }
        function handleCartQuantityChange(e) { updateCartItemQuantity(e.target.dataset.cartItemId, parseInt(e.target.value)); }
        function handleRemoveFromCart(e) { removeFromCart(parseInt(e.target.dataset.cartItemIndex)); }
        function updateCartItemQuantity(itemId, newQuantity) {
            const item = cart.find(i => i.id === itemId);
            if (item && newQuantity > 0) item.quantity = newQuantity;
            else if (item && newQuantity <= 0) cart = cart.filter(i => i.id !== itemId);
            renderCart();
        }
        function removeFromCart(itemIndex) {
            if (itemIndex >= 0 && itemIndex < cart.length) {
                const removedItemName = cart[itemIndex].name;
                cart.splice(itemIndex, 1);
                renderCart();
                showMessage(`${removedItemName} কার্ট থেকে সরানো হয়েছে।`, 'info', 1500);
            }
        }

        // --- Order Placement ---
        placeOrderButton.addEventListener('click', async () => {
            if (cart.length === 0 || !currentPasscode || !auth.currentUser) {
                showMessage('অর্ডার করার জন্য কার্টে পণ্য যোগ করুন এবং পাসকোড দিয়ে লগইন করুন।', 'error');
                return;
            }
            loadingIndicator.classList.remove('hidden');
            placeOrderButton.disabled = true;
            placeOrderButton.classList.add('opacity-50');
            const orderItems = cart.map(item => ({ productId: item.id, productName: item.name, quantity: item.quantity, price: parseFloat(item.price) }));
            const totalAmount = cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
            let orderSector; 
            if (currentPasscode === 'Khamer1') orderSector = 'কিচেন সেক্টর';
            else if (currentPasscode === 'Khamer2') orderSector = 'পুরুষ সেক্টর';
            else if (currentPasscode === 'Khamer3') orderSector = 'ফ্যামিলি সেক্টর';
            else { 
                showMessage('অর্ডারের জন্য সেক্টর নির্ধারণ করা যায়নি।', 'error');
                loadingIndicator.classList.add('hidden');
                placeOrderButton.disabled = false; placeOrderButton.classList.remove('opacity-50');
                return;
            }
            const orderData = { userId: auth.currentUser.uid, passcodeUsed: currentPasscode, sector: orderSector, items: orderItems, totalAmount: totalAmount, status: 'পেন্ডিং', timestamp: serverTimestamp() };
            try {
                const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
                const docRef = await addDoc(ordersRef, orderData);
                orderSuccessMessage.textContent = `আপনার অর্ডার (ID: ${docRef.id.substring(0,8)}...) সফলভাবে প্লেস করা হয়েছে! মোট বিল: ৳${totalAmount.toFixed(2)}`;
                orderSuccessModal.classList.remove('hidden');
                cart = []; renderCart();
            } catch (error) {
                console.error("Error placing order: ", error);
                showMessage(`অর্ডার করতে সমস্যা হচ্ছে: ${error.message}`, 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });
        closeOrderSuccessModalButton.addEventListener('click', () => {
            orderSuccessModal.classList.add('hidden');
            placeOrderButton.disabled = cart.length === 0; 
             if(cart.length > 0) placeOrderButton.classList.remove('opacity-50');
        });

        // --- Admin Panel: Order Management ---
        adminSectorFilter.addEventListener('change', fetchAdminOrders);
        function fetchAdminOrders() {
            if (!isAdmin || !auth.currentUser) return;
            adminLoadingIndicator.classList.remove('hidden');
            adminOrdersDiv.innerHTML = '<p class="text-center text-gray-500">অর্ডার লোড হচ্ছে...</p>';
            if (unsubscribeOrders) unsubscribeOrders();
            let ordersQuery = collection(db, `artifacts/${appId}/public/data/orders`);
            const selectedSector = adminSectorFilter.value;
            if (selectedSector) ordersQuery = query(ordersQuery, where("sector", "==", selectedSector));
            unsubscribeOrders = onSnapshot(ordersQuery, (snapshot) => {
                adminLoadingIndicator.classList.add('hidden');
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                orders.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderAdminOrders(orders);
            }, (error) => {
                console.error("Error fetching admin orders: ", error);
                adminOrdersDiv.innerHTML = `<p class="text-red-500 text-center">অর্ডার আনতে সমস্যা হচ্ছে: ${error.message}</p>`;
                adminLoadingIndicator.classList.add('hidden');
            });
        }
        function renderAdminOrders(orders) {
            adminOrdersDiv.innerHTML = '';
            if (orders.length === 0) {
                adminOrdersDiv.innerHTML = '<p class="text-center text-gray-500">কোনো অর্ডার পাওয়া যায়নি।</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white shadow-md rounded-lg overflow-hidden';
            table.innerHTML = `
                <thead class="bg-gray-200 text-gray-700">
                    <tr>
                        <th class="py-3 px-4 text-left">অর্ডার আইডি</th> <th class="py-3 px-4 text-left">সেক্টর</th>
                        <th class="py-3 px-4 text-left">পণ্যসমূহ</th> <th class="py-3 px-4 text-right">মোট টাকা</th>
                        <th class="py-3 px-4 text-left">সময়</th> <th class="py-3 px-4 text-left">স্ট্যাটাস</th>
                        <th class="py-3 px-4 text-left">অ্যাকশন</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700"></tbody>`;
            const tbody = table.querySelector('tbody');
            orders.forEach(order => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                const itemsString = order.items.map(item => `${item.productName} (x${item.quantity})`).join(',<br>');
                const orderTimestamp = order.timestamp ? new Date(order.timestamp.seconds * 1000).toLocaleString('bn-BD') : 'N/A';
                row.innerHTML = `
                    <td class="py-3 px-4">${order.id.substring(0, 8)}...</td> <td class="py-3 px-4">${order.sector}</td>
                    <td class="py-3 px-4 text-xs">${itemsString}</td> <td class="py-3 px-4 text-right">৳${parseFloat(order.totalAmount).toFixed(2)}</td>
                    <td class="py-3 px-4 text-sm">${orderTimestamp}</td>
                    <td class="py-3 px-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(order.status)}">${order.status}</span></td>
                    <td class="py-3 px-4">
                        <select data-order-id="${order.id}" class="p-1 border border-gray-300 rounded-md status-change-select text-sm">
                            <option value="পেন্ডিং" ${order.status === 'পেন্ডিং' ? 'selected' : ''}>পেন্ডিং</option>
                            <option value="প্রসেসিং" ${order.status === 'প্রসেসিং' ? 'selected' : ''}>প্রসেসিং</option>
                            <option value="সম্পন্ন" ${order.status === 'সম্পন্ন' ? 'selected' : ''}>সম্পন্ন</option>
                            <option value="বাতিল" ${order.status === 'বাতিল' ? 'selected' : ''}>বাতিল</option>
                        </select>
                    </td>`;
            });
            adminOrdersDiv.appendChild(table);
            document.querySelectorAll('.status-change-select').forEach(select => {
                select.removeEventListener('change', handleStatusChange);
                select.addEventListener('change', handleStatusChange);
            });
        }
        async function handleStatusChange(e) { await updateOrderStatus(e.target.dataset.orderId, e.target.value); }
        function getStatusColor(status) {
            switch (status) {
                case 'পেন্ডিং': return 'bg-yellow-200 text-yellow-800'; case 'প্রসেসিং': return 'bg-blue-200 text-blue-800';
                case 'সম্পন্ন': return 'bg-green-200 text-green-800'; case 'বাতিল': return 'bg-red-200 text-red-800';
                default: return 'bg-gray-200 text-gray-800';
            }
        }
        async function updateOrderStatus(orderId, newStatus) {
            loadingIndicator.classList.remove('hidden'); 
            const orderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
            try {
                await updateDoc(orderRef, { status: newStatus });
                showMessage(`অর্ডার ${orderId.substring(0,8)}... স্ট্যাটাস "${newStatus}" করা হয়েছে।`, 'success');
            } catch (error) {
                console.error("Error updating order status: ", error);
                showMessage(`অর্ডার স্ট্যাটাস আপডেট করতে সমস্যা: ${error.message}`, 'error');
            } finally {
                loadingIndicator.classList.add('hidden'); 
            }
        }

        // --- Admin Panel: Add Product ---
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin) { showMessage('পণ্য যোগ করার অনুমতি নেই।', 'error'); return; }
            const name = productNameInput.value.trim();
            const description = productDescriptionInput.value.trim();
            const price = parseFloat(productPriceInput.value);
            const category = productCategoryInput.value;
            const imageUrl = productImageUrlInput.value.trim();
            if (!name || !price || !category) { showMessage('পণ্যের নাম, মূল্য এবং ক্যাটাগরি আবশ্যক।', 'error'); return; }
            if (isNaN(price) || price <= 0) { showMessage('সঠিক মূল্য লিখুন।', 'error'); return; }
            addProductButton.disabled = true; addProductLoadingIndicator.classList.remove('hidden');
            const newProduct = { name, description, price, category, imageUrl: imageUrl || `https://placehold.co/300x200/CCCCCC/000000?text=${encodeURIComponent(name)}`, addedBy: auth.currentUser.uid, createdAt: serverTimestamp() };
            try {
                const productsRef = collection(db, `artifacts/${appId}/public/data/products`);
                await addDoc(productsRef, newProduct);
                showMessage(`পণ্য "${name}" সফলভাবে যোগ করা হয়েছে।`, 'success');
                addProductForm.reset(); 
            } catch (error) {
                console.error("Error adding product:", error);
                showMessage(`পণ্য যোগ করতে সমস্যা: ${error.message}`, 'error');
            } finally {
                addProductButton.disabled = false; addProductLoadingIndicator.classList.add('hidden');
            }
        });

        // --- Utility Functions ---
        let messageTimeout;
        function showMessage(msg, type = 'info', duration = 3000) {
            messageDiv.textContent = msg;
            messageDiv.className = 'fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white text-sm z-[100] cursor-pointer transition-opacity duration-300'; 
            if (type === 'success') messageDiv.classList.add('bg-green-500');
            else if (type === 'error') messageDiv.classList.add('bg-red-500');
            else if (type === 'info') messageDiv.classList.add('bg-blue-500');
            else messageDiv.classList.add('bg-gray-700');
            messageDiv.classList.remove('hidden', 'opacity-0');
            messageDiv.classList.add('opacity-100');
            clearTimeout(messageTimeout); 
            if (duration !== 0) { 
                messageTimeout = setTimeout(() => {
                    messageDiv.classList.remove('opacity-100');
                    messageDiv.classList.add('opacity-0');
                    setTimeout(() => messageDiv.classList.add('hidden'), 300); 
                }, duration);
            }
        }
        messageDiv.addEventListener('click', () => {
            messageDiv.classList.remove('opacity-100');
            messageDiv.classList.add('opacity-0');
            setTimeout(() => messageDiv.classList.add('hidden'), 300);
            clearTimeout(messageTimeout);
        });
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance:textfield; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .hidden { display: none !important; } 
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-gradient-to-r from-sky-600 to-cyan-700 text-white p-5 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto flex flex-wrap justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold">গুদাম ম্যানেজমেন্ট সিস্টেম</h1>
            <div class="flex items-center space-x-4 mt-2 md:mt-0">
                <span id="currentViewSpan" class="text-sm md:text-base">লোড হচ্ছে...</span>
                <button id="logoutButton" class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 text-sm">লগ আউট</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 flex-grow">
        <section id="loginForms" class="max-w-lg mx-auto mt-8 space-y-8">
            <div id="userPasscodeLogin" class="bg-white p-6 md:p-8 rounded-xl shadow-2xl">
                <h2 class="text-xl md:text-2xl font-semibold text-center text-gray-700 mb-6">ব্যবহারকারী লগইন (পাসকোড)</h2>
                <div class="mb-4">
                    <label for="passcodeEntry" class="block text-sm font-medium text-gray-600 mb-1">পাসকোড (Khamer1, Khamer2, Khamer3):</label>
                    <input type="password" id="passcodeEntry" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Khamer পাসকোড">
                </div>
                <button id="userLoginButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out transform hover:scale-105">ব্যবহারকারী হিসেবে প্রবেশ</button>
            </div>
            <div id="adminEmailLogin" class="bg-white p-6 md:p-8 rounded-xl shadow-2xl">
                <h2 class="text-xl md:text-2xl font-semibold text-center text-gray-700 mb-6">অ্যাডমিন লগইন (ইমেইল)</h2>
                <div class="mb-4">
                    <label for="adminEmailEntry" class="block text-sm font-medium text-gray-600 mb-1">অ্যাডমিন ইমেইল:</label>
                    <input type="email" id="adminEmailEntry" autocomplete="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150" placeholder="admin@example.com">
                </div>
                <div class="mb-6">
                    <label for="adminPasswordEntry" class="block text-sm font-medium text-gray-600 mb-1">অ্যাডমিন পাসওয়ার্ড:</label>
                    <input type="password" id="adminPasswordEntry" autocomplete="current-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150" placeholder="পাসওয়ার্ড">
                </div>
                <button id="adminLoginButton" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out transform hover:scale-105">অ্যাডমিন হিসেবে প্রবেশ</button>
            </div>
        </section>

        <section id="userSection" class="hidden">
            <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl mb-8">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 border-b-2 border-blue-500 pb-2">পণ্য তালিকা</h2>
                <div id="productLoadingIndicator" class="hidden text-center py-4">
                    <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="text-gray-500 mt-2">পণ্য লোড হচ্ছে...</p>
                </div>
                <div id="productList" class="custom-scrollbar"></div>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 border-b-2 border-green-500 pb-2">শপিং কার্ট</h2>
                <div class="overflow-x-auto custom-scrollbar mb-6">
                    <table class="min-w-full bg-white"><thead class="bg-gray-100"><tr>
                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">পণ্য</th>
                        <th class="py-3 px-4 text-center text-sm font-semibold text-gray-600 uppercase">পরিমাণ</th>
                        <th class="py-3 px-4 text-right text-sm font-semibold text-gray-600 uppercase">একক মূল্য</th>
                        <th class="py-3 px-4 text-right text-sm font-semibold text-gray-600 uppercase">মোট</th>
                        <th class="py-3 px-4 text-center text-sm font-semibold text-gray-600 uppercase">অ্যাকশন</th>
                    </tr></thead><tbody id="cartItems"></tbody></table>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center border-t pt-4">
                    <p class="text-xl font-semibold text-gray-700 mb-4 sm:mb-0">সর্বমোট: <span class="text-green-600">৳<span id="cartTotal">0.00</span></span></p>
                    <button id="placeOrderButton" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition duration-150 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>অর্ডার করুন</button>
                </div>
            </div>
        </section>

        <section id="adminSection" class="hidden space-y-8">
            <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl">
                <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b-2 border-purple-500 pb-2">নতুন পণ্য যোগ করুন</h3>
                <form id="addProductForm" class="space-y-4">
                    <div><label for="productName" class="block text-sm font-medium text-gray-700">পণ্যের নাম:</label><input type="text" id="productName" name="productName" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"></div>
                    <div><label for="productDescription" class="block text-sm font-medium text-gray-700">পণ্যের বিবরণ (ঐচ্ছিক):</label><textarea id="productDescription" name="productDescription" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"></textarea></div>
                    <div><label for="productPrice" class="block text-sm font-medium text-gray-700">মূল্য (৳):</label><input type="number" id="productPrice" name="productPrice" required min="0.01" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"></div>
                    <div><label for="productCategory" class="block text-sm font-medium text-gray-700">ক্যাটাগরি:</label><select id="productCategory" name="productCategory" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"><option value="কিচেন ক্যাটাগরি">কিচেন ক্যাটাগরি</option><option value="রেস্টুরেন্ট ক্যাটাগরি">রেস্টুরেন্ট ক্যাটাগরি</option></select></div>
                    <div><label for="productImageUrl" class="block text-sm font-medium text-gray-700">ছবির URL (ঐচ্ছিক):</label><input type="url" id="productImageUrl" name="productImageUrl" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" placeholder="https://example.com/image.jpg"></div>
                    <button type="submit" id="addProductButton" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-md transition duration-150 flex items-center justify-center">
                        <span id="addProductLoadingIndicator" class="hidden mr-2"><svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>
                        পণ্য যোগ করুন
                    </button>
                </form>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl">
                <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-2 border-b-2 border-teal-500 pb-2">অর্ডার ম্যানেজমেন্ট</h3>
                <p class="text-gray-600 mb-6">এখানে সকল অর্ডার এবং তাদের স্ট্যাটাস দেখা যাবে।</p>
                <div class="mb-4">
                    <label for="adminSectorFilter" class="block text-sm font-medium text-gray-700">সেক্টর অনুযায়ী ফিল্টার করুন:</label>
                    <select id="adminSectorFilter" class="mt-1 block w-full sm:w-1/3 p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">সকল সেক্টর</option><option value="কিচেন সেক্টর">কিচেন সেক্টর</option><option value="পুরুষ সেক্টর">পুরুষ সেক্টর</option><option value="ফ্যামিলি সেক্টর">ফ্যামিলি সেক্টর</option>
                    </select>
                </div>
                 <div id="adminLoadingIndicator" class="hidden text-center py-4">
                    <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="text-gray-500 mt-2">অর্ডার লোড হচ্ছে...</p>
                </div>
                <div id="adminOrders" class="overflow-x-auto custom-scrollbar"></div>
            </div>
        </section>
    </main>

    <div id="loadingIndicator" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[110]">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
    </div>
    <div id="messageDiv" class="hidden fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white text-sm z-[100] cursor-pointer opacity-0"></div>
    <div id="orderSuccessModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full modal z-[90]">
        <div class="relative top-1/4 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white modal-content">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">অর্ডার সফল!</h3>
                <div class="mt-2 px-7 py-3"><p id="orderSuccessMessage" class="text-sm text-gray-500"></p></div>
                <div class="items-center px-4 py-3"><button id="closeOrderSuccessModalButton" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">ঠিক আছে</button></div>
            </div>
        </div>
    </div>

    <footer class="text-center p-4 text-gray-600 text-sm mt-auto border-t border-gray-200 bg-gray-50">
        &copy; ২০২৫ গুদাম ম্যানেজমেন্ট সিস্টেম। সর্বস্বত্ব সংরক্ষিত।
    </footer>

</body>
</html>