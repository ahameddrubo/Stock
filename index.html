<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khamer Restaurant - Warehouse Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest/dist/lucide.min.js"></script>
    <style>
        /* Default to Light Mode */
        :root {
            --bg-primary: #ffffff; /* white */
            --bg-secondary: #f9fafb; /* gray-50 */
            --bg-accent: #eff6ff; /* blue-50 */
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #6b7280; /* gray-500 */
            --border-primary: #e5e7eb; /* gray-200 */
            --border-secondary: #d1d5db; /* gray-300 */
            --brand-primary: #2563eb; /* blue-600 */
            --brand-hover: #1d4ed8; /* blue-700 */
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --card-bg: #ffffff;
            --modal-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        html.dark {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-accent: #374151; /* gray-700 */
            --text-primary: #f3f4f6; /* gray-100 */
            --text-secondary: #9ca3af; /* gray-400 */
            --border-primary: #374151; /* gray-700 */
            --border-secondary: #4b5563; /* gray-600 */
            --brand-primary: #3b82f6; /* blue-500 */
            --brand-hover: #2563eb; /* blue-600 */
            --input-bg: #374151; /* gray-700 */
            --input-border: #4b5563; /* gray-600 */
            --card-bg: #1f2937; /* gray-800 */
            --modal-bg: #1f2937; /* gray-800 */
            --shadow-color: rgba(0, 0, 0, 0.3);
        }
        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif; /* Assuming Inter is a preferred font */
            transition: background-color 0.3s, color 0.3s;
        }
        /* Tailwind Customization for dynamic properties */
        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-accent { background-color: var(--bg-accent); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-primary { border-color: var(--border-primary); }
        .border-secondary { border-color: var(--border-secondary); }
        .brand-primary { background-color: var(--brand-primary); color: white; }
        .brand-primary:hover { background-color: var(--brand-hover); }
        .text-brand-primary { color: var(--brand-primary); }
        .input-styled { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text-primary); }
        .card { background-color: var(--card-bg); box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -1px var(--shadow-color); }
        .modal-content { background-color: var(--modal-bg); }

        /* For Lucide icons */
        .lucide {
            width: 1em;
            height: 1em;
            stroke-width: 2;
            vertical-align: middle;
        }
        /* RTL support for icons */
        [dir="rtl"] .lucide.mr-1 { margin-left: 0.25rem; margin-right: 0; }
        [dir="rtl"] .lucide.ml-1 { margin-right: 0.25rem; margin-left: 0; }
        [dir="rtl"] .lucide.mr-2 { margin-left: 0.5rem; margin-right: 0; }
        [dir="rtl"] .lucide.ml-2 { margin-right: 0.5rem; margin-left: 0; }
        
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        /* General button styling */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .btn-primary {
            background-color: var(--brand-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--brand-hover);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .btn-secondary {
            background-color: var(--bg-accent);
            color: var(--brand-primary);
            border: 1px solid var(--brand-primary);
        }
        .btn-secondary:hover {
            background-color: var(--brand-primary);
            color: white;
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-success {
            background-color: #22c55e; /* green-500 */
            color: white;
        }
        .btn-success:hover {
            background-color: #16a34a; /* green-600 */
        }
        .btn-warning {
            background-color: #f59e0b; /* amber-500 */
            color: white;
        }
        .btn-warning:hover {
            background-color: #d97706; /* amber-600 */
        }
        .btn-icon {
            padding: 0.5rem;
        }
        .low-stock-alert {
            border: 2px solid #ef4444; /* red-500 */
        }
        .low-stock-text {
            color: #ef4444; /* red-500 */
            font-weight: bold;
        }
        /* Notification styles */
        #notification-banner {
            position: fixed;
            top: 80px; /* Below navbar */
            right: 20px;
            z-index: 1000;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translateY(-20px);
        }
        #notification-banner.show {
            opacity: 1;
            transform: translateY(0);
        }
        #notification-banner.success { background-color: #22c55e; } /* green-500 */
        #notification-banner.error { background-color: #ef4444; } /* red-500 */
        #notification-banner.info { background-color: #3b82f6; } /* blue-500 */

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 1rem;
        }
        .modal-container {
            background-color: var(--modal-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px var(--shadow-color);
            width: 100%;
            max-width: 500px; /* Default max-width */
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--brand-primary);
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.7); /* Light overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        html.dark .loading-overlay {
             background-color: rgba(0, 0, 0, 0.7); /* Dark overlay */
        }
    </style>
</head>
<body>
    <nav id="navbar" class="bg-primary shadow-md sticky top-0 z-40 py-3 px-4">
        </nav>

    <main id="main-content" class="p-4 md:p-8 min-h-[calc(100vh-150px)]">
        <div class="flex items-center justify-center h-64">
            <div class="spinner"></div> <span class="ml-3 text-lg">Loading...</span>
        </div>
    </main>

    <footer id="footer" class="bg-secondary text-center py-4 border-t border-primary">
        </footer>

    <div id="modal-placeholder"></div>

    <div id="notification-banner">
        <span id="notification-message"></span>
    </div>

    <script type="module">
        // Firebase App (the core Firebase SDK) is always required and must be listed first
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Add SDKs for Firebase products that you want to use
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            onSnapshot,
            writeBatch,
            setDoc,
            getDoc,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables and Configuration ---
        // Updated Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCa_bwrAn7_QImUbnrqj0wSHrWqspFiNBE",
            authDomain: "stock-mantain-d6427.firebaseapp.com",
            projectId: "stock-mantain-d6427",
            storageBucket: "stock-mantain-d6427.firebasestorage.app",
            messagingSenderId: "150865127526",
            appId: "1:150865127526:web:bb39866ca4acd9fbbb25a7",
            measurementId: "G-1P1LMBLZ88"
        };
        
        // Use projectId for Firestore path if __app_id is not defined
        const appIdForPath = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        
        let db, auth;
        let currentLanguage = 'en';
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentPage = 'user'; // 'user', 'adminLogin', 'adminDashboard'
        let currentUser = null;
        let userId = null;
        let isAuthReady = false;

        let productsCache = [];
        let ordersCache = [];
        let cart = JSON.parse(localStorage.getItem('khamerCart')) || [];

        // Firestore collection paths using appIdForPath
        const productsCollectionPath = `/artifacts/${appIdForPath}/public/data/products`;
        const ordersCollectionPath = `/artifacts/${appIdForPath}/public/data/orders`;

        // Translations (Bangla and English)
        const translations = {
            en: {
                appName: "Khamer Restaurant", // App name remains in English as requested
                restaurantSector: "Restaurant Sector",
                kitchenSector: "Kitchen Sector",
                addToCart: "Add to Cart",
                placeOrder: "Place Order",
                adminPanel: "Admin Panel",
                login: "Login",
                email: "Email",
                password: "Password",
                manageStock: "Manage Stock",
                addNewProduct: "Add New Product",
                productNameEn: "Product Name (EN)",
                productNameAr: "Product Name (AR)", // Kept AR for consistency with previous structure
                category: "Category",
                stock: "Stock",
                lowStockThreshold: "Low Stock Alert At",
                saveProduct: "Save Product",
                updateProduct: "Update Product",
                editProduct: "Edit Product",
                currentStock: "Current Stock",
                orders: "Orders",
                viewOrders: "View Orders",
                product: "Product",
                quantity: "Quantity",
                status: "Status",
                pending: "Pending",
                confirmed: "Confirmed",
                confirmOrder: "Confirm Order",
                noProducts: "No products available in this sector.",
                noProductsFound: "No products match your criteria.",
                noOrders: "No orders yet.",
                cart: "Cart",
                emptyCart: "Your cart is empty.",
                totalItems: "Total Items",
                logout: "Logout",
                dashboard: "Dashboard",
                selectCategory: "Select Category",
                restaurant: "Restaurant",
                kitchen: "Kitchen",
                allProducts: "All Products",
                productManagement: "Product Management",
                orderManagement: "Order Management",
                actions: "Actions",
                edit: "Edit",
                delete: "Delete",
                filterByCategory: "Filter by Category:",
                items: "items",
                searchProducts: "Search products...",
                appDescription: "Efficiently manage your restaurant's warehouse inventory.",
                loginToAdmin: "Login to Admin Panel",
                orderPlacedSuccessfully: "Order placed successfully!",
                errorPlacingOrder: "Error placing order. Please try again.",
                productAddedSuccess: "Product added successfully!",
                productUpdatedSuccess: "Product updated successfully!",
                productDeletedSuccess: "Product deleted successfully!",
                confirmDeleteProductTitle: "Confirm Delete",
                confirmDeleteProductMessage: "Are you sure you want to delete this product?",
                confirmOrderDialogTitle: "Confirm Order",
                confirmOrderConfirmation: "Are you sure you want to confirm this order? Stock will be updated.",
                stockUpdated: "Stock updated.",
                insufficientStock: "Insufficient stock for some items. Order cannot be fully confirmed.",
                loginSuccess: "Login successful!",
                loginFailed: "Login failed. Check credentials.",
                logoutSuccess: "Logged out successfully.",
                errorFetchingProducts: "Error fetching products.",
                errorFetchingOrders: "Error fetching orders.",
                errorSavingProduct: "Error saving product.",
                errorDeletingProduct: "Error deleting product.",
                errorConfirmingOrder: "Error confirming order.",
                productNameRequired: "Product names (EN and AR) are required.",
                loading: "Loading...",
                close: "Close",
                cancel: "Cancel",
                confirm: "Confirm",
                userIdLabel: "User ID",
                theme: "Theme",
                light: "Light",
                dark: "Dark",
                date: "Date",
                requested: "Requested",
                available: "Available",
                productNotFound: "Product not found.",
                orderId: "Order ID",
                clearCart: "Clear Cart",
                cartCleared: "Cart cleared.",
                viewCart: "View Cart",
                continueShopping: "Continue Shopping",
                price: "Price", 
                totalPrice: "Total Price", 
                stockLevel: "Stock Level",
                categoryFilterAll: "All Categories",
                outOfStock: "Out of Stock",
                itemOutOfStock: "Item is out of stock.",
                maxStockReached: "Cannot add more than available stock.",
                quantityCappedAtStock: "Quantity capped at available stock",
            },
            ar: { // Arabic translations
                appName: "Khamer Restaurant", 
                restaurantSector: "قسم المطعم",
                kitchenSector: "قسم المطبخ",
                addToCart: "أضف إلى السلة",
                placeOrder: "إتمام الطلب",
                adminPanel: "لوحة الإدارة",
                login: "تسجيل الدخول",
                email: "البريد الإلكتروني",
                password: "كلمة المرور",
                manageStock: "إدارة المخزون",
                addNewProduct: "إضافة منتج جديد",
                productNameEn: "اسم المنتج (EN)",
                productNameAr: "اسم المنتج (AR)",
                category: "الفئة",
                stock: "المخزون",
                lowStockThreshold: "تنبيه انخفاض المخزون عند",
                saveProduct: "حفظ المنتج",
                updateProduct: "تحديث المنتج",
                editProduct: "تعديل المنتج",
                currentStock: "المخزون الحالي",
                orders: "الطلبات",
                viewOrders: "عرض الطلبات",
                product: "المنتج",
                quantity: "الكمية",
                status: "الحالة",
                pending: "قيد الانتظار",
                confirmed: "مؤكد",
                confirmOrder: "تأكيد الطلب",
                noProducts: "لا توجد منتجات متوفرة في هذا القسم.",
                noProductsFound: "لا توجد منتجات تطابق معاييرك.",
                noOrders: "لا توجد طلبات حتى الآن.",
                cart: "سلة التسوق",
                emptyCart: "سلة التسوق فارغة.",
                totalItems: "إجمالي العناصر",
                logout: "تسجيل الخروج",
                dashboard: "لوحة التحكم",
                selectCategory: "اختر الفئة",
                restaurant: "مطعم",
                kitchen: "مطبخ",
                allProducts: "جميع المنتجات",
                productManagement: "إدارة المنتجات",
                orderManagement: "إدارة الطلبات",
                actions: "الإجراءات",
                edit: "تعديل",
                delete: "حذف",
                filterByCategory: "تصفية حسب الفئة:",
                items: "عناصر",
                searchProducts: "ابحث عن المنتجات...",
                appDescription: "إدارة مخزون مستودع مطعمك بكفاءة.",
                loginToAdmin: "تسجيل الدخول إلى لوحة الإدارة",
                orderPlacedSuccessfully: "تم تقديم الطلب بنجاح!",
                errorPlacingOrder: "خطأ في تقديم الطلب. يرجى المحاولة مرة أخرى.",
                productAddedSuccess: "تمت إضافة المنتج بنجاح!",
                productUpdatedSuccess: "تم تحديث المنتج بنجاح!",
                productDeletedSuccess: "تم حذف المنتج بنجاح!",
                confirmDeleteProductTitle: "تأكيد الحذف",
                confirmDeleteProductMessage: "هل أنت متأكد أنك تريد حذف هذا المنتج؟",
                confirmOrderDialogTitle: "تأكيد الطلب",
                confirmOrderConfirmation: "هل أنت متأكد أنك تريد تأكيد هذا الطلب؟ سيتم تحديث المخزون.",
                stockUpdated: "تم تحديث المخزون.",
                insufficientStock: "مخزون غير كاف لبعض العناصر. لا يمكن تأكيد الطلب بالكامل.",
                loginSuccess: "تم تسجيل الدخول بنجاح!",
                loginFailed: "فشل تسجيل الدخول. تحقق من البيانات.",
                logoutSuccess: "تم تسجيل الخروج بنجاح.",
                errorFetchingProducts: "خطأ في جلب المنتجات.",
                errorFetchingOrders: "خطأ في جلب الطلبات.",
                errorSavingProduct: "خطأ في حفظ المنتج.",
                errorDeletingProduct: "خطأ في حذف المنتج.",
                errorConfirmingOrder: "خطأ في تأكيد الطلب.",
                productNameRequired: "أسماء المنتج (EN و AR) مطلوبة.",
                loading: "جار التحميل...",
                close: "إغلاق",
                cancel: "إلغاء",
                confirm: "تأكيد",
                userIdLabel: "معرف المستخدم",
                theme: "المظهر",
                light: "فاتح",
                dark: "داكن",
                date: "التاريخ",
                requested: "مطلوب",
                available: "متوفر",
                productNotFound: "المنتج غير موجود.",
                orderId: "رقم الطلب",
                clearCart: "إفراغ السلة",
                cartCleared: "تم إفراغ السلة.",
                viewCart: "عرض السلة",
                continueShopping: "متابعة التسوق",
                price: "السعر",
                totalPrice: "السعر الإجمالي",
                stockLevel: "مستوى المخزون",
                categoryFilterAll: "جميع الفئات",
                outOfStock: "إنتهى من المخزن",
                itemOutOfStock: "هذا المنتج غير متوفر حالياً.",
                maxStockReached: "لا يمكن إضافة كمية أكبر من المتوفر في المخزون.",
                quantityCappedAtStock: "تم تحديد الكمية حسب المخزون المتوفر",
            }
        };

        // --- Helper Functions ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const t = (key) => translations[currentLanguage][key] || key;
        const createIcon = (iconName, classes = "") => `<i data-lucide="${iconName}" class="${classes}"></i>`;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                setLogLevel('debug'); // For development, shows detailed logs
                
                applyTheme(); // Apply theme early
                initializeAuthAndListeners();
                renderNavbar(); // Initial render of navbar
                renderFooter(); // Initial render of footer
                // Initial page rendering will be handled by onAuthStateChanged
            } catch (error) {
                console.error("Error initializing Firebase or application:", error);
                $('#main-content').innerHTML = `<p class="text-red-500 text-center text-xl p-8">Application failed to initialize. Please check console for errors.</p>`;
            }
        });

        async function initializeAuthAndListeners() {
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                     await signInAnonymously(auth);
                    console.log("Signed in anonymously as fallback.");
                }
            } catch (error) {
                console.error("Error during initial sign-in:", error);
                 try {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously after custom token failure.");
                } catch (anonError) {
                    console.error("Error during anonymous sign-in fallback:", anonError);
                }
            }

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    userId = user.uid;
                    if(user.isAnonymous) {
                        // Keep track of anonymous user ID if needed, or use UID directly
                        localStorage.setItem('anonymousUserId', user.uid);
                    } else {
                        // Logged-in admin
                        localStorage.removeItem('anonymousUserId'); 
                    }
                } else {
                    // No user, could be after sign out, try to get/set an anonymous ID
                    userId = localStorage.getItem('anonymousUserId') || crypto.randomUUID();
                    if (!localStorage.getItem('anonymousUserId')) {
                        localStorage.setItem('anonymousUserId', userId);
                    }
                }


                isAuthReady = true;
                console.log("Auth state changed. User:", user, "User ID for Firestore ops:", userId);
                
                renderNavbar(); 
                navigateToCurrentPage();
                fetchProducts(); 
                if (currentUser && !currentUser.isAnonymous) { 
                    fetchOrders(); 
                }
            });
        }
        
        function navigateToCurrentPage() {
            if (!isAuthReady) {
                 $('#main-content').innerHTML = `<div class="flex items-center justify-center h-64"><div class="spinner"></div> <span class="ml-3 text-lg">${t('loading')}</span></div>`;
                 return;
            }
            console.log("Navigating to page:", currentPage, "User:", currentUser);
            if (currentPage === 'user') showUserPage();
            else if (currentPage === 'adminLogin') showAdminLoginPage();
            else if (currentPage === 'adminDashboard' && currentUser && !currentUser.isAnonymous) showAdminDashboardPage();
            else if (currentPage === 'adminDashboard' && (!currentUser || currentUser.isAnonymous)) {
                currentPage = 'adminLogin'; 
                showAdminLoginPage();
            }
            else showUserPage(); 
            updateActiveNavLink();
            lucide.createIcons(); 
        }


        // --- Language and Theme ---
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'ar' : 'en';
            document.documentElement.lang = currentLanguage;
            document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
            renderAll();
        }

        function applyTheme() {
            if (currentTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            applyTheme();
            renderNavbar(); 
        }
        
        function renderAll() {
            renderNavbar();
            renderFooter();
            navigateToCurrentPage(); 
        }

        // --- UI Rendering ---
        function renderNavbar() {
            const nav = $('#navbar');
            if (!nav) return;
            nav.innerHTML = `
                <div class="container mx-auto flex flex-wrap items-center justify-between">
                    <h1 class="text-2xl font-bold text-brand-primary">Khamer Restaurant</h1>
                    <div class="flex items-center space-x-2 rtl:space-x-reverse mt-2 sm:mt-0">
                        <button id="nav-user-view" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-secondary hover:text-primary">${t('allProducts')}</button>
                        ${currentUser && !currentUser.isAnonymous ? `
                            <button id="nav-admin-dashboard" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-secondary hover:text-primary flex items-center">${createIcon('user-cog', 'mr-1 rtl:ml-1')} ${t('adminPanel')}</button>
                            <button id="logout-btn" class="px-3 py-2 rounded-md text-sm font-medium text-red-500 hover:text-red-700 flex items-center">${createIcon('log-out', 'mr-1 rtl:ml-1')} ${t('logout')}</button>
                        ` : `
                            <button id="nav-admin-login" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-secondary hover:text-primary flex items-center">${createIcon('log-in', 'mr-1 rtl:ml-1')} ${t('adminPanel')}</button>
                        `}
                        <button id="lang-toggle-btn" class="p-2 rounded-md hover:bg-accent">
                            ${createIcon('languages')} <span class="ml-1 rtl:mr-1 text-sm font-medium">${currentLanguage === 'en' ? 'AR' : 'EN'}</span>
                        </button>
                        <button id="theme-toggle-btn" class="p-2 rounded-md hover:bg-accent">
                            ${currentTheme === 'light' ? createIcon('moon') : createIcon('sun')}
                        </button>
                    </div>
                </div>
            `;
            $('#lang-toggle-btn')?.addEventListener('click', toggleLanguage);
            $('#theme-toggle-btn')?.addEventListener('click', toggleTheme);
            $('#nav-user-view')?.addEventListener('click', () => { currentPage = 'user'; navigateToCurrentPage(); });
            $('#nav-admin-login')?.addEventListener('click', () => { currentPage = 'adminLogin'; navigateToCurrentPage(); });
            $('#nav-admin-dashboard')?.addEventListener('click', () => { currentPage = 'adminDashboard'; navigateToCurrentPage(); });
            $('#logout-btn')?.addEventListener('click', handleLogout);
            updateActiveNavLink();
            lucide.createIcons();
        }
        
        function updateActiveNavLink() {
            $$('.nav-link').forEach(link => link.classList.remove('text-brand-primary', 'font-bold'));
            if (currentPage === 'user') $('#nav-user-view')?.classList.add('text-brand-primary', 'font-bold');
            if (currentPage === 'adminLogin') $('#nav-admin-login')?.classList.add('text-brand-primary', 'font-bold');
            if (currentPage === 'adminDashboard') $('#nav-admin-dashboard')?.classList.add('text-brand-primary', 'font-bold');
        }

        function renderFooter() {
            const footer = $('#footer');
            if (!footer) return;
            footer.innerHTML = `<p class="text-sm text-secondary">&copy; ${new Date().getFullYear()} ${t('appName')} WMS. ${t('appDescription')}</p>`;
        }

        function showUserPage() {
            const mainContent = $('#main-content');
            if (!mainContent) return;
            mainContent.innerHTML = `
                <div class="mb-6">
                    <input type="text" id="search-products-user" placeholder="${t('searchProducts')}" class="w-full p-3 border border-secondary rounded-lg shadow-sm focus:ring-2 focus:ring-brand-primary input-styled">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div id="product-display-area" class="md:col-span-2 space-y-12">
                        <div class="flex items-center justify-center h-32"><div class="spinner"></div> <span class="ml-3 text-lg">${t('loading')}</span></div>
                    </div>
                    <aside id="cart-sidebar" class="card p-6 rounded-xl md:sticky md:top-24 h-fit">
                        </aside>
                </div>
            `;
            renderProductSections();
            renderCart();
            $('#search-products-user')?.addEventListener('input', (e) => renderProductSections(e.target.value));
        }

        function renderProductSections(searchTerm = '') {
            const productArea = $('#product-display-area');
            if (!productArea) return;

            if (productsCache.length === 0 && isAuthReady) { // Check if auth is ready before showing no products
                productArea.innerHTML = `<div class="flex items-center justify-center h-32"><div class="spinner"></div> <span class="ml-3 text-lg">${t('loading')}</span></div>`;
                return; // Still loading products or no products at all yet
            }


            const filtered = productsCache.filter(p => {
                const name = currentLanguage === 'ar' ? p.name_ar : p.name_en;
                return name.toLowerCase().includes(searchTerm.toLowerCase());
            });

            const restaurantProducts = filtered.filter(p => p.category === 'restaurant');
            const kitchenProducts = filtered.filter(p => p.category === 'kitchen');

            productArea.innerHTML = `
                ${renderProductCategoryHTML(t('restaurantSector'), restaurantProducts)}
                ${renderProductCategoryHTML(t('kitchenSector'), kitchenProducts)}
            `;
            if(filtered.length === 0 && searchTerm !== ''){
                 productArea.innerHTML += `<p class="text-center text-secondary py-4">${t('noProductsFound')}</p>`;
            } else if (productsCache.length > 0 && restaurantProducts.length === 0 && kitchenProducts.length === 0 && searchTerm === '') {
                 productArea.innerHTML = `<p class="text-center text-secondary py-4">${t('noProducts')}</p>`; // No products at all in any category
            }

            lucide.createIcons();
        }
        
        function renderProductCategoryHTML(title, productsInCategory) {
            let productsHTML = '';
            if (productsInCategory.length === 0) {
                // Don't show "No products in this sector" if search is active and it's just empty for this category due to search
                // This will be handled by the global "no products found" message if all categories are empty after search
                if (!$('#search-products-user') || !$('#search-products-user').value) {
                     productsHTML = `<p class="text-secondary">${t('noProducts')}</p>`;
                }
            } else {
                productsHTML = productsInCategory.map(renderProductCardHTML).join('');
            }
            // Only render the section if there are products or if it's not a search result context
            if (productsHTML || (!$('#search-products-user') || !$('#search-products-user').value)) {
                return `
                    <section>
                        <h2 class="text-3xl font-semibold mb-6 border-b-2 border-brand-primary pb-2 text-primary">${title}</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${productsHTML}
                        </div>
                    </section>
                `;
            }
            return ''; // Return empty if search yields no results for this specific category
        }

        function renderProductCardHTML(product) {
            const productName = currentLanguage === 'ar' ? product.name_ar : product.name_en;
            const isLowStock = product.stock <= product.lowStockThreshold;
            const stockAvailable = product.stock > 0;

            return `
                <div class="card rounded-xl overflow-hidden transition-all duration-300 hover:shadow-2xl transform hover:-translate-y-1 ${isLowStock && stockAvailable ? 'low-stock-alert' : ''}">
                    <div class="p-5">
                        <h3 class="text-xl font-semibold mb-2 text-primary truncate" title="${productName}">${productName}</h3>
                        <p class="text-sm text-secondary mb-1">${t('category')}: ${t(product.category)}</p>
                        <p class="text-sm mb-3 ${isLowStock && stockAvailable ? 'low-stock-text' : 'text-secondary'}">
                            ${t('stock')}: ${product.stock} 
                            ${isLowStock && stockAvailable ? createIcon('alert-triangle', 'inline ml-1 rtl:mr-1') : ''}
                            ${!stockAvailable ? `<span class="text-red-500 font-semibold">(${t('outOfStock')})</span>` : ''}
                        </p>
                        <button 
                            class="btn btn-primary w-full ${!stockAvailable ? 'opacity-50 cursor-not-allowed' : ''}" 
                            onclick="handleAddToCart('${product.id}')"
                            ${!stockAvailable ? 'disabled' : ''}
                        >
                            ${createIcon('shopping-cart', 'mr-2 rtl:ml-2')} ${t('addToCart')}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderCart() {
            const cartSidebar = $('#cart-sidebar');
            if (!cartSidebar) return;

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

            cartSidebar.innerHTML = `
                <h3 class="text-2xl font-semibold mb-6 text-primary flex items-center">
                    ${createIcon('shopping-cart', 'mr-2 rtl:ml-2 text-brand-primary')} ${t('cart')}
                </h3>
                ${cart.length === 0 ? `
                    <p class="text-secondary">${t('emptyCart')}</p>
                ` : `
                    <div class="space-y-4 max-h-96 overflow-y-auto mb-6 pr-2 rtl:pl-2">
                        ${cart.map(item => {
                            const productDetails = productsCache.find(p => p.id === item.id);
                            const itemName = currentLanguage === 'ar' ? item.name_ar : item.name_en;
                            const stockForThisItem = productDetails ? productDetails.stock : 0; 
                            return `
                            <div class="flex items-center justify-between p-3 bg-accent rounded-lg">
                                <div>
                                    <p class="font-medium text-primary truncate w-32 sm:w-40" title="${itemName}">${itemName}</p>
                                    <p class="text-xs text-secondary">${t('stock')}: ${stockForThisItem}</p>
                                </div>
                                <div class="flex items-center space-x-2 rtl:space-x-reverse">
                                    <button class="btn-icon p-1 text-red-500 hover:text-red-700" onclick="handleUpdateCartQuantity('${item.id}', ${item.quantity - 1})">${createIcon('minus-circle')}</button>
                                    <input type="number" value="${item.quantity}" readonly class="w-12 p-1 border border-secondary rounded-md text-center input-styled bg-primary" />
                                    <button class="btn-icon p-1 text-green-500 hover:text-green-700 ${item.quantity >= stockForThisItem ? 'opacity-50 cursor-not-allowed' : ''}" onclick="handleUpdateCartQuantity('${item.id}', ${item.quantity + 1})" ${item.quantity >= stockForThisItem ? 'disabled' : ''}>${createIcon('plus-circle')}</button>
                                    <button class="btn-icon p-1 text-red-500 hover:text-red-700" onclick="handleRemoveFromCart('${item.id}')">${createIcon('trash-2')}</button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    <div class="border-t border-primary pt-4">
                        <p class="text-lg font-semibold text-primary mb-1">
                            ${t('totalItems')}: <span class="text-brand-primary">${totalItems}</span>
                        </p>
                        <button class="btn btn-success w-full mb-2" onclick="handlePlaceOrder()">
                            ${createIcon('check-circle', 'mr-2 rtl:ml-2')} ${t('placeOrder')}
                        </button>
                        <button class="btn btn-danger w-full" onclick="handleClearCart()">
                            ${createIcon('trash', 'mr-2 rtl:ml-2')} ${t('clearCart')}
                        </button>
                    </div>
                `}
            `;
            lucide.createIcons();
        }
        
        // --- Cart Logic ---
        window.handleAddToCart = (productId) => {
            const product = productsCache.find(p => p.id === productId);
            if (!product || product.stock <= 0) {
                showNotification(t('itemOutOfStock'), 'error');
                return;
            }

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                } else {
                    showNotification(t('maxStockReached'), 'info');
                    return;
                }
            } else {
                cart.push({ 
                    id: product.id, 
                    name_en: product.name_en, 
                    name_ar: product.name_ar, 
                    quantity: 1,
                });
            }
            saveCartAndRender();
        }

        window.handleUpdateCartQuantity = (productId, newQuantity) => {
            const itemInCart = cart.find(item => item.id === productId);
            if (!itemInCart) return;

            const productDetails = productsCache.find(p => p.id === productId);
            const stockAvailable = productDetails ? productDetails.stock : 0;

            if (newQuantity <= 0) {
                cart = cart.filter(item => item.id !== productId);
            } else if (newQuantity > stockAvailable) {
                itemInCart.quantity = stockAvailable; 
                showNotification(`${t('quantityCappedAtStock')} (${stockAvailable}).`, 'info');
            } else {
                itemInCart.quantity = newQuantity;
            }
            saveCartAndRender();
        }
        
        window.handleRemoveFromCart = (productId) => {
            cart = cart.filter(item => item.id !== productId);
            saveCartAndRender();
        }

        window.handleClearCart = () => {
            cart = [];
            saveCartAndRender();
            showNotification(t('cartCleared'), 'info');
        }

        function saveCartAndRender() {
            localStorage.setItem('khamerCart', JSON.stringify(cart));
            renderCart();
        }
        
        async function handlePlaceOrder() {
            if (cart.length === 0) {
                showNotification(t('emptyCart'), 'error');
                return;
            }
            if (!userId) { // Ensure userId is available (should be from onAuthStateChanged)
                showNotification(t('errorPlacingOrder') + ' (User ID missing)', 'error');
                console.error("Cannot place order: userId is null or undefined.");
                return;
            }
            try {
                const orderData = {
                    userId: userId, 
                    items: cart.map(item => ({ 
                        productId: item.id, 
                        name_en: item.name_en,
                        name_ar: item.name_ar,
                        quantity: item.quantity 
                    })),
                    status: 'pending', 
                    timestamp: Timestamp.now(), 
                };
                await addDoc(collection(db, ordersCollectionPath), orderData);
                cart = []; 
                saveCartAndRender();
                showNotification(t('orderPlacedSuccessfully'), 'success');
            } catch (error) {
                console.error("Error placing order:", error);
                showNotification(t('errorPlacingOrder'), 'error');
            }
        }


        // --- Admin Pages ---
        function showAdminLoginPage() {
            const mainContent = $('#main-content');
             if (!mainContent) return;
            mainContent.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="card p-8 rounded-xl w-full max-w-md">
                        <h2 class="text-3xl font-bold text-center text-primary mb-8">${t('loginToAdmin')}</h2>
                        <form id="admin-login-form" class="space-y-6">
                            <div>
                                <label for="admin-email" class="block text-sm font-medium text-secondary mb-1">${t('email')}</label>
                                <input type="email" id="admin-email" required class="w-full p-3 border border-secondary rounded-lg shadow-sm focus:ring-2 focus:ring-brand-primary input-styled">
                            </div>
                            <div>
                                <label for="admin-password" class="block text-sm font-medium text-secondary mb-1">${t('password')}</label>
                                <input type="password" id="admin-password" required class="w-full p-3 border border-secondary rounded-lg shadow-sm focus:ring-2 focus:ring-brand-primary input-styled">
                            </div>
                            <button type="submit" class="btn btn-primary w-full">
                                ${t('login')}
                            </button>
                        </form>
                    </div>
                </div>
            `;
            $('#admin-login-form')?.addEventListener('submit', handleAdminLogin);
        }

        async function handleAdminLogin(event) {
            event.preventDefault();
            const email = $('#admin-email').value;
            const password = $('#admin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                currentPage = 'adminDashboard';
                showNotification(t('loginSuccess'), 'success');
                // onAuthStateChanged will handle navigation and data fetching for admin
            } catch (err) {
                console.error("Admin login error:", err);
                showNotification(t('loginFailed') + ` (${err.code})`, 'error');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                currentUser = null; 
                // After admin logout, sign in anonymously again for guest user view
                await signInAnonymously(auth); 
                currentPage = 'user';
                showNotification(t('logoutSuccess'), 'info');
                // onAuthStateChanged will trigger navigation and data refresh
            } catch (error) {
                console.error("Logout error:", error);
            }
        }

        function showAdminDashboardPage() {
            const mainContent = $('#main-content');
            if (!mainContent) return;
            mainContent.innerHTML = `
                <div class="container mx-auto">
                    <h2 class="text-3xl font-semibold mb-8 text-primary">${t('adminPanel')} - ${t('dashboard')}</h2>
                    ${userId ? `<p class="mb-4 text-xs text-secondary">${t('userIdLabel')}: ${userId}</p>` : ''}
                    <div class="mb-6 border-b border-primary">
                        <nav id="admin-tabs" class="flex space-x-4 rtl:space-x-reverse" aria-label="Tabs">
                            <button data-tab="products" class="admin-tab-btn px-4 py-2 font-medium text-sm rounded-t-lg">${t('productManagement')}</button>
                            <button data-tab="orders" class="admin-tab-btn px-4 py-2 font-medium text-sm rounded-t-lg">${t('orderManagement')}</button>
                        </nav>
                    </div>
                    <div id="admin-tab-content">
                        <div class="flex items-center justify-center h-32"><div class="spinner"></div> <span class="ml-3 text-lg">${t('loading')}</span></div>
                    </div>
                </div>
            `;
            $$('.admin-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = e.target.dataset.tab;
                    renderAdminTabContent(tabName);
                });
            });
            renderAdminTabContent('products');
        }

        function renderAdminTabContent(tabName) {
            $$('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('bg-brand-primary', 'text-white');
                btn.classList.add('text-secondary', 'hover:bg-accent');
            });
            const activeBtn = $(`.admin-tab-btn[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-brand-primary', 'text-white');
                activeBtn.classList.remove('text-secondary', 'hover:bg-accent');
            }


            const tabContent = $('#admin-tab-content');
            if (!tabContent) return;

            if (tabName === 'products') {
                tabContent.innerHTML = getProductManagementHTML();
                renderAdminProductTable();
                $('#add-new-product-btn')?.addEventListener('click', () => showProductFormModal(null));
                $('#admin-product-search')?.addEventListener('input', (e) => renderAdminProductTable(e.target.value, $('#admin-category-filter').value));
                $('#admin-category-filter')?.addEventListener('change', (e) => renderAdminProductTable($('#admin-product-search').value, e.target.value));

            } else if (tabName === 'orders') {
                tabContent.innerHTML = getOrderManagementHTML();
                renderAdminOrderList();
            }
            lucide.createIcons();
        }
        
        // --- Product Management (Admin) ---
        function getProductManagementHTML() {
            return `
                <div class="card p-6 rounded-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h3 class="text-xl font-semibold text-primary">${t('manageStock')}</h3>
                        <button id="add-new-product-btn" class="btn btn-success">
                            ${createIcon('plus-circle', 'mr-2 rtl:ml-2')} ${t('addNewProduct')}
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="admin-category-filter" class="block text-sm font-medium text-secondary mb-1">${t('filterByCategory')}</label>
                            <select id="admin-category-filter" class="w-full p-2 border border-secondary rounded-lg shadow-sm focus:ring-2 focus:ring-brand-primary input-styled">
                                <option value="all">${t('categoryFilterAll')}</option>
                                <option value="restaurant">${t('restaurant')}</option>
                                <option value="kitchen">${t('kitchen')}</option>
                            </select>
                        </div>
                        <div>
                            <label for="admin-product-search" class="block text-sm font-medium text-secondary mb-1">${t('searchProducts')}</label>
                            <input type="text" id="admin-product-search" placeholder="${t('searchProducts')}" class="w-full p-2 border border-secondary rounded-lg shadow-sm focus:ring-2 focus:ring-brand-primary input-styled">
                        </div>
                    </div>
                    <div id="admin-product-table-container" class="overflow-x-auto">
                        <div class="flex items-center justify-center h-32"><div class="spinner"></div> <span class="ml-3 text-lg">${t('loading')}</span></div>
                    </div>
                </div>
            `;
        }
        
        function renderAdminProductTable(searchTerm = '', categoryFilter = 'all') {
            const container = $('#admin-product-table-container');
            if (!container) return;

            if (productsCache.length === 0 && isAuthReady) {
                container.innerHTML = `<div class="flex items-center justify-center h-32"><div class="spinner"></div> <span class="ml-3 text-lg">${t('loading')}</span></div>`;
                return;
            }
            
            const filtered = productsCache.filter(p => {
                const nameMatch = (currentLanguage === 'ar' ? p.name_ar : p.name_en).toLowerCase().includes(searchTerm.toLowerCase());
                const categoryMatch = categoryFilter === 'all' || p.category === categoryFilter;
                return nameMatch && categoryMatch;
            });
            
            filtered.sort((a, b) => a.name_en.localeCompare(b.name_en));


            if (filtered.length === 0 && productsCache.length > 0) { 
                 container.innerHTML = `<p class="text-center py-4 text-secondary">${t('noProductsFound')}</p>`;
                 return;
            }
             if (productsCache.length === 0 && isAuthReady) { 
                 container.innerHTML = `<p class="text-center py-4 text-secondary">${t('noProducts')}</p>`;
                 return;
            }


            container.innerHTML = `
                <table class="min-w-full divide-y divide-border-primary">
                    <thead class="bg-accent">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">${t('productNameEn')}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">${t('productNameAr')}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">${t('category')}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">${t('stock')}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">${t('lowStockThreshold')}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">${t('actions')}</th>
                        </tr>
                    </thead>
                    <tbody class="bg-primary divide-y divide-border-primary">
                        ${filtered.map(product => {
                            const isLowStock = product.stock <= product.lowStockThreshold;
                            return `
                                <tr class="${isLowStock ? 'bg-red-500/10 dark:bg-red-500/20' : ''}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-primary">${product.name_en}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-primary">${product.name_ar}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${t(product.category)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${isLowStock ? 'text-red-500' : 'text-primary'}">
                                        ${product.stock} ${isLowStock ? createIcon('alert-triangle', 'inline ml-1 rtl:mr-1') : ''}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${product.lowStockThreshold}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2 rtl:space-x-reverse">
                                        <button class="text-brand-primary hover:text-brand-hover" onclick="showProductFormModal('${product.id}')">${createIcon('edit-3')}</button>
                                        <button class="text-red-500 hover:text-red-700" onclick="confirmDeleteProduct('${product.id}')">${createIcon('trash-2')}</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            lucide.createIcons();
        }

        window.showProductFormModal = (productId = null) => {
            const product = productId ? productsCache.find(p => p.id === productId) : null;
            const modalTitle = product ? t('editProduct') : t('addNewProduct');
            const formId = "product-form";

            const formHTML = `
                <form id="${formId}" class="space-y-4">
                    <input type="hidden" name="id" value="${product?.id || ''}">
                    <div>
                        <label for="name_en" class="block text-sm font-medium text-secondary">${t('productNameEn')}</label>
                        <input type="text" name="name_en" id="name_en" value="${product?.name_en || ''}" required class="mt-1 block w-full p-2 border border-secondary rounded-md shadow-sm input-styled">
                    </div>
                    <div>
                        <label for="name_ar" class="block text-sm font-medium text-secondary">${t('productNameAr')}</label>
                        <input type="text" name="name_ar" id="name_ar" value="${product?.name_ar || ''}" required class="mt-1 block w-full p-2 border border-secondary rounded-md shadow-sm input-styled">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-secondary">${t('category')}</label>
                        <select name="category" id="category" class="mt-1 block w-full p-2 border border-secondary rounded-md shadow-sm input-styled">
                            <option value="restaurant" ${product?.category === 'restaurant' ? 'selected' : ''}>${t('restaurant')}</option>
                            <option value="kitchen" ${product?.category === 'kitchen' ? 'selected' : ''}>${t('kitchen')}</option>
                        </select>
                    </div>
                    <div>
                        <label for="stock" class="block text-sm font-medium text-secondary">${t('stock')}</label>
                        <input type="number" name="stock" id="stock" value="${product?.stock || 0}" min="0" required class="mt-1 block w-full p-2 border border-secondary rounded-md shadow-sm input-styled">
                    </div>
                    <div>
                        <label for="lowStockThreshold" class="block text-sm font-medium text-secondary">${t('lowStockThreshold')}</label>
                        <input type="number" name="lowStockThreshold" id="lowStockThreshold" value="${product?.lowStockThreshold || 5}" min="0" required class="mt-1 block w-full p-2 border border-secondary rounded-md shadow-sm input-styled">
                    </div>
                    <div class="flex justify-end space-x-3 rtl:space-x-reverse pt-2">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                        <button type="submit" class="btn btn-primary">${product ? t('updateProduct') : t('saveProduct')}</button>
                    </div>
                </form>
            `;
            openModal(modalTitle, formHTML, false); 
            $(`#${formId}`)?.addEventListener('submit', (e) => handleProductFormSubmit(e, product?.id));
        }

        async function handleProductFormSubmit(event, editingProductId) {
            event.preventDefault();
            const form = event.target;
            const productData = {
                name_en: form.name_en.value.trim(),
                name_ar: form.name_ar.value.trim(),
                category: form.category.value,
                stock: parseInt(form.stock.value),
                lowStockThreshold: parseInt(form.lowStockThreshold.value),
            };

            if (!productData.name_en || !productData.name_ar) {
                showNotification(t('productNameRequired'), 'error');
                return;
            }

            try {
                if (editingProductId) {
                    await updateDoc(doc(db, productsCollectionPath, editingProductId), productData);
                    showNotification(t('productUpdatedSuccess'), 'success');
                } else {
                    await addDoc(collection(db, productsCollectionPath), productData);
                    showNotification(t('productAddedSuccess'), 'success');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving product:", error);
                showNotification(t('errorSavingProduct'), 'error');
            }
        }
        
        window.confirmDeleteProduct = (productId) => {
            openConfirmDialog(
                t('confirmDeleteProductTitle'),
                t('confirmDeleteProductMessage'),
                async () => {
                    try {
                        await deleteDoc(doc(db, productsCollectionPath, productId));
                        showNotification(t('productDeletedSuccess'), 'success');
                    } catch (error) {
                        console.error("Error deleting product:", error);
                        showNotification(t('errorDeletingProduct'), 'error');
                    }
                }
            );
        }

        // --- Order Management (Admin) ---
        function getOrderManagementHTML() {
            return `
                <div class="card p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-6 text-primary">${t('viewOrders')}</h3>
                    <div id="admin-order-list-container" class="space-y-6">
                        <div class="flex items-center justify-center h-32"><div class="spinner"></div> <span class="ml-3 text-lg">${t('loading')}</span></div>
                    </div>
                </div>
            `;
        }

        function renderAdminOrderList() {
            const container = $('#admin-order-list-container');
            if (!container) return;

            if (!ordersCache || ordersCache.length === 0 && isAuthReady) {
                container.innerHTML = `<p class="text-center py-4 text-secondary">${t('noOrders')}</p>`;
                return;
            }
            if (ordersCache.length === 0 && !isAuthReady) { // Still loading
                 container.innerHTML = `<div class="flex items-center justify-center h-32"><div class="spinner"></div> <span class="ml-3 text-lg">${t('loading')}</span></div>`;
                 return;
            }
            
            const sortedOrders = [...ordersCache].sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

            container.innerHTML = sortedOrders.map(order => {
                const orderDate = order.timestamp.toDate();
                const formattedDate = `${orderDate.toLocaleDateString()} ${orderDate.toLocaleTimeString()}`;
                return `
                    <div class="p-4 rounded-lg shadow border ${order.status === 'pending' ? 'bg-yellow-500/10 border-yellow-500/30' : 'bg-green-500/10 border-green-500/30'}">
                        <div class="flex flex-col sm:flex-row justify-between items-start mb-3">
                            <div>
                                <p class="text-sm text-secondary">${t('orderId')}: ${order.id.substring(0,8)}...</p>
                                <p class="text-sm text-secondary">${t('date')}: ${formattedDate}</p>
                                ${order.userId ? `<p class="text-xs text-gray-400 dark:text-gray-500">${t('userIdLabel')}: ${order.userId}</p>` : ''}
                            </div>
                            <span class="mt-2 sm:mt-0 px-3 py-1 text-xs font-semibold rounded-full ${order.status === 'pending' ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800'}">
                                ${t(order.status)}
                            </span>
                        </div>
                        <ul class="space-y-1 mb-3 text-sm text-primary">
                            ${order.items.map(item => `<li>- ${currentLanguage === 'ar' ? item.name_ar : item.name_en}: ${item.quantity} ${t('items')}</li>`).join('')}
                        </ul>
                        ${order.status === 'pending' ? `
                            <button class="btn btn-success btn-sm" onclick="confirmAdminOrder('${order.id}')">
                                ${createIcon('check-circle', 'mr-1 rtl:ml-1')} ${t('confirmOrder')}
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }
        
        window.confirmAdminOrder = (orderId) => {
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;

            openConfirmDialog(
                t('confirmOrderDialogTitle'),
                t('confirmOrderConfirmation'),
                async () => {
                    try {
                        const batch = writeBatch(db);
                        let canConfirmAll = true;
                        let stockUpdateIssues = [];

                        for (const item of order.items) {
                            const productRef = doc(db, productsCollectionPath, item.productId);
                            const productSnap = await getDoc(productRef); 

                            if (productSnap.exists()) {
                                const currentStock = productSnap.data().stock;
                                if (currentStock >= item.quantity) {
                                    batch.update(productRef, { stock: currentStock - item.quantity });
                                } else {
                                    canConfirmAll = false;
                                    stockUpdateIssues.push(`${currentLanguage === 'ar' ? item.name_ar : item.name_en}: ${t('requested')} ${item.quantity}, ${t('available')} ${currentStock}.`);
                                    break; 
                                }
                            } else {
                                canConfirmAll = false; 
                                stockUpdateIssues.push(`${currentLanguage === 'ar' ? item.name_ar : item.name_en}: ${t('productNotFound')}.`);
                                break;
                            }
                        }

                        if (canConfirmAll) {
                            const orderRef = doc(db, ordersCollectionPath, orderId);
                            batch.update(orderRef, { status: 'confirmed' });
                            await batch.commit();
                            showNotification(t('orderConfirmedSuccess'), 'success');
                        } else {
                            const message = `${t('insufficientStock')} ${stockUpdateIssues.join(' ')}`;
                            showNotification(message, 'error');
                        }
                    } catch (error) {
                        console.error("Error confirming order:", error);
                        showNotification(t('errorConfirmingOrder'), 'error');
                    }
                }
            );
        }

        // --- Firestore Data Fetching ---
        let productsUnsubscribe = null;
        let ordersUnsubscribe = null;

        function fetchProducts() {
            if (productsUnsubscribe) productsUnsubscribe(); 

            const productsQuery = query(collection(db, productsCollectionPath));
            productsUnsubscribe = onSnapshot(productsQuery, (snapshot) => {
                productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Products fetched/updated:", productsCache.length);
                if (currentPage === 'user') renderProductSections($('#search-products-user')?.value || '');
                if (currentPage === 'adminDashboard' && $('#admin-tab-content')) { 
                     const activeTab = $('.admin-tab-btn.bg-brand-primary')?.dataset.tab;
                     if(activeTab === 'products') renderAdminProductTable($('#admin-product-search')?.value || '', $('#admin-category-filter')?.value || 'all');
                }
                renderCart(); 
            }, (error) => {
                console.error("Error fetching products:", error);
                showNotification(t('errorFetchingProducts'), 'error');
                if (currentPage === 'user') $('#product-display-area').innerHTML = `<p class="text-red-500 text-center">${t('errorFetchingProducts')}</p>`;
                if (currentPage === 'adminDashboard' && $('.admin-tab-btn.bg-brand-primary')?.dataset.tab === 'products') {
                     $('#admin-product-table-container').innerHTML = `<p class="text-red-500 text-center">${t('errorFetchingProducts')}</p>`;
                }
            });
        }

        function fetchOrders() {
            if (ordersUnsubscribe) ordersUnsubscribe(); 

            const ordersQuery = query(collection(db, ordersCollectionPath)); 
            ordersUnsubscribe = onSnapshot(ordersQuery, (snapshot) => {
                ordersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 console.log("Orders fetched/updated:", ordersCache.length);
                if (currentPage === 'adminDashboard' && $('#admin-tab-content')) {
                     const activeTab = $('.admin-tab-btn.bg-brand-primary')?.dataset.tab;
                     if(activeTab === 'orders') renderAdminOrderList();
                }
            }, (error) => {
                console.error("Error fetching orders:", error);
                showNotification(t('errorFetchingOrders'), 'error');
                 if (currentPage === 'adminDashboard' && $('.admin-tab-btn.bg-brand-primary')?.dataset.tab === 'orders') {
                     $('#admin-order-list-container').innerHTML = `<p class="text-red-500 text-center">${t('errorFetchingOrders')}</p>`;
                }
            });
        }
        
        // --- Modals and Notifications ---
        function openModal(title, contentHTML, showCloseButton = true) {
            const placeholder = $('#modal-placeholder');
            if (!placeholder) return;
            
            placeholder.innerHTML = `
                <div id="app-modal-overlay" class="modal-overlay">
                    <div class="modal-container">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-primary">${title}</h3>
                            ${showCloseButton ? `<button onclick="closeModal()" class="p-1 text-secondary hover:text-primary">${createIcon('x')}</button>` : ''}
                        </div>
                        <div>${contentHTML}</div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            
            const modal = placeholder.querySelector('.modal-container');
            const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            const focusableContent = Array.from(modal.querySelectorAll(focusableElements));
            const firstFocusableElement = focusableContent[0];
            const lastFocusableElement = focusableContent[focusableContent.length - 1];

            const trapTabKey = (e) => {
                if (!modal.contains(document.activeElement)) { // If focus is outside modal, bring it back
                    firstFocusableElement?.focus();
                }
                if (e.key !== 'Tab') return;

                if (e.shiftKey) { 
                    if (document.activeElement === firstFocusableElement) {
                        lastFocusableElement?.focus();
                        e.preventDefault();
                    }
                } else { 
                    if (document.activeElement === lastFocusableElement) {
                        firstFocusableElement?.focus();
                        e.preventDefault();
                    }
                }
            };
            document.addEventListener('keydown', trapTabKey);
            
            // Store the listener to remove it later
            modal.dataset.tabKeyListener = trapTabKey.toString(); // Not ideal, but simple way to reference for removal


            if(firstFocusableElement) firstFocusableElement.focus();

            $('#app-modal-overlay').addEventListener('click', function(e) {
                if (e.target === this) { 
                    closeModal();
                }
            });
        }

        window.closeModal = () => { 
            const placeholder = $('#modal-placeholder');
            const modal = placeholder.querySelector('.modal-container');
            if (modal && modal.dataset.tabKeyListener) {
                // This is tricky as the function is recreated. A more robust way is needed if many modals.
                // For now, this won't remove the specific instance of trapTabKey.
                // A better approach would be to name the function and remove it by name,
                // or attach it to the modal element itself.
                // document.removeEventListener('keydown', ???); // How to get the exact function reference?
            }
            if (placeholder) placeholder.innerHTML = '';
        }

        function openConfirmDialog(title, message, onConfirmCallback) {
            const dialogId = `confirm-dialog-${Date.now()}`;
            const contentHTML = `
                <p class="text-secondary mb-6">${message}</p>
                <div class="flex justify-end space-x-3 rtl:space-x-reverse">
                    <button id="confirm-cancel-${dialogId}" class="btn btn-secondary">${t('cancel')}</button>
                    <button id="confirm-action-${dialogId}" class="btn btn-primary">${t('confirm')}</button>
                </div>
            `;
            openModal(title, contentHTML, false); 
            $(`#confirm-cancel-${dialogId}`)?.addEventListener('click', closeModal);
            $(`#confirm-action-${dialogId}`)?.addEventListener('click', () => {
                onConfirmCallback();
                closeModal();
            });
        }

        let notificationTimeout;
        function showNotification(message, type = 'info') { 
            const banner = $('#notification-banner');
            const messageSpan = $('#notification-message');
            if (!banner || !messageSpan) return;

            messageSpan.textContent = message;
            banner.className = ''; 
            banner.classList.add('show', type);

            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                banner.classList.remove('show');
            }, 4000); 
        }

    </script>
</body>
</html>