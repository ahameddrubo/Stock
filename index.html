<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ইকমার্স প্ল্যাটফর্ম</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase SDK আমদানি
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            getDocs, 
            updateDoc, 
            query, 
            where,
            onSnapshot,
            setDoc,
            getDoc,
            writeBatch,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase কনফিগারেশন (নিরাপত্তার জন্য এটি আপনার নিজের Firebase প্রকল্প থেকে নিন)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", // প্রয়োজন হলে আপনার API কী এখানে যোগ করুন
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ecommerce-app';
        let userId = null; // ব্যবহারকারীর আইডি সংরক্ষণ করার জন্য
        let productsCache = []; // পণ্য ক্যাশে করার জন্য

        // --- UI উপাদান ---
        const productListDiv = document.getElementById('productList');
        const cartItemsDiv = document.getElementById('cartItems');
        const cartTotalSpan = document.getElementById('cartTotal');
        const placeOrderButton = document.getElementById('placeOrderButton');
        const myOrdersDiv = document.getElementById('myOrders');
        const adminOrdersDiv = document.getElementById('adminOrders');
        const userView = document.getElementById('userView');
        const adminView = document.getElementById('adminView');
        const switchToAdminButton = document.getElementById('switchToAdminButton');
        const switchToUserButton = document.getElementById('switchToUserButton');
        const notificationDiv = document.getElementById('notification');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const currentUserIdSpan = document.getElementById('currentUserId');


        let cart = []; // শপিং কার্ট

        // --- লোডিং ইন্ডিকেটর ---
        function showLoading(message = "লোড হচ্ছে...") {
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.textContent = message;
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        // --- বিজ্ঞপ্তি দেখানো ---
        function showNotification(message, type = 'success') {
            notificationDiv.textContent = message;
            notificationDiv.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'text-white');
            if (type === 'success') {
                notificationDiv.classList.add('bg-green-500', 'text-white');
            } else {
                notificationDiv.classList.add('bg-red-500', 'text-white');
            }
            setTimeout(() => {
                notificationDiv.classList.add('hidden');
            }, 3000);
        }
        
        // --- ফায়ারবেস প্রমাণীকরণ ---
        async function initializeAuth() {
            showLoading("প্রমাণীকরণ হচ্ছে...");
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("প্রমাণীকরণ ত্রুটি:", error);
                showNotification("প্রমাণীকরণে সমস্যা হয়েছে।", "error");
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    currentUserIdSpan.textContent = `ব্যবহারকারী আইডি: ${userId}`;
                    console.log("ব্যবহারকারী লগইন করেছে:", userId);
                    await loadInitialData();
                    setupRealtimeListeners();
                    hideLoading();
                } else {
                    userId = null;
                    currentUserIdSpan.textContent = "কোন ব্যবহারকারী লগইন করেনি";
                    console.log("ব্যবহারকারী লগআউট করেছে বা লগইন করেনি");
                    // লগইন না থাকলে কিছু UI উপাদান নিষ্ক্রিয় করা যেতে পারে
                    hideLoading();
                }
            });
        }


        // --- প্রাথমিক ডেটা লোড এবং রিয়েলটাইম লিসেনার সেটআপ ---
        async function loadInitialData() {
            if (!userId) return;
            showLoading("পণ্য লোড হচ্ছে...");
            await loadProducts();
            await loadCartFromFirestore(); // Firestore থেকে কার্ট লোড করুন
            loadMyOrders();
            if (adminView.style.display !== 'none') { // যদি অ্যাডমিন ভিউ দৃশ্যমান থাকে
                loadAdminOrders();
            }
            hideLoading();
        }
        
        function setupRealtimeListeners() {
            if (!userId) return;

            // পণ্যের রিয়েলটাইম আপডেট
            const productsCollectionPath = `artifacts/${appId}/public/data/products`;
            const productsQuery = collection(db, productsCollectionPath);
            onSnapshot(productsQuery, (snapshot) => {
                productsCache = [];
                snapshot.forEach(doc => productsCache.push({ id: doc.id, ...doc.data() }));
                renderProducts();
                renderCart(); // পণ্য আপডেট হলে কার্ট পুনরায় রেন্ডার করুন
            }, (error) => {
                console.error("পণ্য শুনতে ত্রুটি:", error);
                showNotification("পণ্য লোড করতে সমস্যা হচ্ছে।", "error");
            });

            // ব্যবহারকারীর অর্ডারের রিয়েলটাইম আপডেট
            const userOrdersCollectionPath = `artifacts/${appId}/users/${userId}/orders`;
            const userOrdersQuery = query(collection(db, userOrdersCollectionPath));
            onSnapshot(userOrdersQuery, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
                renderMyOrders(orders);
            }, (error) => {
                console.error("আমার অর্ডার শুনতে ত্রুটি:", error);
            });

            // অ্যাডমিন অর্ডারের রিয়েলটাইম আপডেট (যদি অ্যাডমিন ভিউ সক্রিয় থাকে)
            if (adminView.style.display !== 'none') {
                 const adminOrdersCollectionPath = `artifacts/${appId}/public/data/orders`;
                 const adminOrdersQuery = query(collection(db, adminOrdersCollectionPath), where("status", "==", "pending"));
                 onSnapshot(adminOrdersQuery, (snapshot) => {
                    const orders = [];
                    snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
                    renderAdminOrders(orders);
                }, (error) => {
                    console.error("অ্যাডমিন অর্ডার শুনতে ত্রুটি:", error);
                });
            }
        }


        // --- পণ্য লোড এবং প্রদর্শন ---
        async function loadProducts() {
            if (!userId) return;
            const productsCollectionPath = `artifacts/${appId}/public/data/products`;
            try {
                const querySnapshot = await getDocs(collection(db, productsCollectionPath));
                productsCache = [];
                querySnapshot.forEach((doc) => {
                    productsCache.push({ id: doc.id, ...doc.data() });
                });
                renderProducts();
                // প্রাথমিক পণ্য যোগ করুন যদি সংগ্রহ খালি থাকে (একবার চালানোর জন্য)
                if (productsCache.length === 0) {
                    await addInitialProducts();
                    await loadProducts(); // পণ্য পুনরায় লোড করুন
                }
            } catch (error) {
                console.error("পণ্য লোড করতে ত্রুটি: ", error);
                showNotification("পণ্য লোড করতে সমস্যা হচ্ছে।", "error");
            }
        }
        
        // --- প্রাথমিক পণ্য যোগ করা (যদি ডেটাবেসে না থাকে) ---
        async function addInitialProducts() {
            if (!userId) return;
            const productsCollectionPath = `artifacts/${appId}/public/data/products`;
            const initialProducts = [
                { name: "আম", category: "ফল", price: 120, stock: 50, imageUrl: "https://placehold.co/100x100/FFC107/000000?text=আম" },
                { name: "জাম", category: "ফল", price: 80, stock: 30, imageUrl: "https://placehold.co/100x100/7E57C2/FFFFFF?text=জাম" },
                { name: "লিচু", category: "ফল", price: 250, stock: 60, imageUrl: "https://placehold.co/100x100/F06292/FFFFFF?text=লিচু" },
                { name: "তরমুজ", category: "ফল", price: 100, stock: 20, imageUrl: "https://placehold.co/100x100/4CAF50/FFFFFF?text=তরমুজ" },
            ];
            try {
                for (const product of initialProducts) {
                    await addDoc(collection(db, productsCollectionPath), product);
                }
                console.log("প্রাথমিক পণ্য যোগ করা হয়েছে");
            } catch (error) {
                console.error("প্রাথমিক পণ্য যোগ করতে ত্রুটি: ", error);
            }
        }

        function renderProducts() {
            productListDiv.innerHTML = '';
            if (productsCache.length === 0) {
                productListDiv.innerHTML = '<p class="text-gray-500">কোনো পণ্য পাওয়া যায়নি।</p>';
                return;
            }
            productsCache.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'p-4 border rounded-lg shadow-md bg-white';
                productDiv.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-32 object-cover rounded-md mb-2" onerror="this.onerror=null;this.src='https://placehold.co/100x100/CCCCCC/000000?text=ছবি+নেই';">
                    <h3 class="text-xl font-semibold">${product.name}</h3>
                    <p class="text-gray-600">বিভাগ: ${product.category}</p>
                    <p class="text-gray-800 font-bold">মূল্য: ${product.price} টাকা</p>
                    <p class="text-sm ${product.stock > 0 ? 'text-green-600' : 'text-red-600'}">
                        স্টক: ${product.stock > 0 ? product.stock + ' টি উপলব্ধ' : 'স্টক নেই'}
                    </p>
                    <button 
                        data-id="${product.id}" 
                        class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out ${product.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${product.stock === 0 ? 'disabled' : ''}>
                        কার্টে যোগ করুন
                    </button>
                `;
                productListDiv.appendChild(productDiv);

                if (product.stock > 0) {
                    productDiv.querySelector('button').addEventListener('click', () => addToCart(product.id));
                }
            });
        }

        // --- কার্ট পরিচালনা ---
        async function loadCartFromFirestore() {
            if (!userId) return;
            const cartDocPath = `artifacts/${appId}/users/${userId}/cart/userCart`;
            try {
                const docSnap = await getDoc(doc(db, cartDocPath));
                if (docSnap.exists()) {
                    cart = docSnap.data().items || [];
                } else {
                    cart = [];
                }
                renderCart();
            } catch (error) {
                console.error("Firestore থেকে কার্ট লোড করতে ত্রুটি: ", error);
                cart = []; // ত্রুটির ক্ষেত্রে স্থানীয় কার্ট খালি করুন
                renderCart();
            }
        }

        async function saveCartToFirestore() {
            if (!userId) return;
            const cartDocPath = `artifacts/${appId}/users/${userId}/cart/userCart`;
            try {
                await setDoc(doc(db, cartDocPath), { items: cart });
            } catch (error) {
                console.error("Firestore এ কার্ট সংরক্ষণ করতে ত্রুটি: ", error);
                showNotification("কার্ট সংরক্ষণ করা যায়নি।", "error");
            }
        }


        function addToCart(productId) {
            const product = productsCache.find(p => p.id === productId);
            if (!product || product.stock === 0) {
                showNotification("এই পণ্যটি স্টক নেই!", "error");
                return;
            }

            const cartItem = cart.find(item => item.productId === productId);
            if (cartItem) {
                if (cartItem.quantity < product.stock) {
                    cartItem.quantity++;
                } else {
                    showNotification("স্টকের চেয়ে বেশি যোগ করা যাবে না।", "error");
                }
            } else {
                cart.push({ productId: product.id, name: product.name, price: product.price, quantity: 1 });
            }
            renderCart();
            saveCartToFirestore();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            renderCart();
            saveCartToFirestore();
        }

        function updateQuantity(productId, change) {
            const cartItem = cart.find(item => item.productId === productId);
            const product = productsCache.find(p => p.id === cartItem.productId);

            if (cartItem && product) {
                const newQuantity = cartItem.quantity + change;
                if (newQuantity > 0 && newQuantity <= product.stock) {
                    cartItem.quantity = newQuantity;
                } else if (newQuantity > product.stock) {
                    showNotification("স্টকের চেয়ে বেশি যোগ করা যাবে না।", "error");
                } else { // newQuantity <= 0
                    removeFromCart(productId);
                    return; // রেন্ডার কার্ট এবং সেভ কার্ট রিমুভ ফ্রম কার্টে কল করা হয়েছে
                }
            }
            renderCart();
            saveCartToFirestore();
        }

        function renderCart() {
            cartItemsDiv.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = '<p class="text-gray-500">আপনার কার্ট খালি।</p>';
                cartTotalSpan.textContent = '0';
                placeOrderButton.disabled = true;
                placeOrderButton.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            cart.forEach(item => {
                const cartItemDiv = document.createElement('div');
                cartItemDiv.className = 'flex justify-between items-center p-2 border-b';
                cartItemDiv.innerHTML = `
                    <div>
                        <h4 class="font-semibold">${item.name}</h4>
                        <p class="text-sm text-gray-600">মূল্য: ${item.price} টাকা</p>
                        <div class="flex items-center mt-1">
                            <button data-id="${item.productId}" data-change="-1" class="quantity-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-2 rounded-l">-</button>
                            <span class="px-3 py-1 bg-gray-100">${item.quantity}</span>
                            <button data-id="${item.productId}" data-change="1" class="quantity-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-2 rounded-r">+</button>
                        </div>
                    </div>
                    <button data-id="${item.productId}" class="remove-btn text-red-500 hover:text-red-700 font-semibold">সরান</button>
                `;
                cartItemsDiv.appendChild(cartItemDiv);
                total += item.price * item.quantity;
            });

            cartTotalSpan.textContent = total.toFixed(2);
            placeOrderButton.disabled = false;
            placeOrderButton.classList.remove('opacity-50', 'cursor-not-allowed');

            // ইভেন্ট লিসেনার যোগ করা
            cartItemsDiv.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const productId = button.dataset.id;
                    const change = parseInt(button.dataset.change);
                    updateQuantity(productId, change);
                });
            });
            cartItemsDiv.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const productId = button.dataset.id;
                    removeFromCart(productId);
                });
            });
        }

        // --- অর্ডার প্লেস করা ---
        placeOrderButton.addEventListener('click', async () => {
            if (!userId) {
                showNotification("অর্ডার করার জন্য অনুগ্রহ করে লগইন করুন।", "error");
                return;
            }
            if (cart.length === 0) {
                showNotification("আপনার কার্ট খালি। অর্ডার করার জন্য পণ্য যোগ করুন।", "error");
                return;
            }

            showLoading("অর্ডার প্রক্রিয়া করা হচ্ছে...");

            const orderItems = cart.map(item => ({
                productId: item.productId,
                productName: item.name,
                quantity: item.quantity,
                price: item.price
            }));
            const totalAmount = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            try {
                // ব্যবহারকারীর জন্য অর্ডার ডেটাবেসে সংরক্ষণ
                const userOrderCollectionPath = `artifacts/${appId}/users/${userId}/orders`;
                const userOrderRef = await addDoc(collection(db, userOrderCollectionPath), {
                    userId: userId,
                    items: orderItems,
                    totalAmount: totalAmount,
                    status: 'pending', // প্রাথমিক স্ট্যাটাস 'pending'
                    orderDate: serverTimestamp() 
                });

                // অ্যাডমিনের জন্য পাবলিক অর্ডার ডেটাবেসে সংরক্ষণ
                const publicOrderCollectionPath = `artifacts/${appId}/public/data/orders`;
                await setDoc(doc(db, publicOrderCollectionPath, userOrderRef.id), { // একই আইডি ব্যবহার করুন
                    userId: userId,
                    originalOrderId: userOrderRef.id, // ব্যবহারকারীর অর্ডারের আইডি সংরক্ষণ করুন
                    items: orderItems,
                    totalAmount: totalAmount,
                    status: 'pending', 
                    orderDate: serverTimestamp() 
                });

                cart = []; // কার্ট খালি করুন
                renderCart();
                saveCartToFirestore(); // খালি কার্ট Firestore এ সংরক্ষণ করুন
                showNotification("আপনার অর্ডার সফলভাবে প্লেস হয়েছে!", "success");
                loadMyOrders(); // আমার অর্ডার তালিকা রিফ্রেশ করুন
            } catch (error) {
                console.error("অর্ডার প্লেস করতে ত্রুটি: ", error);
                showNotification("দুঃখিত, অর্ডার প্লেস করা যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন।", "error");
            } finally {
                hideLoading();
            }
        });
        
        // --- আমার অর্ডার দেখানো ---
        async function loadMyOrders() {
            if (!userId) return;
            myOrdersDiv.innerHTML = '<p class="text-gray-400">লোড হচ্ছে...</p>';
            const ordersCollectionPath = `artifacts/${appId}/users/${userId}/orders`;
            try {
                const q = query(collection(db, ordersCollectionPath)); // এখানে orderby যোগ করা যাবে না
                const querySnapshot = await getDocs(q);
                const orders = [];
                querySnapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                // ক্লায়েন্ট সাইডে তারিখ অনুযায়ী সর্ট করুন
                orders.sort((a, b) => (b.orderDate && a.orderDate) ? b.orderDate.toDate() - a.orderDate.toDate() : 0);
                renderMyOrders(orders);
            } catch (error) {
                console.error("আমার অর্ডার লোড করতে ত্রুটি: ", error);
                myOrdersDiv.innerHTML = '<p class="text-red-500">অর্ডার লোড করা যায়নি।</p>';
            }
        }

        function renderMyOrders(orders) {
            myOrdersDiv.innerHTML = '';
            if (orders.length === 0) {
                myOrdersDiv.innerHTML = '<p class="text-gray-500">আপনার কোনো অর্ডার নেই।</p>';
                return;
            }
            orders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'p-4 border rounded-lg shadow-sm bg-white mb-3';
                let itemsHtml = order.items.map(item => `<li>${item.productName} (x${item.quantity}) - ${item.price * item.quantity} টাকা</li>`).join('');
                
                let statusText = '';
                let statusColor = '';
                switch(order.status) {
                    case 'pending': statusText = 'বিচারাধীন'; statusColor = 'text-yellow-600'; break;
                    case 'delivered': statusText = 'ডেলিভার্ড'; statusColor = 'text-green-600'; break;
                    case 'cancelled': statusText = 'বাতিল'; statusColor = 'text-red-600'; break;
                    default: statusText = order.status; statusColor = 'text-gray-600';
                }

                orderDiv.innerHTML = `
                    <h4 class="text-lg font-semibold">অর্ডার আইডি: ${order.id.substring(0,8)}...</h4>
                    <p class="text-sm text-gray-500">তারিখ: ${order.orderDate ? new Date(order.orderDate.toDate()).toLocaleString('bn-BD') : 'N/A'}</p>
                    <p class="font-medium ${statusColor}">স্ট্যাটাস: ${statusText}</p>
                    <ul class="list-disc list-inside text-sm text-gray-700 mt-1 mb-2">
                        ${itemsHtml}
                    </ul>
                    <p class="font-semibold">মোট পরিমাণ: ${order.totalAmount.toFixed(2)} টাকা</p>
                `;
                myOrdersDiv.appendChild(orderDiv);
            });
        }

        // --- অ্যাডমিন কার্যক্রম ---
        async function loadAdminOrders() {
            if (!userId) return; // অ্যাডমিন কার্যক্রমের জন্য ব্যবহারকারী লগইন থাকা আবশ্যক
            adminOrdersDiv.innerHTML = '<p class="text-gray-400">লোড হচ্ছে...</p>';
            const ordersCollectionPath = `artifacts/${appId}/public/data/orders`;
            try {
                // শুধুমাত্র 'pending' স্ট্যাটাসের অর্ডারগুলো আনুন
                const q = query(collection(db, ordersCollectionPath), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                const orders = [];
                querySnapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                 // ক্লায়েন্ট সাইডে তারিখ অনুযায়ী সর্ট করুন
                orders.sort((a, b) => (a.orderDate && b.orderDate) ? a.orderDate.toDate() - b.orderDate.toDate() : 0);
                renderAdminOrders(orders);
            } catch (error) {
                console.error("অ্যাডমিন অর্ডার লোড করতে ত্রুটি: ", error);
                adminOrdersDiv.innerHTML = '<p class="text-red-500">অর্ডার লোড করা যায়নি।</p>';
            }
        }

        function renderAdminOrders(orders) {
            adminOrdersDiv.innerHTML = '';
            if (orders.length === 0) {
                adminOrdersDiv.innerHTML = '<p class="text-gray-500">কোনো বিচারাধীন অর্ডার নেই।</p>';
                return;
            }
            orders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'p-4 border rounded-lg shadow-sm bg-white mb-3';
                let itemsHtml = order.items.map(item => `<li>${item.productName} (x${item.quantity})</li>`).join('');
                orderDiv.innerHTML = `
                    <h4 class="text-lg font-semibold">অর্ডার আইডি: ${order.id.substring(0,8)}...</h4>
                    <p class="text-sm text-gray-500">ব্যবহারকারী আইডি: ${order.userId.substring(0,8)}...</p>
                    <p class="text-sm text-gray-500">তারিখ: ${order.orderDate ? new Date(order.orderDate.toDate()).toLocaleString('bn-BD') : 'N/A'}</p>
                    <ul class="list-disc list-inside text-sm text-gray-700 mt-1 mb-2">
                        ${itemsHtml}
                    </ul>
                    <p class="font-semibold">মোট পরিমাণ: ${order.totalAmount.toFixed(2)} টাকা</p>
                    <button data-id="${order.id}" class="mark-delivered-btn mt-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                        ডেলিভার্ড হিসেবে চিহ্নিত করুন
                    </button>
                     <button data-id="${order.id}" class="cancel-order-btn mt-2 ml-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                        অর্ডার বাতিল করুন
                    </button>
                `;
                adminOrdersDiv.appendChild(orderDiv);
            });

            adminOrdersDiv.querySelectorAll('.mark-delivered-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const orderId = button.dataset.id;
                    await markOrderAsDelivered(orderId);
                });
            });
            adminOrdersDiv.querySelectorAll('.cancel-order-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const orderId = button.dataset.id;
                    await cancelOrder(orderId);
                });
            });
        }

        async function markOrderAsDelivered(orderId) {
            if (!userId) return;
            showLoading("অর্ডার আপডেট করা হচ্ছে...");
            const publicOrderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
            
            try {
                const publicOrderSnap = await getDoc(publicOrderRef);
                if (!publicOrderSnap.exists()) {
                    showNotification("অর্ডার খুঁজে পাওয়া যায়নি।", "error");
                    hideLoading();
                    return;
                }
                const orderData = publicOrderSnap.data();
                const userOrderRef = doc(db, `artifacts/${appId}/users/${orderData.userId}/orders`, orderData.originalOrderId);

                // স্টক আপডেটের জন্য একটি ব্যাচ তৈরি করুন
                const batch = writeBatch(db);

                // পণ্যের স্টক আপডেট করুন
                for (const item of orderData.items) {
                    const productRef = doc(db, `artifacts/${appId}/public/data/products`, item.productId);
                    const productSnap = await getDoc(productRef);
                    if (productSnap.exists()) {
                        const currentStock = productSnap.data().stock;
                        const newStock = currentStock - item.quantity;
                        if (newStock < 0) {
                            showNotification(`"${item.productName}" এর পর্যাপ্ত স্টক নেই। ডেলিভারি সম্ভব নয়।`, "error");
                            hideLoading();
                            return; // একটি পণ্যের স্টক না থাকলে পুরো অপারেশন বাতিল করুন
                        }
                        batch.update(productRef, { stock: newStock });
                    } else {
                         showNotification(`পণ্য "${item.productName}" খুঁজে পাওয়া যায়নি।`, "error");
                         hideLoading();
                         return;
                    }
                }

                // অর্ডারের স্ট্যাটাস আপডেট করুন
                batch.update(publicOrderRef, { status: 'delivered' });
                batch.update(userOrderRef, { status: 'delivered' });

                await batch.commit(); // ব্যাচ কমিট করুন

                showNotification("অর্ডার সফলভাবে ডেলিভার্ড হিসেবে চিহ্নিত হয়েছে এবং স্টক আপডেট করা হয়েছে!", "success");
                loadAdminOrders(); // অ্যাডমিন অর্ডার তালিকা রিফ্রেশ করুন
                loadMyOrders(); // ব্যবহারকারীর অর্ডার তালিকাও রিফ্রেশ হতে পারে
                loadProducts(); // পণ্যের তালিকা রিফ্রেশ করুন (স্টক দেখানোর জন্য)
            } catch (error) {
                console.error("অর্ডার ডেলিভার্ড হিসেবে চিহ্নিত করতে ত্রুটি: ", error);
                showNotification("অর্ডার ডেলিভার্ড হিসেবে চিহ্নিত করা যায়নি।", "error");
            } finally {
                hideLoading();
            }
        }
        
        async function cancelOrder(orderId) {
            if (!userId) return;
            showLoading("অর্ডার বাতিল করা হচ্ছে...");
            const publicOrderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
            try {
                const publicOrderSnap = await getDoc(publicOrderRef);
                if (!publicOrderSnap.exists()) {
                    showNotification("অর্ডার খুঁজে পাওয়া যায়নি।", "error");
                    hideLoading();
                    return;
                }
                const orderData = publicOrderSnap.data();
                const userOrderRef = doc(db, `artifacts/${appId}/users/${orderData.userId}/orders`, orderData.originalOrderId);

                const batch = writeBatch(db);
                batch.update(publicOrderRef, { status: 'cancelled' });
                batch.update(userOrderRef, { status: 'cancelled' });
                await batch.commit();

                showNotification("অর্ডার সফলভাবে বাতিল করা হয়েছে!", "success");
                loadAdminOrders();
                loadMyOrders();
            } catch (error) {
                console.error("অর্ডার বাতিল করতে ত্রুটি: ", error);
                showNotification("অর্ডার বাতিল করা যায়নি।", "error");
            } finally {
                hideLoading();
            }
        }


        // --- ভিউ পরিবর্তন ---
        switchToAdminButton.addEventListener('click', () => {
            userView.style.display = 'none';
            adminView.style.display = 'block';
            loadAdminOrders(); // অ্যাডমিন ভিউতে যাওয়ার সময় অর্ডার লোড করুন
            setupRealtimeListenersForAdmin(); // অ্যাডমিন অর্ডারের জন্য রিয়েলটাইম লিসেনার সেটআপ
        });

        switchToUserButton.addEventListener('click', () => {
            adminView.style.display = 'none';
            userView.style.display = 'block';
            // ব্যবহারকারী ভিউতে ফিরে আসার সময় ডেটা পুনরায় লোড করার প্রয়োজন হতে পারে
            loadProducts();
            loadCartFromFirestore();
            loadMyOrders();
        });
        
        function setupRealtimeListenersForAdmin() {
            if (!userId || adminView.style.display === 'none') return;

            const adminOrdersCollectionPath = `artifacts/${appId}/public/data/orders`;
            // শুধুমাত্র 'pending' স্ট্যাটাসের অর্ডারগুলো শুনুন
            const adminOrdersQuery = query(collection(db, adminOrdersCollectionPath), where("status", "==", "pending"));
            
            // আগের লিসেনার (যদি থাকে) বন্ধ করুন
            if (window.adminOrderListenerUnsubscribe) {
                window.adminOrderListenerUnsubscribe();
            }

            window.adminOrderListenerUnsubscribe = onSnapshot(adminOrdersQuery, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
                // ক্লায়েন্ট সাইডে তারিখ অনুযায়ী সর্ট করুন
                orders.sort((a, b) => (a.orderDate && b.orderDate) ? a.orderDate.toDate() - b.orderDate.toDate() : 0);
                renderAdminOrders(orders);
            }, (error) => {
                console.error("অ্যাডমিন অর্ডার শুনতে ত্রুটি:", error);
                showNotification("অ্যাডমিন অর্ডার লোড করতে সমস্যা হচ্ছে।", "error");
            });
        }


        // --- প্রাথমিক সূচনা ---
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAuth(); // প্রমাণীকরণ শুরু করুন
            // ডিফল্টভাবে ব্যবহারকারী ভিউ দেখানো হবে
            userView.style.display = 'block';
            adminView.style.display = 'none';
        });

    </script>
    <style>
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #f0f2f5; /* হালকা ধূসর ব্যাকগ্রাউন্ড */
        }
        /* কাস্টম স্ক্রলবার (অপশনাল) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab-button.active {
            background-color: #3b82f6; /* নীল */
            color: white;
        }
        .tab-button:not(.active) {
            background-color: #e5e7eb; /* হালকা ধূসর */
            color: #374151; /* গাঢ় ধূসর */
        }
        #mainContent > div { /* ট্যাব কন্টেন্ট */
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quantity-btn, .remove-btn, #placeOrderButton, .mark-delivered-btn, .cancel-order-btn {
            transition: transform 0.1s ease-in-out;
        }
        .quantity-btn:active, .remove-btn:active, #placeOrderButton:active, .mark-delivered-btn:active, .cancel-order-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xl z-50">
        লোড হচ্ছে...
    </div>

    <div id="notification" class="hidden fixed top-5 right-5 p-3 rounded-lg text-white shadow-lg z-50">
        বিজ্ঞপ্তি বার্তা
    </div>
    
    <p id="currentUserId" class="text-xs text-gray-500 p-2 text-center bg-gray-200"></p>


    <div class="container mx-auto p-4 max-w-4xl">
        <header class="mb-6 text-center">
            <h1 class="text-4xl font-bold text-blue-600">ইকমার্স প্ল্যাটফর্ম</h1>
            <div class="mt-4 flex justify-center space-x-2">
                <button id="switchToUserButton" class="tab-button active">ব্যবহারকারী</button>
                <button id="switchToAdminButton" class="tab-button">অ্যাডমিন</button>
            </div>
        </header>

        <div id="userView">
            <div class="mb-6 flex justify-center border-b">
                <button onclick="showTab('productsTab')" class="user-tab-button py-2 px-4 text-blue-600 border-b-2 border-blue-600 font-semibold">পণ্যসমূহ</button>
                <button onclick="showTab('cartTab')" class="user-tab-button py-2 px-4 text-gray-500 hover:text-blue-600">শপিং কার্ট</button>
                <button onclick="showTab('ordersTab')" class="user-tab-button py-2 px-4 text-gray-500 hover:text-blue-600">আমার অর্ডার</button>
            </div>

            <div id="mainContent">
                <div id="productsTab" class="user-tab-content">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">উপলব্ধ পণ্য</h2>
                    <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                        </div>
                </div>

                <div id="cartTab" class="user-tab-content hidden">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">আপনার শপিং কার্ট</h2>
                    <div id="cartItems" class="bg-white p-6 rounded-lg shadow-md mb-4">
                        </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xl font-semibold text-gray-700">মোট:</span>
                            <span id="cartTotal" class="text-xl font-bold text-blue-600">0</span> টাকা
                        </div>
                        <button id="placeOrderButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out opacity-50 cursor-not-allowed" disabled>
                            অর্ডার করুন
                        </button>
                    </div>
                </div>

                <div id="ordersTab" class="user-tab-content hidden">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">আমার অর্ডারসমূহ</h2>
                    <div id="myOrders">
                        </div>
                </div>
            </div>
        </div>

        <div id="adminView" style="display: none;">
            <h2 class="text-2xl font-semibold mb-6 text-center text-gray-700">অ্যাডমিন প্যানেল - বিচারাধীন অর্ডার</h2>
            <div id="adminOrders" class="space-y-4">
                </div>
        </div>
    </div>

    <script>
        // ট্যাব পরিবর্তন ফাংশন
        let currentTab = 'productsTab';
        const userTabButtons = document.querySelectorAll('.user-tab-button');
        const userTabContents = document.querySelectorAll('.user-tab-content');

        function showTab(tabId) {
            userTabContents.forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');

            userTabButtons.forEach(button => {
                button.classList.remove('text-blue-600', 'border-blue-600', 'font-semibold');
                button.classList.add('text-gray-500', 'hover:text-blue-600');
            });
            const activeButton = Array.from(userTabButtons).find(btn => btn.getAttribute('onclick').includes(tabId));
            if (activeButton) {
                activeButton.classList.add('text-blue-600', 'border-blue-600', 'font-semibold');
                activeButton.classList.remove('text-gray-500');
            }
            currentTab = tabId;
        }
        // ডিফল্ট ট্যাব
        showTab('productsTab');
    </script>
</body>
</html>