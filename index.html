<!DOCTYPE html>
<html lang="ar" dir="rtl"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="appTitle">গুডাউন ম্যানেজমেন্ট সিস্টেম</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signInAnonymously, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            onSnapshot, 
            updateDoc, 
            deleteDoc,
            Timestamp,
            orderBy,
            limit,
            writeBatch,
            // setLogLevel // Uncomment if needed
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- User Provided Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnvcS8kpOrebq66LzQ2hz5Kvv_z_pu5p4",
            authDomain: "stock-5d278.firebaseapp.com",
            projectId: "stock-5d278",
            storageBucket: "stock-5d278.firebasestorage.app",
            messagingSenderId: "730697386577",
            appId: "1:730697386577:web:8b7ef78adac14ee5990670",
            measurementId: "G-CFNVGX1S4W"
        };

        // This appId is used for Firestore paths, distinct from firebaseConfig.appId
        const firestoreAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // setLogLevel('debug'); 

        // --- Language and Translations ---
        let currentLanguage = 'ar'; // Default language
        const translations = {
            ar: {
                appTitle: "نظام إدارة المستودعات",
                loading: "جار التحميل...",
                loginViewTitle: "نظام إدارة المستودعات",
                adminLoginTitle: "تسجيل دخول المسؤول",
                emailLabel: "البريد الإلكتروني",
                emailPlaceholder: "admin@example.com",
                passwordLabel: "كلمة المرور",
                passwordPlaceholder: "********",
                adminLoginButton: "تسجيل دخول المسؤول",
                userLoginTitle: "تسجيل دخول المستخدم",
                passcodeLabel: "رمز المرور",
                passcodePlaceholder: "رمز مرور القسم",
                passcodeHint: "المطبخ: KhamerK، الرجال: KhamerM، العائلة: KhamerF",
                userLoginButton: "تسجيل دخول المستخدم",
                adminPanelTitle: "لوحة تحكم المسؤول",
                navProducts: "المنتجات",
                navOrders: "الطلبات",
                navRestockLog: "سجل إعادة التخزين (قريباً)",
                navLowStockAlert: "تنبيه انخفاض المخزون",
                navReports: "التقارير",
                navNotifications: "الإشعارات",
                logoutButton: "تسجيل الخروج",
                productManagementTitle: "إدارة المنتجات",
                addNewProductTitle: "إضافة منتج جديد",
                productNameLabel: "اسم المنتج",
                productQuantityLabel: "الكمية",
                productUnitLabel: "الوحدة",
                unitPieces: "قطعة",
                unitKg: "كجم",
                unitLitre: "لتر",
                unitDozen: "دزينة",
                unitPacket: "علبة",
                productCategoryLabel: "الفئة",
                productCategoryPlaceholder: "مثال: أرز، عدس، صابون",
                lowStockAlertNumLabel: "عدد تنبيه انخفاض المخزون",
                addProductButton: "إضافة منتج",
                allProductsTitle: "جميع المنتجات",
                tableHeaderName: "الاسم",
                tableHeaderStock: "المخزون",
                tableHeaderCategory: "الفئة",
                tableHeaderLowStockThreshold: "حد التنبيه",
                tableHeaderActions: "الإجراءات",
                restockButton: "إعادة تخزين",
                deleteButton: "حذف",
                ordersTitle: "الطلبات",
                filterByLabel: "تصفية حسب:",
                filterAllSections: "جميع الأقسام",
                filterKitchen: "المطبخ",
                filterMen: "الرجال",
                filterFamily: "العائلة",
                tableHeaderOrderId: "معرف الطلب",
                tableHeaderSection: "القسم",
                tableHeaderItems: "المنتجات",
                tableHeaderOrderDate: "تاريخ الطلب",
                tableHeaderStatus: "الحالة",
                statusPending: "قيد الانتظار",
                statusProcessing: "قيد المعالجة",
                statusDelivered: "تم التوصيل",
                statusCancelled: "ملغى",
                statusPartiallyCancelled: "ملغى جزئياً",
                statusPartiallyDelivered: "تم التوصيل جزئياً",
                cancellationRequestExists: "يوجد طلب إلغاء",
                actionProcess: "معالجة",
                actionDeliver: "توصيل",
                actionCancel: "إلغاء",
                cancellationRequestLabel: "طلب إلغاء",
                approveButton: "موافقة",
                rejectButton: "رفض",
                restockLogTitle: "سجل إعادة التخزين",
                comingSoon: "هذه الميزة ستتوفر قريباً...",
                lowStockAlertTitle: "تنبيه انخفاض المخزون",
                alertIgnoreButton: "تجاهل التنبيه",
                reportsTitle: "تقارير التسليم",
                selectMonthLabel: "اختر الشهر (من 20 إلى 20):",
                cleanupOldRecordsButton: "حذف السجلات القديمة (أكثر من 3 أشهر)",
                tableHeaderTotalDeliveredQty: "إجمالي الكمية المسلمة",
                notificationsTitle: "الإشعارات",
                userPanelTitle: "لوحة تحكم المستخدم",
                userSectionTitleDefault: "قسم المستخدم",
                navPlaceOrder: "إنشاء طلب",
                navMyOrders: "طلباتي",
                placeOrderTitle: "طلب المنتجات",
                availableProductsTitle: "المنتجات المتوفرة",
                shoppingCartTitle: "عربة التسوق",
                addToCartButton: "أضف إلى العربة",
                placeOrderButton: "إتمام الطلب",
                myOrdersTitle: "طلباتي",
                cancelItemRequestButtonSuffix: "طلب إلغاء",
                confirmTitle: "تأكيد",
                confirmMessageDefault: "هل أنت متأكد؟",
                confirmYes: "نعم",
                confirmNo: "لا",
                toastAdminLoginSuccess: "تم تسجيل دخول المسؤول بنجاح!",
                toastLoginFailed: "فشل تسجيل الدخول: ",
                toastUserLoginSuccess: "تم تسجيل الدخول إلى قسم {section} بنجاح!",
                toastInvalidPasscode: "رمز مرور غير صالح!",
                toastLoggedOut: "تم تسجيل الخروج بنجاح.",
                toastFillAllFields: "يرجى ملء جميع الحقول المطلوبة.",
                toastQuantityCannotBeNegative: "الكمية وتنبيه انخفاض المخزون لا يمكن أن تكون سالبة.",
                toastProductAddedSuccess: "تمت إضافة المنتج بنجاح!",
                toastProductAddError: "حدث خطأ أثناء إضافة المنتج.",
                toastProductDeleteConfirm: "هل تريد حذف المنتج \"{productName}\"؟",
                toastProductDeleted: "تم حذف المنتج \"{productName}\".",
                toastProductDeleteError: "حدث خطأ أثناء حذف المنتج.",
                toastEnterRestockDamagedQty: "يرجى إدخال الكمية المضافة أو التالفة.",
                toastStockCannotBeLessDamaged: "لا يمكن أن يكون المخزون أقل من كمية البضائع التالفة.",
                toastProductNotFound: "المنتج غير موجود.",
                toastProductRestockedSuccess: "تمت إعادة تخزين المنتج بنجاح!",
                toastProductRestockError: "حدث خطأ أثناء إعادة تخزين المنتج.",
                toastCartEmpty: "عربة التسوق فارغة.",
                toastProductOutOfStockPartial: "\"{productName}\" غير متوفر بكمية كافية. قد يكون الطلب ناجحًا جزئيًا.",
                toastProductOutOfStockFull: "\"{productName}\" غير متوفر بكمية كافية. يمكن طلب {stock} {unit} كحد أقصى.",
                toastOrderPlacedSuccess: "تم تقديم الطلب بنجاح!",
                toastOrderPlaceError: "حدث خطأ أثناء تقديم الطلب.",
                toastOrderStatusUpdated: "تم تحديث حالة الطلب #{orderId} إلى \"{status}\".",
                toastOrderStatusUpdateError: "حدث خطأ أثناء تحديث حالة الطلب.",
                toastOrderDeliveredAndRecorded: "تم توصيل الطلب #{orderId} وتسجيله.",
                toastOrderDeliverError: "حدث خطأ أثناء توصيل الطلب.",
                toastOrderCancelConfirm: "هل تريد إلغاء الطلب #{orderId} (قسم {section}) بالكامل؟ ستتم إعادة المنتجات الملغاة إلى المخزون.",
                toastOrderCancelled: "تم إلغاء الطلب #{orderId}.",
                toastOrderCancelError: "حدث خطأ أثناء إلغاء الطلب.",
                toastCancellationRequestNotFound: "طلب الإلغاء أو المنتج غير موجود.",
                toastCancellationRequestApproved: "تمت الموافقة على طلب إلغاء {productName}.",
                toastCancellationRequestRejected: "تم رفض طلب إلغاء {productName}.",
                toastCancellationRequestHandleError: "حدث خطأ أثناء معالجة طلب الإلغاء.",
                toastCancellationRequestReason: "يرجى كتابة سبب الإلغاء.",
                toastCancellationRequestExists: "يوجد بالفعل طلب إلغاء لهذا المنتج.",
                toastCancellationRequestSubmitted: "تم إرسال طلب الإلغاء بنجاح!",
                toastCancellationRequestSubmitError: "حدث خطأ أثناء إرسال طلب الإلغاء.",
                toastLowStockAlertIgnored: "تم {status} تنبيه انخفاض مخزون المنتج.",
                alertIgnored: "تجاهله",
                alertReactivated: "إعادة تفعيله",
                toastLowStockAlertUpdateError: "حدث خطأ أثناء تحديث حالة تنبيه انخفاض المخزون.",
                toastProductsLoadError: "حدث خطأ أثناء تحميل المنتجات.",
                toastOrdersLoadError: "حدث خطأ أثناء تحميل الطلبات.",
                toastAdminNotificationsLoadError: "حدث خطأ أثناء تحميل إشعارات المسؤول.",
                toastUserOrdersLoadError: "حدث خطأ أثناء تحميل طلباتك.",
                toastUserNotificationsLoadError: "حدث خطأ أثناء تحميل إشعاراتك.",
                toastNoNewNotifications: "لا توجد إشعارات جديدة.",
                toastMarkAsRead: "وضع علامة كمقروء",
                toastAddedToCart: "تمت إضافة {quantity} {unit} من \"{productName}\" إلى العربة.",
                toastEnterValidQuantity: "يرجى إدخال كمية صحيحة.",
                toastCartEmptyMessage: "عربة التسوق فارغة الآن.",
                toastReportLoading: "جار تحميل التقرير...",
                toastSelectMonthForReport: "يرجى اختيار شهر للتقرير.",
                toastDeliveryReportLoadError: "حدث خطأ أثناء تحميل تقارير التسليم.",
                toastDeliveryReportLoadFail: "فشل تحميل التقرير.",
                toastNoDeliveryRecordsForMonth: "لا توجد سجلات تسليم لهذا الشهر.",
                toastConfirmDeleteOldRecords: "هل تريد حذف جميع سجلات التسليم التي يزيد عمرها عن 3 أشهر؟ لا يمكن التراجع عن هذا الإجراء.",
                toastNoOldRecordsFound: "لم يتم العثور على سجلات تسليم قديمة (أكثر من 3 أشهر).",
                toastOldRecordsDeleted: "تم حذف {count} من سجلات التسليم القديمة بنجاح.",
                toastOldRecordsDeleteError: "حدث خطأ أثناء حذف السجلات القديمة.",
                currentStockLabel: "المخزون الحالي:",
                newAddedQuantityLabel: "الكمية المضافة الجديدة",
                damagedReturnedQuantityLabel: "الكمية التالفة/المعادة (سيتم خصمها من المخزون)",
                closeButton: "إغلاق",
                completeRestockButton: "إتمام إعادة التخزين",
                cancelDeliveryRequestTitlePrefix: "طلب إلغاء تسليم المنتج:",
                cancelReasonLabel: "سبب الإلغاء (مثال: استلمت كمية أقل / لم أستلم المنتج)",
                cancelReasonPlaceholder: "اكتب التفاصيل...",
                submitRequestButton: "إرسال الطلب",
                langArabic: "العربية",
                langEnglish: "English",
                productUnit: "الوحدة",
                orderQuantity: "الكمية المطلوبة",
                deliveredQuantity: "الكمية المسلمة",
                quantity: "الكمية",
                removeButton: "إزالة",
            },
            en: {
                appTitle: "Warehouse Management System",
                loading: "Loading...",
                loginViewTitle: "Warehouse Management System",
                adminLoginTitle: "Admin Login",
                emailLabel: "Email",
                emailPlaceholder: "admin@example.com",
                passwordLabel: "Password",
                passwordPlaceholder: "********",
                adminLoginButton: "Admin Login",
                userLoginTitle: "User Login",
                passcodeLabel: "Passcode",
                passcodePlaceholder: "Department Passcode",
                passcodeHint: "Kitchen: KhamerK, Men: KhamerM, Family: KhamerF",
                userLoginButton: "User Login",
                adminPanelTitle: "Admin Panel",
                navProducts: "Products",
                navOrders: "Orders",
                navRestockLog: "Restock Log (Coming Soon)",
                navLowStockAlert: "Low Stock Alert",
                navReports: "Reports",
                navNotifications: "Notifications",
                logoutButton: "Logout",
                productManagementTitle: "Product Management",
                addNewProductTitle: "Add New Product",
                productNameLabel: "Product Name",
                productQuantityLabel: "Quantity",
                productUnitLabel: "Unit",
                unitPieces: "Pieces",
                unitKg: "Kg",
                unitLitre: "Litre",
                unitDozen: "Dozen",
                unitPacket: "Packet",
                productCategoryLabel: "Category",
                productCategoryPlaceholder: "e.g., Rice, Lentils, Soap",
                lowStockAlertNumLabel: "Low Stock Alert Number",
                addProductButton: "Add Product",
                allProductsTitle: "All Products",
                tableHeaderName: "Name",
                tableHeaderStock: "Stock",
                tableHeaderCategory: "Category",
                tableHeaderLowStockThreshold: "Low Stock Threshold",
                tableHeaderActions: "Actions",
                restockButton: "Restock",
                deleteButton: "Delete",
                ordersTitle: "Orders",
                filterByLabel: "Filter by:",
                filterAllSections: "All Sections",
                filterKitchen: "Kitchen",
                filterMen: "Men",
                filterFamily: "Family",
                tableHeaderOrderId: "Order ID",
                tableHeaderSection: "Section",
                tableHeaderItems: "Items",
                tableHeaderOrderDate: "Order Date",
                tableHeaderStatus: "Status",
                statusPending: "Pending",
                statusProcessing: "Processing",
                statusDelivered: "Delivered",
                statusCancelled: "Cancelled",
                statusPartiallyCancelled: "Partially Cancelled",
                statusPartiallyDelivered: "Partially Delivered",
                cancellationRequestExists: "Cancellation Request Exists",
                actionProcess: "Process",
                actionDeliver: "Deliver",
                actionCancel: "Cancel",
                cancellationRequestLabel: "Cancellation Request",
                approveButton: "Approve",
                rejectButton: "Reject",
                restockLogTitle: "Restock Log",
                comingSoon: "This feature is coming soon...",
                lowStockAlertTitle: "Low Stock Alert",
                alertIgnoreButton: "Ignore Alert",
                reportsTitle: "Delivery Reports",
                selectMonthLabel: "Select Month (20th to 20th):",
                cleanupOldRecordsButton: "Cleanup Old Records (Older than 3 months)",
                tableHeaderTotalDeliveredQty: "Total Delivered Quantity",
                notificationsTitle: "Notifications",
                userPanelTitle: "User Panel",
                userSectionTitleDefault: "User Section",
                navPlaceOrder: "Place Order",
                navMyOrders: "My Orders",
                placeOrderTitle: "Order Products",
                availableProductsTitle: "Available Products",
                shoppingCartTitle: "Shopping Cart",
                addToCartButton: "Add to Cart",
                placeOrderButton: "Place Order",
                myOrdersTitle: "My Orders",
                cancelItemRequestButtonSuffix: "Cancel Request",
                confirmTitle: "Confirm",
                confirmMessageDefault: "Are you sure?",
                confirmYes: "Yes",
                confirmNo: "No",
                toastAdminLoginSuccess: "Admin login successful!",
                toastLoginFailed: "Login failed: ",
                toastUserLoginSuccess: "Login to {section} section successful!",
                toastInvalidPasscode: "Invalid passcode!",
                toastLoggedOut: "Logged out successfully.",
                toastFillAllFields: "Please fill all required fields.",
                toastQuantityCannotBeNegative: "Quantity and low stock alert cannot be negative.",
                toastProductAddedSuccess: "Product added successfully!",
                toastProductAddError: "Error adding product.",
                toastProductDeleteConfirm: "Do you want to delete product \"{productName}\"?",
                toastProductDeleted: "Product \"{productName}\" deleted.",
                toastProductDeleteError: "Error deleting product.",
                toastEnterRestockDamagedQty: "Please enter added or damaged quantity.",
                toastStockCannotBeLessDamaged: "Stock cannot be less than damaged quantity.",
                toastProductNotFound: "Product not found.",
                toastProductRestockedSuccess: "Product restocked successfully!",
                toastProductRestockError: "Error restocking product.",
                toastCartEmpty: "Your shopping cart is empty.",
                toastProductOutOfStockPartial: "\"{productName}\" is not available in sufficient quantity. Order might be partially successful.",
                toastProductOutOfStockFull: "\"{productName}\" is not available in sufficient quantity. Max {stock} {unit} can be ordered.",
                toastOrderPlacedSuccess: "Order placed successfully!",
                toastOrderPlaceError: "Error placing order.",
                toastOrderStatusUpdated: "Order #{orderId} status updated to \"{status}\".",
                toastOrderStatusUpdateError: "Error updating order status.",
                toastOrderDeliveredAndRecorded: "Order #{orderId} delivered and recorded.",
                toastOrderDeliverError: "Error marking order delivered.",
                toastOrderCancelConfirm: "Do you want to cancel order #{orderId} (section {section}) completely? Cancelled products will be returned to stock.",
                toastOrderCancelled: "Order #{orderId} cancelled.",
                toastOrderCancelError: "Error cancelling order.",
                toastCancellationRequestNotFound: "Cancellation request or product not found.",
                toastCancellationRequestApproved: "Cancellation request for {productName} approved.",
                toastCancellationRequestRejected: "Cancellation request for {productName} rejected.",
                toastCancellationRequestHandleError: "Error handling cancellation request.",
                toastCancellationRequestReason: "Please provide a reason for cancellation.",
                toastCancellationRequestExists: "A cancellation request for this item already exists.",
                toastCancellationRequestSubmitted: "Cancellation request submitted successfully!",
                toastCancellationRequestSubmitError: "Error submitting cancellation request.",
                toastLowStockAlertIgnored: "Product low stock alert {status}.",
                alertIgnored: "ignored",
                alertReactivated: "reactivated",
                toastLowStockAlertUpdateError: "Error updating low stock alert status.",
                toastProductsLoadError: "Error loading products.",
                toastOrdersLoadError: "Error loading orders.",
                toastAdminNotificationsLoadError: "Error loading admin notifications.",
                toastUserOrdersLoadError: "Error loading your orders.",
                toastUserNotificationsLoadError: "Error loading your notifications.",
                toastNoNewNotifications: "No new notifications.",
                toastMarkAsRead: "Mark as read",
                toastAddedToCart: "{quantity} {unit} of \"{productName}\" added to cart.",
                toastEnterValidQuantity: "Please enter a valid quantity.",
                toastCartEmptyMessage: "Your shopping cart is now empty.",
                toastReportLoading: "Loading report...",
                toastSelectMonthForReport: "Please select a month for the report.",
                toastDeliveryReportLoadError: "Error loading delivery reports.",
                toastDeliveryReportLoadFail: "Failed to load report.",
                toastNoDeliveryRecordsForMonth: "No delivery records for this month.",
                toastConfirmDeleteOldRecords: "Are you sure you want to delete all delivery records older than 3 months? This action cannot be undone.",
                toastNoOldRecordsFound: "No old delivery records (older than 3 months) found.",
                toastOldRecordsDeleted: "{count} old delivery records deleted successfully.",
                toastOldRecordsDeleteError: "Error deleting old records.",
                currentStockLabel: "Current Stock:",
                newAddedQuantityLabel: "New Added Quantity",
                damagedReturnedQuantityLabel: "Damaged/Returned Quantity (will be deducted from stock)",
                closeButton: "Close",
                completeRestockButton: "Complete Restock",
                cancelDeliveryRequestTitlePrefix: "Request Delivery Cancellation for Product:",
                cancelReasonLabel: "Reason for cancellation (e.g., received less / did not receive)",
                cancelReasonPlaceholder: "Write details...",
                submitRequestButton: "Submit Request",
                langArabic: "العربية",
                langEnglish: "English",
                productUnit: "Unit",
                orderQuantity: "Ordered Qty",
                deliveredQuantity: "Delivered Qty",
                quantity: "Quantity",
                removeButton: "Remove",
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.dataset.langKey;
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        if (element.placeholder) element.placeholder = translations[lang][key];
                    } else if (element.tagName === 'TITLE') {
                         element.textContent = translations[lang][key];
                    }
                    else {
                        element.textContent = translations[lang][key];
                    }
                }
            });
            // Update dynamic elements like table headers if they are not re-rendered by other functions
            // For example, if table headers are static in HTML:
            // document.getElementById('someStaticTableHeader').textContent = translations[lang].someStaticTableHeaderKey;
            
            // Special handling for unit dropdown options as their textContent is set by JS
            populateUnitDropdownOptions();
            // Refresh dynamic tables if needed, or ensure their rendering functions use currentLanguage
            if (currentUser) {
                if (currentUser.email) { // Admin
                    if (adminSections.adminProductsSection && !adminSections.adminProductsSection.classList.contains('hidden')) {
                        renderProductsTable(productsCache); // Re-render with current lang for buttons
                    }
                     if (adminSections.adminOrdersSection && !adminSections.adminOrdersSection.classList.contains('hidden')) {
                        // Assuming orders are fetched and stored in a global var or re-fetched
                        // For now, let's assume onSnapshot handles re-rendering, but button texts might need update
                        // This is complex if orders are already rendered. A full re-render might be needed.
                    }
                } else { // User
                     if (userSections.userPlaceOrderSection && !userSections.userPlaceOrderSection.classList.contains('hidden')) {
                        renderUserProducts(productsCache);
                        renderShoppingCart();
                    }
                }
            }
        }

        function populateUnitDropdownOptions() {
            const unitSelect = document.getElementById('productUnit');
            if (unitSelect) {
                unitSelect.innerHTML = `
                    <option value="pieces" data-lang-key="unitPieces">${translations[currentLanguage].unitPieces}</option>
                    <option value="kg" data-lang-key="unitKg">${translations[currentLanguage].unitKg}</option>
                    <option value="litre" data-lang-key="unitLitre">${translations[currentLanguage].unitLitre}</option>
                    <option value="dozen" data-lang-key="unitDozen">${translations[currentLanguage].unitDozen}</option>
                    <option value="packet" data-lang-key="unitPacket">${translations[currentLanguage].unitPacket}</option>
                `;
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(currentLanguage); // Set default language on load

            const langSwitcherButtons = document.querySelectorAll('.lang-switcher-btn');
            langSwitcherButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const lang = e.target.dataset.lang;
                    setLanguage(lang);
                });
            });
            populateUnitDropdownOptions(); // Initial population
        });


        // --- Global State ---
        let currentUser = null;
        let currentSection = null; 
        let currentUserId = null; 
        let productsCache = [];
        let unsubscribeProductsListener = null;
        let unsubscribeOrdersListener = null;
        let unsubscribeNotificationsListener = null;
        let unsubscribeLowStockListener =null;
        let unsubscribeDeliveryRecordsListener = null;

        const PASSCODES = { KhamerK: "Kitchen", KhamerM: "Men", KhamerF: "Family" };

        const views = {
            loginView: document.getElementById('loginView'),
            adminDashboardView: document.getElementById('adminDashboardView'),
            userDashboardView: document.getElementById('userDashboardView'),
            loadingView: document.getElementById('loadingView')
        };

        const adminNavLinks = document.querySelectorAll('.admin-nav-link');
        const adminSections = {
            adminProductsSection: document.getElementById('adminProductsSection'),
            adminOrdersSection: document.getElementById('adminOrdersSection'),
            adminRestockSection: document.getElementById('adminRestockSection'),
            adminLowStockSection: document.getElementById('adminLowStockSection'),
            adminReportsSection: document.getElementById('adminReportsSection'),
            adminNotificationsSection: document.getElementById('adminNotificationsSection')
        };
        
        const userNavLinks = document.querySelectorAll('.user-nav-link');
        const userSections = {
            userPlaceOrderSection: document.getElementById('userPlaceOrderSection'),
            userMyOrdersSection: document.getElementById('userMyOrdersSection'),
            userNotificationsSection: document.getElementById('userNotificationsSection')
        };

        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminEmailInput = document.getElementById('adminEmail');
        const adminPasswordInput = document.getElementById('adminPassword');
        const userLoginForm = document.getElementById('userLoginForm');
        const userPasscodeInput = document.getElementById('userPasscode');
        const adminLogoutButton = document.getElementById('adminLogoutButton');
        const userLogoutButton = document.getElementById('userLogoutButton');
        const addProductForm = document.getElementById('addProductForm');
        const productNameInput = document.getElementById('productName');
        const productQuantityInput = document.getElementById('productQuantity');
        const productUnitSelect = document.getElementById('productUnit');
        const productCategoryInput = document.getElementById('productCategory');
        const lowStockAlertInput = document.getElementById('lowStockAlert');
        const productsTableBody = document.getElementById('productsTableBody');
        const restockModal = document.getElementById('restockModal');
        const restockForm = document.getElementById('restockForm');
        const restockProductIdInput = document.getElementById('restockProductId');
        const restockProductNameSpan = document.getElementById('restockProductNameSpan');
        const restockQuantityInput = document.getElementById('restockQuantity');
        const damagedQuantityInput = document.getElementById('damagedQuantity');
        const closeRestockModalButton = document.getElementById('closeRestockModalButton');
        const adminOrdersTableBody = document.getElementById('adminOrdersTableBody');
        const adminOrderFilterSelect = document.getElementById('adminOrderFilter');
        const lowStockTableBody = document.getElementById('lowStockTableBody');
        const deliveryReportTableBody = document.getElementById('deliveryReportTableBody');
        const reportMonthSelect = document.getElementById('reportMonthSelect');
        const cleanupOldRecordsButton = document.getElementById('cleanupOldRecordsButton');
        const adminNotificationsList = document.getElementById('adminNotificationsList');
        const userProductsListDiv = document.getElementById('userProductsList');
        const userShoppingCartDiv = document.getElementById('userShoppingCart');
        const placeOrderButton = document.getElementById('placeOrderButton');
        let shoppingCart = [];
        const userOrdersTableBody = document.getElementById('userOrdersTableBody');
        const userCancelItemModal = document.getElementById('userCancelItemModal');
        const userCancelItemForm = document.getElementById('userCancelItemForm');
        const userCancelOrderIdInput = document.getElementById('userCancelOrderId');
        const userCancelItemIdInput = document.getElementById('userCancelItemId');
        const userCancelItemNameSpan = document.getElementById('userCancelItemNameSpan');
        const userCancelReasonInput = document.getElementById('userCancelReason');
        const closeUserCancelModalButton = document.getElementById('closeUserCancelModalButton');
        const userNotificationsList = document.getElementById('userNotificationsList');
        const userSectionTitle = document.getElementById('userSectionTitle');


        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
        }

        function showAdminSection(sectionName) {
            Object.values(adminSections).forEach(section => section.classList.add('hidden'));
            if (adminSections[sectionName]) adminSections[sectionName].classList.remove('hidden');
            adminNavLinks.forEach(link => {
                link.classList.remove('bg-blue-700', 'text-white');
                link.classList.add('text-blue-100', 'hover:bg-blue-600');
                if (link.dataset.section === sectionName) link.classList.add('bg-blue-700', 'text-white');
            });
        }
        
        function showUserSection(sectionName) {
            Object.values(userSections).forEach(section => section.classList.add('hidden'));
            if (userSections[sectionName]) userSections[sectionName].classList.remove('hidden');
            userNavLinks.forEach(link => {
                link.classList.remove('bg-green-700', 'text-white');
                link.classList.add('text-green-100', 'hover:bg-green-600');
                if (link.dataset.section === sectionName) link.classList.add('bg-green-700', 'text-white');
            });
        }

        function showToast(messageKey, type = 'success', replacements = {}) {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            
            let messageText = translations[currentLanguage][messageKey] || messageKey;
            for (const placeholder in replacements) {
                messageText = messageText.replace(`{${placeholder}}`, replacements[placeholder]);
            }

            toastMessage.textContent = messageText;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');

            if (type === 'success') toast.classList.add('bg-green-500');
            else if (type === 'error') toast.classList.add('bg-red-500');
            else toast.classList.add('bg-blue-500');
            
            toast.classList.remove('hidden');
            toast.classList.add('animate-fadeInOut');

            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('animate-fadeInOut');
            }, 3000);
        }
        
        onAuthStateChanged(auth, async (user) => {
            showView('loadingView');
            if (user) {
                currentUser = user;
                currentUserId = user.uid;

                if (user.email) { 
                    await loadAdminData();
                    showView('adminDashboardView');
                    showAdminSection('adminProductsSection');
                } else { 
                    const userSessionDocRef = doc(db, `/artifacts/${firestoreAppId}/users/${user.uid}/session/data`);
                    try {
                        const docSnap = await getDoc(userSessionDocRef);
                        if (docSnap.exists() && docSnap.data() && docSnap.data().section) {
                            currentSection = docSnap.data().section;
                            userSectionTitle.textContent = `${translations[currentLanguage][`filter${currentSection}`] || currentSection} ${translations[currentLanguage].userPanelTitle.split(' ')[1] || ''}`;
                            await loadUserData();
                            showView('userDashboardView');
                            showUserSection('userPlaceOrderSection');
                        } else {
                            if (!docSnap.exists()) console.error(`SESSION DOC MISSING: UID: ${user.uid}. Path: ${userSessionDocRef.path}`);
                            else if (!docSnap.data()) console.error(`SESSION DOC EMPTY: UID: ${user.uid}. Path: ${userSessionDocRef.path}. Data:`, docSnap.data());
                            else if (!docSnap.data().section) console.error(`SECTION MISSING IN DOC: UID: ${user.uid}. Path: ${userSessionDocRef.path}. Data:`, docSnap.data());
                            await performSignOut();
                        }
                    } catch (error) {
                        console.error(`Error fetching user session for UID ${user.uid}: `, error);
                        showToast("toastUserSessionError", "error"); // Assuming this key exists
                        await performSignOut();
                    }
                }
            } else {
                currentUser = null;
                currentUserId = null;
                currentSection = null;
                shoppingCart = [];
                cleanupListeners();
                showView('loginView');
            }
            setLanguage(currentLanguage); // Ensure language is applied after view changes
        });

        if (adminLoginForm) {
            adminLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = adminEmailInput.value;
                const password = adminPasswordInput.value;
                showView('loadingView');
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                    showToast("toastAdminLoginSuccess", "success");
                } catch (error) {
                    console.error("Admin login error: ", error);
                    showToast("toastLoginFailed", "error", { message: error.message });
                    showView('loginView');
                }
            });
        }

        if (userLoginForm) {
            userLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const passcode = userPasscodeInput.value;
                const section = PASSCODES[passcode];
                showView('loadingView');

                if (section) {
                    try {
                        const userCredential = await signInAnonymously(auth);
                        currentUserId = userCredential.user.uid;
                        currentSection = section;
                        
                        const userSessionDocRef = doc(db, `/artifacts/${firestoreAppId}/users/${currentUserId}/session/data`);
                        await setDoc(userSessionDocRef, { 
                            section: currentSection, 
                            uid: currentUserId, 
                            loggedInAt: Timestamp.now() 
                        });
                        showToast("toastUserLoginSuccess", "success", { section: translations[currentLanguage][`filter${section}`] || section });
                    } catch (error) {
                        console.error("User anonymous login error: ", error);
                        showToast("toastLoginFailed", "error", { message: error.message });
                        showView('loginView');
                    }
                } else {
                    showToast("toastInvalidPasscode", "error");
                    showView('loginView');
                }
            });
        }
        
        async function performSignOut() {
            showView('loadingView');
            await signOut(auth); 
            showToast("toastLoggedOut", "info");
        }

        if (adminLogoutButton) adminLogoutButton.addEventListener('click', performSignOut);
        if (userLogoutButton) userLogoutButton.addEventListener('click', performSignOut);

        async function addProduct(e) {
            e.preventDefault();
            const name = productNameInput.value;
            let quantity = parseFloat(productQuantityInput.value);
            const unit = productUnitSelect.value;
            const category = productCategoryInput.value;
            let lowStock = parseInt(lowStockAlertInput.value);

            if (!name || isNaN(quantity) || !category || isNaN(lowStock)) {
                showToast("toastFillAllFields", "error"); return;
            }
            if (quantity < 0 || lowStock < 0) {
                showToast("toastQuantityCannotBeNegative", "error"); return;
            }

            try {
                const newProdRef = doc(collection(db, `/artifacts/${firestoreAppId}/public/data/products`));
                await setDoc(newProdRef, {
                    id: newProdRef.id, name, stock: quantity, unit, category,
                    lowStockAlertThreshold: lowStock, isLowStockAlertIgnored: false,
                    createdAt: Timestamp.now(), updatedAt: Timestamp.now()
                });
                showToast("toastProductAddedSuccess", "success");
                addProductForm.reset();
            } catch (error) {
                console.error("Error adding product: ", error);
                showToast("toastProductAddError", "error");
            }
        }
        if (addProductForm) addProductForm.addEventListener('submit', addProduct);

        function renderProductsTable(products) {
            productsCache = products; 
            if (!productsTableBody) return;
            productsTableBody.innerHTML = '';
            products.forEach(product => {
                const row = productsTableBody.insertRow();
                row.insertCell().textContent = product.name; // Product name is from DB, not translated here
                row.insertCell().textContent = `${product.stock.toFixed(product.unit === 'kg' ? 2 : 0)} ${translations[currentLanguage][`unit${product.unit.charAt(0).toUpperCase() + product.unit.slice(1)}`] || product.unit}`;
                row.insertCell().textContent = product.category; // Category is from DB
                row.insertCell().textContent = product.lowStockAlertThreshold;
                
                const actionsCell = row.insertCell();
                actionsCell.classList.add('space-x-2');
                const restockButton = document.createElement('button');
                restockButton.textContent = translations[currentLanguage].restockButton;
                restockButton.classList.add('bg-green-500', 'hover:bg-green-700', 'text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-sm');
                restockButton.onclick = () => openRestockModal(product);
                actionsCell.appendChild(restockButton);

                const deleteButtonEl = document.createElement('button');
                deleteButtonEl.textContent = translations[currentLanguage].deleteButton;
                deleteButtonEl.classList.add('bg-red-500', 'hover:bg-red-700', 'text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-sm');
                deleteButtonEl.onclick = () => deleteProduct(product.id, product.name);
                actionsCell.appendChild(deleteButtonEl);
            });
        }
        
        async function deleteProduct(productId, productName) {
            const confirmModal = document.getElementById('customConfirmModal');
            const confirmMessage = document.getElementById('customConfirmMessage');
            const confirmYesButton = document.getElementById('customConfirmYes');
            const confirmNoButton = document.getElementById('customConfirmNo');

            confirmMessage.textContent = translations[currentLanguage].toastProductDeleteConfirm.replace("{productName}", productName);
            confirmYesButton.textContent = translations[currentLanguage].confirmYes;
            confirmNoButton.textContent = translations[currentLanguage].confirmNo;
            document.querySelector('#customConfirmModal h3').textContent = translations[currentLanguage].confirmTitle;
            confirmModal.classList.remove('hidden');

            confirmYesButton.onclick = async () => {
                confirmModal.classList.add('hidden');
                try {
                    await deleteDoc(doc(db, `/artifacts/${firestoreAppId}/public/data/products`, productId));
                    showToast("toastProductDeleted", "success", {productName: productName});
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    showToast("toastProductDeleteError", "error");
                }
            };
            confirmNoButton.onclick = () => confirmModal.classList.add('hidden');
        }

        function openRestockModal(product) {
            if (!restockModal || !restockProductIdInput || !restockProductNameSpan) return;
            restockProductIdInput.value = product.id;
            restockProductNameSpan.textContent = product.name; // Product name from DB
            restockForm.reset(); 
            document.getElementById('currentStockSpan').textContent = `${product.stock} ${translations[currentLanguage][`unit${product.unit.charAt(0).toUpperCase() + product.unit.slice(1)}`] || product.unit}`;
            // Update modal texts
            restockModal.querySelector('h3').innerHTML = `${translations[currentLanguage].restockButton}: <span id="restockProductNameSpan" class="text-blue-600">${product.name}</span>`;
            restockModal.querySelector('label[for="restockQuantity"]').textContent = translations[currentLanguage].newAddedQuantityLabel;
            restockModal.querySelector('label[for="damagedQuantity"]').textContent = translations[currentLanguage].damagedReturnedQuantityLabel;
            closeRestockModalButton.textContent = translations[currentLanguage].closeButton;
            restockModal.querySelector('button[type="submit"]').textContent = translations[currentLanguage].completeRestockButton;
            document.getElementById('currentStockLabel').textContent = translations[currentLanguage].currentStockLabel;


            restockModal.classList.remove('hidden');
        }
        if (closeRestockModalButton) closeRestockModalButton.onclick = () => restockModal.classList.add('hidden');

        async function handleRestock(e) {
            e.preventDefault();
            const productId = restockProductIdInput.value;
            const quantityAdded = parseFloat(restockQuantityInput.value) || 0;
            const quantityDamaged = parseFloat(damagedQuantityInput.value) || 0;

            if (quantityAdded < 0 || quantityDamaged < 0) {
                showToast("toastQuantityCannotBeNegative", "error"); return;
            }
            if (quantityAdded === 0 && quantityDamaged === 0) {
                showToast("toastEnterRestockDamagedQty", "error"); return;
            }

            const productRef = doc(db, `/artifacts/${firestoreAppId}/public/data/products`, productId);
            try {
                const productDoc = await getDoc(productRef);
                if (!productDoc.exists()) {
                    showToast("toastProductNotFound", "error"); return;
                }
                const productData = productDoc.data();
                const currentStock = parseFloat(productData.stock);
                const newStock = currentStock + quantityAdded - quantityDamaged;

                if (newStock < 0) {
                    showToast("toastStockCannotBeLessDamaged", "error"); return;
                }

                await updateDoc(productRef, { stock: newStock, updatedAt: Timestamp.now(), isLowStockAlertIgnored: false });
                const restockLogRef = collection(db, `/artifacts/${firestoreAppId}/public/data/restockLog`);
                await addDoc(restockLogRef, {
                    productId, productName: productData.name, quantityAdded, quantityDamagedReturned: quantityDamaged,
                    previousStock: currentStock, newStock, date: Timestamp.now(), restockedBy: currentUser.email 
                });
                showToast("toastProductRestockedSuccess", "success");
                restockModal.classList.add('hidden');
            } catch (error) {
                console.error("Error restocking product: ", error);
                showToast("toastProductRestockError", "error");
            }
        }
        if (restockForm) restockForm.addEventListener('submit', handleRestock);

        async function placeNewOrder() {
            if (shoppingCart.length === 0) {
                showToast("toastCartEmpty", "error"); return;
            }
            const orderItems = shoppingCart.map(item => ({
                productId: item.productId, productName: item.name, quantityOrdered: item.quantity,
                quantityDelivered: item.quantity, unit: item.unit,
            }));
            try {
                const newOrderRef = doc(collection(db, `/artifacts/${firestoreAppId}/public/data/orders`));
                await setDoc(newOrderRef, {
                    id: newOrderRef.id, section: currentSection, orderByUserId: currentUserId, 
                    items: orderItems, status: "pending", orderDate: Timestamp.now(), cancellationRequests: [] 
                });
                const batch = writeBatch(db);
                for (const item of orderItems) {
                    const productRef = doc(db, `/artifacts/${firestoreAppId}/public/data/products`, item.productId);
                    const productDoc = await getDoc(productRef);
                    if (productDoc.exists()) {
                        const currentStock = productDoc.data().stock;
                        const newStock = currentStock - item.quantityOrdered;
                        if (newStock < 0) {
                            showToast("toastProductOutOfStockPartial", "warning", {productName: item.productName});
                            batch.update(productRef, { stock: 0, updatedAt: Timestamp.now() });
                        } else {
                             batch.update(productRef, { stock: newStock, updatedAt: Timestamp.now() });
                        }
                    }
                }
                await batch.commit();
                await addNotification("Admin", `New order #${newOrderRef.id.substring(0,6)} from ${currentSection} section.`); // This message should be translatable if admin panel is multilingual
                showToast("toastOrderPlacedSuccess", "success");
                shoppingCart = [];
                renderShoppingCart();
            } catch (error) {
                console.error("Error placing order: ", error);
                showToast("toastOrderPlaceError", "error");
            }
        }
        if (placeOrderButton) placeOrderButton.addEventListener('click', placeNewOrder);

        function renderAdminOrdersTable(orders) {
            if (!adminOrdersTableBody) return;
            adminOrdersTableBody.innerHTML = '';
            let filteredOrders = orders;
            const filterValue = adminOrderFilterSelect.value;
            if (filterValue !== "all") {
                filteredOrders = orders.filter(order => order.section === filterValue);
            }

            filteredOrders.forEach(order => {
                const row = adminOrdersTableBody.insertRow();
                row.insertCell().textContent = order.id.substring(0, 6);
                row.insertCell().textContent = translations[currentLanguage][`filter${order.section}`] || order.section;
                row.insertCell().innerHTML = order.items.map(item => 
                    `<div>${item.productName} (${translations[currentLanguage].orderQuantity}: ${item.quantityOrdered}${item.unit}, ${translations[currentLanguage].deliveredQuantity}: ${item.quantityDelivered}${item.unit})</div>`
                ).join('');
                row.insertCell().textContent = new Date(order.orderDate.seconds * 1000).toLocaleDateString(currentLanguage === 'ar' ? 'ar-SA' : 'en-GB');
                
                const statusCell = row.insertCell();
                const statusBadge = document.createElement('span');
                statusBadge.textContent = translations[currentLanguage][`status${order.status.charAt(0).toUpperCase() + order.status.slice(1).replace(/_([a-z])/g, g => g[1].toUpperCase())}`] || order.status;
                statusBadge.classList.add('px-2', 'py-1', 'text-xs', 'font-semibold', 'rounded-full');
                setStatusBadgeColor(statusBadge, order.status);
                statusCell.appendChild(statusBadge);

                if (order.cancellationRequests && order.cancellationRequests.filter(req => req.status === 'pending').length > 0) {
                    const crBadge = document.createElement('span');
                    crBadge.textContent = translations[currentLanguage].cancellationRequestExists;
                    crBadge.classList.add('ms-2', 'px-2', 'py-1', 'text-xs', 'font-semibold', 'rounded-full', 'bg-yellow-200', 'text-yellow-800');
                    statusCell.appendChild(crBadge);
                }

                const actionsCell = row.insertCell();
                actionsCell.classList.add('space-x-1', 'whitespace-nowrap');

                if (order.status === 'pending' || order.status === 'processing') {
                    const processButton = document.createElement('button');
                    processButton.textContent = translations[currentLanguage].actionProcess;
                    processButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'py-1', 'px-2', 'rounded', 'text-sm');
                    processButton.onclick = () => updateOrderStatus(order.id, 'processing');
                    actionsCell.appendChild(processButton);

                    const deliverButton = document.createElement('button');
                    deliverButton.textContent = translations[currentLanguage].actionDeliver;
                    deliverButton.classList.add('bg-green-500', 'hover:bg-green-700', 'text-white', 'py-1', 'px-2', 'rounded', 'text-sm');
                    deliverButton.onclick = () => markOrderDelivered(order); 
                    actionsCell.appendChild(deliverButton);
                }
                 if (order.status !== 'cancelled' && order.status !== 'delivered') {
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = translations[currentLanguage].actionCancel;
                    cancelButton.classList.add('bg-red-500', 'hover:bg-red-700', 'text-white', 'py-1', 'px-2', 'rounded', 'text-sm');
                    cancelButton.onclick = () => cancelOrder(order); 
                    actionsCell.appendChild(cancelButton);
                }

                const pendingRequests = order.cancellationRequests?.filter(req => req.status === 'pending');
                if (pendingRequests && pendingRequests.length > 0) {
                    pendingRequests.forEach(req => {
                        const reqDiv = document.createElement('div');
                        reqDiv.classList.add('mt-1', 'p-1', 'bg-yellow-100', 'rounded', 'text-xs');
                        const productForItem = order.items.find(i => i.productId === req.itemId);
                        reqDiv.innerHTML = `${translations[currentLanguage].cancellationRequestLabel}: ${productForItem?.productName || req.itemId}. ${translations[currentLanguage].cancelReasonLabel}: ${req.reason || 'N/A'}`;
                        
                        const approveBtn = document.createElement('button');
                        approveBtn.textContent = translations[currentLanguage].approveButton;
                        approveBtn.classList.add('bg-green-500', 'text-white', 'px-1', 'py-0.5', 'rounded', 'text-xs', 'ms-1');
                        approveBtn.onclick = () => handleCancellationRequest(order.id, req.itemId, true);
                        reqDiv.appendChild(approveBtn);

                        const rejectBtn = document.createElement('button');
                        rejectBtn.textContent = translations[currentLanguage].rejectButton;
                        rejectBtn.classList.add('bg-red-500', 'text-white', 'px-1', 'py-0.5', 'rounded', 'text-xs', 'ms-1');
                        rejectBtn.onclick = () => handleCancellationRequest(order.id, req.itemId, false);
                        reqDiv.appendChild(rejectBtn);
                        actionsCell.appendChild(reqDiv);
                    });
                }
            });
        }
        if(adminOrderFilterSelect) adminOrderFilterSelect.onchange = () => loadAdminData();

        async function updateOrderStatus(orderId, status) {
            const orderRef = doc(db, `/artifacts/${firestoreAppId}/public/data/orders`, orderId);
            try {
                await updateDoc(orderRef, { status: status, updatedAt: Timestamp.now() });
                const statusKey = `status${status.charAt(0).toUpperCase() + status.slice(1).replace(/_([a-z])/g, g => g[1].toUpperCase())}`;
                showToast("toastOrderStatusUpdated", "success", {orderId: orderId.substring(0,6), status: translations[currentLanguage][statusKey] || status});
                
                const orderDoc = await getDoc(orderRef);
                if(orderDoc.exists()){
                    const orderData = orderDoc.data();
                     await addNotification(orderData.section, `Order #${orderId.substring(0,6)} status updated to "${status}".`); // Needs translation if user sees this
                }
            } catch (error) {
                console.error("Error updating order status: ", error);
                showToast("toastOrderStatusUpdateError", "error");
            }
        }

        async function markOrderDelivered(order) {
            const orderRef = doc(db, `/artifacts/${firestoreAppId}/public/data/orders`, order.id);
            try {
                await updateDoc(orderRef, { status: 'delivered', deliveryDate: Timestamp.now(), updatedAt: Timestamp.now() });
                const batch = writeBatch(db);
                order.items.forEach(item => {
                    if (item.quantityDelivered > 0) { 
                        const deliveryRecordRef = doc(collection(db, `/artifacts/${firestoreAppId}/public/data/deliveryRecords`));
                        batch.set(deliveryRecordRef, {
                            orderId: order.id, productId: item.productId, productName: item.productName,
                            quantityDelivered: item.quantityDelivered, unit: item.unit, section: order.section,
                            deliveredAt: Timestamp.now() 
                        });
                    }
                });
                await batch.commit();
                showToast("toastOrderDeliveredAndRecorded", "success", {orderId: order.id.substring(0,6)});
                await addNotification(order.section, `Your order #${order.id.substring(0,6)} has been delivered.`); // Needs translation
            } catch (error) {
                console.error("Error marking order delivered: ", error);
                showToast("toastOrderDeliverError", "error");
            }
        }
        
        async function cancelOrder(order) { 
            const confirmModal = document.getElementById('customConfirmModal');
            const confirmMessage = document.getElementById('customConfirmMessage');
            confirmMessage.textContent = translations[currentLanguage].toastOrderCancelConfirm
                .replace("{orderId}", order.id.substring(0,6))
                .replace("{section}", translations[currentLanguage][`filter${order.section}`] || order.section);
            document.querySelector('#customConfirmModal h3').textContent = translations[currentLanguage].confirmTitle;
            document.getElementById('customConfirmYes').textContent = translations[currentLanguage].confirmYes;
            document.getElementById('customConfirmNo').textContent = translations[currentLanguage].confirmNo;

            confirmModal.classList.remove('hidden');
            document.getElementById('customConfirmYes').onclick = async () => {
                confirmModal.classList.add('hidden');
                const orderRef = doc(db, `/artifacts/${firestoreAppId}/public/data/orders`, order.id);
                try {
                    const batch = writeBatch(db);
                    for (const item of order.items) {
                        const quantityToReturn = item.quantityDelivered > 0 ? item.quantityDelivered : item.quantityOrdered;
                        if (quantityToReturn > 0) {
                            const productRef = doc(db, `/artifacts/${firestoreAppId}/public/data/products`, item.productId);
                            const productDoc = await getDoc(productRef);
                            if (productDoc.exists()) {
                                const currentStock = productDoc.data().stock;
                                batch.update(productRef, { stock: currentStock + quantityToReturn, updatedAt: Timestamp.now() });
                            }
                        }
                    }
                    batch.update(orderRef, { status: 'cancelled', items: order.items.map(i => ({...i, quantityDelivered: 0})), updatedAt: Timestamp.now() }); 
                    await batch.commit();
                    showToast("toastOrderCancelled", "success", {orderId: order.id.substring(0,6)});
                    await addNotification(order.section, `Your order #${order.id.substring(0,6)} has been cancelled by admin.`); // Needs translation
                } catch (error) {
                    console.error("Error cancelling order: ", error);
                    showToast("toastOrderCancelError", "error");
                }
            };
            document.getElementById('customConfirmNo').onclick = () => confirmModal.classList.add('hidden');
        }

        async function handleCancellationRequest(orderId, itemId, approve) { 
            const orderRef = doc(db, `/artifacts/${firestoreAppId}/public/data/orders`, orderId);
            try {
                const orderDoc = await getDoc(orderRef);
                if (!orderDoc.exists()) { showToast("toastOrderNotFound", "error"); return; } // Assuming toastOrderNotFound key
                let orderData = orderDoc.data();
                let itemToCancel = orderData.items.find(item => item.productId === itemId);
                let request = orderData.cancellationRequests.find(req => req.itemId === itemId && req.status === 'pending');

                if (!itemToCancel || !request) { showToast("toastCancellationRequestNotFound", "error"); return; }
                const batch = writeBatch(db);
                if (approve) {
                    const productRef = doc(db, `/artifacts/${firestoreAppId}/public/data/products`, itemToCancel.productId);
                    const productDocSnap = await getDoc(productRef);
                    if (productDocSnap.exists()) {
                        const currentStock = productDocSnap.data().stock;
                        batch.update(productRef, { stock: currentStock + itemToCancel.quantityOrdered, updatedAt: Timestamp.now() });
                    }
                    itemToCancel.quantityDelivered = 0; 
                    request.status = 'approved';
                    await addNotification(orderData.section, `Cancellation request for ${itemToCancel.productName} in order #${orderId.substring(0,6)} has been approved.`); // Needs translation
                    showToast("toastCancellationRequestApproved", "success", {productName: itemToCancel.productName});
                } else {
                    request.status = 'rejected';
                    await addNotification(orderData.section, `Cancellation request for ${itemToCancel.productName} in order #${orderId.substring(0,6)} has been rejected.`); // Needs translation
                    showToast("toastCancellationRequestRejected", "info", {productName: itemToCancel.productName});
                }
                const updatedItems = orderData.items.map(i => i.productId === itemId ? itemToCancel : i);
                const updatedRequests = orderData.cancellationRequests.map(r => r.itemId === itemId && r.status === 'pending' ? request : r);
                let newOrderStatus = orderData.status;
                const allItemsEffectivelyCancelled = updatedItems.every(i => i.quantityDelivered === 0);
                if (allItemsEffectivelyCancelled) newOrderStatus = 'cancelled';
                else if (updatedItems.some(i => i.quantityDelivered < i.quantityOrdered && i.quantityDelivered > 0)) newOrderStatus = 'partially_delivered'; 
                else if (updatedItems.some(i => i.quantityDelivered === 0 && i.quantityOrdered > 0)) newOrderStatus = 'partially_cancelled';
                batch.update(orderRef, { items: updatedItems, cancellationRequests: updatedRequests, status: newOrderStatus, updatedAt: Timestamp.now() });
                await batch.commit();
            } catch (error) {
                console.error("Error handling cancellation request: ", error);
                showToast("toastCancellationRequestHandleError", "error");
            }
        }

        function renderUserOrdersTable(orders) {
            if (!userOrdersTableBody) return;
            userOrdersTableBody.innerHTML = '';
            orders.filter(order => order.orderByUserId === currentUserId && order.section === currentSection)
                  .forEach(order => {
                const row = userOrdersTableBody.insertRow();
                row.insertCell().textContent = order.id.substring(0, 6);
                row.insertCell().innerHTML = order.items.map(item => 
                    `<div>${item.productName} (${translations[currentLanguage].orderQuantity}: ${item.quantityOrdered}${item.unit}, ${translations[currentLanguage].deliveredQuantity}: ${item.quantityDelivered}${item.unit})</div>`
                ).join('');
                row.insertCell().textContent = new Date(order.orderDate.seconds * 1000).toLocaleDateString(currentLanguage === 'ar' ? 'ar-SA' : 'en-GB');
                
                const statusCell = row.insertCell();
                const statusBadge = document.createElement('span');
                const statusKey = `status${order.status.charAt(0).toUpperCase() + order.status.slice(1).replace(/_([a-z])/g, g => g[1].toUpperCase())}`;
                statusBadge.textContent = translations[currentLanguage][statusKey] || order.status;
                statusBadge.classList.add('px-2', 'py-1', 'text-xs', 'font-semibold', 'rounded-full');
                setStatusBadgeColor(statusBadge, order.status);
                statusCell.appendChild(statusBadge);

                order.items.forEach(item => {
                    const request = order.cancellationRequests?.find(r => r.itemId === item.productId);
                    if (request) {
                        const reqStatusSpan = document.createElement('span');
                        reqStatusSpan.classList.add('ms-2', 'text-xs');
                        let reqStatusText = '';
                        if (request.status === 'pending') {
                            reqStatusText = `(${item.productName} ${translations[currentLanguage].statusPending})`; // Simplified
                            reqStatusSpan.classList.add('text-yellow-600');
                        } else if (request.status === 'approved') {
                            reqStatusText = `(${item.productName} ${translations[currentLanguage].approveButton})`; // Simplified
                            reqStatusSpan.classList.add('text-green-600');
                        } else if (request.status === 'rejected') {
                            reqStatusText = `(${item.productName} ${translations[currentLanguage].rejectButton})`; // Simplified
                            reqStatusSpan.classList.add('text-red-600');
                        }
                        reqStatusSpan.textContent = reqStatusText;
                        statusCell.appendChild(document.createElement('br'));
                        statusCell.appendChild(reqStatusSpan);
                    }
                });

                const actionsCell = row.insertCell();
                if (order.status === 'delivered' || order.status === 'partially_delivered' || order.status === 'processing') {
                    order.items.forEach(item => {
                        const existingRequest = order.cancellationRequests?.find(r => r.itemId === item.productId && (r.status === 'pending' || r.status === 'approved'));
                        if (!existingRequest && item.quantityDelivered > 0) { 
                            const requestCancelButton = document.createElement('button');
                            requestCancelButton.textContent = `${item.productName} (${item.quantityDelivered}${item.unit}) ${translations[currentLanguage].cancelItemRequestButtonSuffix}`;
                            requestCancelButton.classList.add('bg-yellow-500', 'hover:bg-yellow-700', 'text-black', 'py-1', 'px-2', 'rounded', 'text-sm', 'mt-1', 'block');
                            requestCancelButton.onclick = () => openUserCancelItemModal(order.id, item);
                            actionsCell.appendChild(requestCancelButton);
                        }
                    });
                }
            });
        }

        function openUserCancelItemModal(orderId, item) {
            if (!userCancelItemModal) return;
            userCancelOrderIdInput.value = orderId;
            userCancelItemIdInput.value = item.productId; 
            userCancelItemNameSpan.textContent = `${item.productName} (${translations[currentLanguage].deliveredQuantity}: ${item.quantityDelivered}${item.unit})`;
            userCancelItemForm.reset(); 
            // Update modal texts
            userCancelItemModal.querySelector('h3').innerHTML = `${translations[currentLanguage].cancelDeliveryRequestTitlePrefix} <span id="userCancelItemNameSpan" class="text-green-600">${item.productName}</span>`;
            userCancelItemModal.querySelector('label[for="userCancelReason"]').textContent = translations[currentLanguage].cancelReasonLabel;
            document.getElementById('userCancelReason').placeholder = translations[currentLanguage].cancelReasonPlaceholder;
            closeUserCancelModalButton.textContent = translations[currentLanguage].closeButton;
            userCancelItemModal.querySelector('button[type="submit"]').textContent = translations[currentLanguage].submitRequestButton;

            userCancelItemModal.classList.remove('hidden');
        }
        if(closeUserCancelModalButton) closeUserCancelModalButton.onclick = () => userCancelItemModal.classList.add('hidden');

        async function handleUserSubmitCancelRequest(e) {
            e.preventDefault();
            const orderId = userCancelOrderIdInput.value;
            const itemId = userCancelItemIdInput.value; 
            const reason = userCancelReasonInput.value;

            if (!reason) { showToast("toastCancellationRequestReason", "error"); return; }
            const orderRef = doc(db, `/artifacts/${firestoreAppId}/public/data/orders`, orderId);
            try {
                const orderDoc = await getDoc(orderRef);
                if (!orderDoc.exists()) { showToast("toastOrderNotFound", "error"); return; }
                let orderData = orderDoc.data();
                let itemToRequestCancel = orderData.items.find(i => i.productId === itemId);
                if (!itemToRequestCancel) { showToast("toastProductNotFound", "error"); return; }
                let existingRequest = orderData.cancellationRequests?.find(r => r.itemId === itemId && r.status === 'pending');
                if (existingRequest) {
                    showToast("toastCancellationRequestExists", "warning");
                    userCancelItemModal.classList.add('hidden'); return;
                }
                const newRequest = { itemId, requestedByUserId: currentUserId, reason, requestedAt: Timestamp.now(), status: 'pending' };
                const updatedRequests = orderData.cancellationRequests ? [...orderData.cancellationRequests, newRequest] : [newRequest];
                await updateDoc(orderRef, { cancellationRequests: updatedRequests, updatedAt: Timestamp.now() });
                await addNotification("Admin", `Cancellation request for ${itemToRequestCancel.productName} in order #${orderId.substring(0,6)}. Reason: ${reason}`); // Needs translation
                showToast("toastCancellationRequestSubmitted", "success");
                userCancelItemModal.classList.add('hidden');
            } catch (error) {
                console.error("Error submitting cancellation request: ", error);
                showToast("toastCancellationRequestSubmitError", "error");
            }
        }
        if(userCancelItemForm) userCancelItemForm.addEventListener('submit', handleUserSubmitCancelRequest);

        function renderLowStockTable(lowStockProducts) {
            if (!lowStockTableBody) return;
            lowStockTableBody.innerHTML = '';
            lowStockProducts.forEach(product => {
                if (product.stock < product.lowStockAlertThreshold && !product.isLowStockAlertIgnored) {
                    const row = lowStockTableBody.insertRow();
                    row.insertCell().textContent = product.name;
                    row.insertCell().textContent = `${product.stock} ${translations[currentLanguage][`unit${product.unit.charAt(0).toUpperCase() + product.unit.slice(1)}`] || product.unit}`;
                    row.insertCell().textContent = product.lowStockAlertThreshold;
                    row.classList.add('bg-red-100', 'text-red-700');
                    const actionsCell = row.insertCell();
                    const ignoreButton = document.createElement('button');
                    ignoreButton.textContent = translations[currentLanguage].alertIgnoreButton;
                    ignoreButton.classList.add('bg-yellow-500', 'hover:bg-yellow-700', 'text-black', 'py-1', 'px-2', 'rounded', 'text-sm');
                    ignoreButton.onclick = () => ignoreLowStockAlert(product.id, true);
                    actionsCell.appendChild(ignoreButton);
                }
            });
        }
        
        async function ignoreLowStockAlert(productId, ignore) {
            const productRef = doc(db, `/artifacts/${firestoreAppId}/public/data/products`, productId);
            try {
                await updateDoc(productRef, { isLowStockAlertIgnored: ignore, updatedAt: Timestamp.now() });
                const statusText = ignore ? translations[currentLanguage].alertIgnored : translations[currentLanguage].alertReactivated;
                showToast("toastLowStockAlertIgnored", "info", {status: statusText});
            } catch (error) {
                console.error("Error updating low stock alert ignore status:", error);
                showToast("toastLowStockAlertUpdateError", "error");
            }
        }

        async function addNotification(target, message) { 
            try {
                const notificationsRef = collection(db, `/artifacts/${firestoreAppId}/public/data/notifications`);
                await addDoc(notificationsRef, { target, message, isRead: false, timestamp: Timestamp.now() });
            } catch (error) { console.error("Error adding notification: ", error); }
        }

        function renderNotifications(listElement, notifications) {
            if (!listElement) return;
            listElement.innerHTML = '';
            if (notifications.length === 0) {
                listElement.innerHTML = `<li class="text-gray-500">${translations[currentLanguage].toastNoNewNotifications}</li>`;
                return;
            }
            notifications.forEach(notif => {
                const li = document.createElement('li');
                // For now, notification messages from DB are not translated. If they need to be, message content should be keys.
                li.innerHTML = `
                    <div class="p-3 rounded-lg ${notif.isRead ? 'bg-gray-100' : 'bg-blue-50 shadow-md'}">
                        <p class="${notif.isRead ? 'text-gray-600' : 'text-blue-700 font-semibold'}">${notif.message}</p>
                        <small class="text-gray-500">${new Date(notif.timestamp.seconds * 1000).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-GB')}</small>
                        ${!notif.isRead ? `<button data-id="${notif.id}" class="mark-as-read-btn ms-2 text-xs text-blue-500 hover:underline">${translations[currentLanguage].toastMarkAsRead}</button>` : ''}
                    </div>`;
                listElement.appendChild(li);
            });
            listElement.querySelectorAll('.mark-as-read-btn').forEach(button => {
                button.addEventListener('click', (e) => markNotificationAsRead(e.target.dataset.id));
            });
        }
        
        async function markNotificationAsRead(notificationId) {
            const notifRef = doc(db, `/artifacts/${firestoreAppId}/public/data/notifications`, notificationId);
            try { await updateDoc(notifRef, { isRead: true }); }
            catch (error) { console.error("Error marking notification as read:", error); }
        }

        function renderUserProducts(products) {
            if (!userProductsListDiv) return;
            userProductsListDiv.innerHTML = '';
            products.filter(p => p.stock > 0) 
                    .forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('p-4', 'border', 'rounded-lg', 'shadow', 'bg-white');
                const unitText = translations[currentLanguage][`unit${product.unit.charAt(0).toUpperCase() + product.unit.slice(1)}`] || product.unit;
                productCard.innerHTML = `
                    <h3 class="text-lg font-semibold">${product.name}</h3>
                    <p class="text-sm text-gray-600">${translations[currentLanguage].tableHeaderCategory}: ${product.category}</p>
                    <p class="text-sm text-gray-600">${translations[currentLanguage].tableHeaderStock}: ${product.stock.toFixed(product.unit === 'kg' ? 2 : 0)} ${unitText}</p>
                    <div class="mt-2">
                        <input type="number" min="0" ${product.unit === 'kg' ? 'step="0.1"' : 'step="1"'} placeholder="${translations[currentLanguage].quantity}" class="w-full p-1 border rounded product-quantity-input" data-product-id="${product.id}">
                        <button class="add-to-cart-btn mt-2 w-full bg-green-500 hover:bg-green-700 text-white py-1 px-3 rounded text-sm" data-product-id="${product.id}">${translations[currentLanguage].addToCartButton}</button>
                    </div>`;
                userProductsListDiv.appendChild(productCard);
            });
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    const quantityInput = document.querySelector(`.product-quantity-input[data-product-id="${productId}"]`);
                    const quantity = parseFloat(quantityInput.value);
                    const product = productsCache.find(p => p.id === productId);
                    if (product && quantity > 0) {
                        if (quantity > product.stock) {
                            showToast("toastProductOutOfStockFull", "error", {productName: product.name, stock: product.stock, unit: product.unit}); return;
                        }
                        addToCart(product, quantity);
                        quantityInput.value = ''; 
                    } else { showToast("toastEnterValidQuantity", "error"); }
                });
            });
        }

        function addToCart(product, quantity) {
            const existingItem = shoppingCart.find(item => item.productId === product.id);
            if (existingItem) {
                if (existingItem.quantity + quantity > product.stock) {
                     showToast("toastProductOutOfStockFull", "error", {productName: product.name, stock: product.stock, unit: product.unit }); return;
                }
                existingItem.quantity += quantity;
            } else {
                shoppingCart.push({ productId: product.id, name: product.name, quantity, unit: product.unit, stock: product.stock });
            }
            renderShoppingCart();
            showToast("toastAddedToCart", "success", {quantity, unit: product.unit, productName: product.name});
        }

        function removeFromCart(productId) {
            shoppingCart = shoppingCart.filter(item => item.productId !== productId);
            renderShoppingCart();
        }
        
        function updateCartQuantity(productId, newQuantity) {
            const item = shoppingCart.find(item => item.productId === productId);
            const product = productsCache.find(p => p.id === productId);
            if (item && product) {
                if (newQuantity <= 0) removeFromCart(productId);
                else if (newQuantity > product.stock) {
                    showToast("toastProductOutOfStockFull", "error", { productName: product.name, stock: product.stock, unit: product.unit});
                    const inputElement = userShoppingCartDiv.querySelector(`input[data-product-id="${productId}"]`);
                    if(inputElement) inputElement.value = product.stock;
                    item.quantity = product.stock; 
                } else { item.quantity = newQuantity; }
            }
            renderShoppingCart();
        }

        function renderShoppingCart() {
            if (!userShoppingCartDiv) return;
            userShoppingCartDiv.innerHTML = '';
            if (shoppingCart.length === 0) {
                userShoppingCartDiv.innerHTML = `<p class="text-gray-500">${translations[currentLanguage].toastCartEmptyMessage}</p>`;
                placeOrderButton.classList.add('hidden'); return;
            }
            placeOrderButton.classList.remove('hidden');
            placeOrderButton.textContent = translations[currentLanguage].placeOrderButton; // Update button text
            const ul = document.createElement('ul');
            ul.classList.add('space-y-2');
            shoppingCart.forEach(item => {
                const li = document.createElement('li');
                li.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'border-b');
                const unitText = translations[currentLanguage][`unit${item.unit.charAt(0).toUpperCase() + item.unit.slice(1)}`] || item.unit;
                li.innerHTML = `
                    <div>
                        <span class="font-semibold">${item.name}</span>
                        <input type="number" value="${item.quantity}" min="0" ${item.unit === 'kg' ? 'step="0.1"' : 'step="1"'} 
                               data-product-id="${item.productId}" class="cart-item-quantity-input ms-2 w-20 p-1 border rounded text-sm">
                        <span>${unitText}</span>
                    </div>
                    <button class="remove-from-cart-btn text-red-500 hover:text-red-700 text-sm" data-product-id="${item.productId}">${translations[currentLanguage].removeButton}</button>`;
                ul.appendChild(li);
            });
            userShoppingCartDiv.appendChild(ul);
            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => removeFromCart(e.target.dataset.productId));
            });
            document.querySelectorAll('.cart-item-quantity-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    updateCartQuantity(e.target.dataset.productId, parseFloat(e.target.value));
                });
            });
        }
        
        function populateMonthFilter() {
            if (!reportMonthSelect) return;
            reportMonthSelect.innerHTML = ''; 
            const currentMonth = new Date().getMonth(); 
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 6; i++) { 
                const date = new Date(currentYear, currentMonth - i, 1);
                const monthYearValue = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; 
                const monthYearText = date.toLocaleDateString(currentLanguage === 'ar' ? 'ar-SA-u-nu-latn' : 'en-GB', { year: 'numeric', month: 'long' }); // Use latn numbers for ar-SA for value consistency
                const option = document.createElement('option');
                option.value = monthYearValue;
                option.textContent = monthYearText;
                reportMonthSelect.appendChild(option);
            }
            if (reportMonthSelect.options.length > 0) loadDeliveryReports(reportMonthSelect.value);
        }
        if (reportMonthSelect) reportMonthSelect.onchange = (e) => loadDeliveryReports(e.target.value);

        async function loadDeliveryReports(selectedMonthYear) { 
            if (!deliveryReportTableBody) return;
            deliveryReportTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">${translations[currentLanguage].toastReportLoading}</td></tr>`;
            if (!selectedMonthYear) {
                deliveryReportTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">${translations[currentLanguage].toastSelectMonthForReport}</td></tr>`;
                return;
            }
            const [year, month] = selectedMonthYear.split('-').map(Number);
            let startDate = new Date(year, month - 2, 20, 0, 0, 0, 0); 
            let endDate = new Date(year, month - 1, 20, 23, 59, 59, 999);
            const q = query( collection(db, `/artifacts/${firestoreAppId}/public/data/deliveryRecords`),
                where("deliveredAt", ">=", Timestamp.fromDate(startDate)),
                where("deliveredAt", "<=", Timestamp.fromDate(endDate)) );
            try {
                const querySnapshot = await getDocs(q);
                const records = [];
                querySnapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                records.sort((a, b) => b.deliveredAt.seconds - a.deliveredAt.seconds);
                renderDeliveryReportTable(records);
            } catch (error) {
                console.error("Error loading delivery reports: ", error);
                showToast("toastDeliveryReportLoadError", "error");
                deliveryReportTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">${translations[currentLanguage].toastDeliveryReportLoadFail}</td></tr>`;
            }
        }
        
        function renderDeliveryReportTable(records) {
            if (!deliveryReportTableBody) return;
            deliveryReportTableBody.innerHTML = '';
            if (records.length === 0) {
                deliveryReportTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">${translations[currentLanguage].toastNoDeliveryRecordsForMonth}</td></tr>`;
                return;
            }
            const aggregatedData = {};
            records.forEach(record => {
                const key = `${record.section}-${record.productId}`;
                if (!aggregatedData[key]) {
                    aggregatedData[key] = { section: record.section, productName: record.productName, unit: record.unit, totalQuantity: 0 };
                }
                aggregatedData[key].totalQuantity += record.quantityDelivered;
            });
            Object.values(aggregatedData).forEach(item => {
                const row = deliveryReportTableBody.insertRow();
                row.insertCell().textContent = translations[currentLanguage][`filter${item.section}`] || item.section;
                row.insertCell().textContent = item.productName; // Product name from DB
                const unitText = translations[currentLanguage][`unit${item.unit.charAt(0).toUpperCase() + item.unit.slice(1)}`] || item.unit;
                row.insertCell().textContent = `${item.totalQuantity.toFixed(item.unit === 'kg' ? 2 : 0)} ${unitText}`;
            });
        }
        
        async function cleanupOldDeliveryRecords() {
            const confirmModal = document.getElementById('customConfirmModal');
            const confirmMessage = document.getElementById('customConfirmMessage');
            confirmMessage.textContent = translations[currentLanguage].toastConfirmDeleteOldRecords;
            document.querySelector('#customConfirmModal h3').textContent = translations[currentLanguage].confirmTitle;
            document.getElementById('customConfirmYes').textContent = translations[currentLanguage].confirmYes;
            document.getElementById('customConfirmNo').textContent = translations[currentLanguage].confirmNo;
            confirmModal.classList.remove('hidden');
            
            document.getElementById('customConfirmYes').onclick = async () => {
                confirmModal.classList.add('hidden');
                showView('loadingView'); 
                let cutoffDate = new Date();
                const currentDay = new Date().getDate();
                let targetMonth = new Date().getMonth(); 
                let targetYear = new Date().getFullYear();
                if (currentDay < 20) { targetMonth -= 1; if (targetMonth < 0) { targetMonth = 11; targetYear -=1; } }
                cutoffDate = new Date(targetYear, targetMonth - 3, 20, 0, 0, 0, 0);
                const q = query( collection(db, `/artifacts/${firestoreAppId}/public/data/deliveryRecords`),
                    where("deliveredAt", "<", Timestamp.fromDate(cutoffDate)) );
                try {
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) {
                        showToast("toastNoOldRecordsFound", "info");
                        if (currentUser && currentUser.email) showAdminSection('adminReportsSection'); else showView('loginView');
                        return;
                    }
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showToast("toastOldRecordsDeleted", "success", {count: snapshot.size});
                    loadDeliveryReports(reportMonthSelect.value); 
                } catch (error) {
                    console.error("Error cleaning up old records: ", error);
                    showToast("toastOldRecordsDeleteError", "error");
                } finally {
                     if (currentUser && currentUser.email) showAdminSection('adminReportsSection'); else showView('loginView'); 
                }
            };
            document.getElementById('customConfirmNo').onclick = () => confirmModal.classList.add('hidden');
        }
        if(cleanupOldRecordsButton) cleanupOldRecordsButton.addEventListener('click', cleanupOldDeliveryRecords);

        function translateStatus(status) { // Kept for direct use if needed, but mostly keys are used now
            const statusKey = `status${status.charAt(0).toUpperCase() + status.slice(1).replace(/_([a-z])/g, g => g[1].toUpperCase())}`;
            return translations[currentLanguage][statusKey] || status;
        }

        function setStatusBadgeColor(element, status) {
            element.classList.remove('bg-yellow-200', 'text-yellow-800', 'bg-blue-200', 'text-blue-800', 'bg-green-200', 'text-green-800', 'bg-red-200', 'text-red-800', 'bg-purple-200', 'text-purple-800');
            switch (status) {
                case 'pending': element.classList.add('bg-yellow-200', 'text-yellow-800'); break;
                case 'processing': element.classList.add('bg-blue-200', 'text-blue-800'); break;
                case 'delivered': element.classList.add('bg-green-200', 'text-green-800'); break;
                case 'cancelled': element.classList.add('bg-red-200', 'text-red-800'); break;
                case 'partially_cancelled': case 'partially_delivered': element.classList.add('bg-purple-200', 'text-purple-800'); break;
                default: element.classList.add('bg-gray-200', 'text-gray-800');
            }
        }

        function cleanupListeners() {
            if (unsubscribeProductsListener) unsubscribeProductsListener();
            if (unsubscribeOrdersListener) unsubscribeOrdersListener();
            if (unsubscribeNotificationsListener) unsubscribeNotificationsListener();
            if (unsubscribeLowStockListener) unsubscribeLowStockListener(); 
            if (unsubscribeDeliveryRecordsListener) unsubscribeDeliveryRecordsListener(); 
            unsubscribeProductsListener = null; unsubscribeOrdersListener = null;
            unsubscribeNotificationsListener = null; unsubscribeLowStockListener = null;
            unsubscribeDeliveryRecordsListener = null;
        }
        
        async function loadAdminData() {
            cleanupListeners(); 
            const productsQuery = query(collection(db, `/artifacts/${firestoreAppId}/public/data/products`), orderBy("name"));
            unsubscribeProductsListener = onSnapshot(productsQuery, (snapshot) => {
                const products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                productsCache = products; 
                renderProductsTable(products); renderLowStockTable(products); 
                if (currentSection && userProductsListDiv) renderUserProducts(products); 
            }, (error) => { console.error("Error fetching products: ", error); showToast("toastProductsLoadError", "error"); });

            const ordersQuery = query(collection(db, `/artifacts/${firestoreAppId}/public/data/orders`), orderBy("orderDate", "desc"));
            unsubscribeOrdersListener = onSnapshot(ordersQuery, (snapshot) => {
                renderAdminOrdersTable(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }, (error) => { console.error("Error fetching admin orders: ", error); showToast("toastOrdersLoadError", "error"); });
            
            const adminNotificationsQuery = query( collection(db, `/artifacts/${firestoreAppId}/public/data/notifications`), 
                where("target", "==", "Admin"), orderBy("timestamp", "desc"), limit(20) );
            unsubscribeNotificationsListener = onSnapshot(adminNotificationsQuery, (snapshot) => {
                renderNotifications(adminNotificationsList, snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }, (error) => { console.error("Error fetching admin notifications: ", error); showToast("toastAdminNotificationsLoadError", "error");});
            populateMonthFilter();
        }

        async function loadUserData() {
            cleanupListeners();
            const productsQuery = query(collection(db, `/artifacts/${firestoreAppId}/public/data/products`), orderBy("name"));
            unsubscribeProductsListener = onSnapshot(productsQuery, (snapshot) => {
                productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserProducts(productsCache); renderShoppingCart(); 
            }, (error) => { console.error("Error fetching products for user: ", error); showToast("toastProductsLoadError", "error"); });

            const userOrdersQuery = query( collection(db, `/artifacts/${firestoreAppId}/public/data/orders`), 
                where("orderByUserId", "==", currentUserId), where("section", "==", currentSection), orderBy("orderDate", "desc") );
            unsubscribeOrdersListener = onSnapshot(userOrdersQuery, (snapshot) => {
                renderUserOrdersTable(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }, (error) => { console.error("Error fetching user orders: ", error); showToast("toastUserOrdersLoadError", "error"); });
            
            const userNotificationsQuery = query( collection(db, `/artifacts/${firestoreAppId}/public/data/notifications`), 
                where("target", "==", currentSection), orderBy("timestamp", "desc"), limit(20) );
            unsubscribeNotificationsListener = onSnapshot(userNotificationsQuery, (snapshot) => {
                renderNotifications(userNotificationsList, snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }, (error) => { console.error("Error fetching user notifications: ", error); showToast("toastUserNotificationsLoadError", "error");});
        }

        adminNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionName = e.target.closest('a').dataset.section;
                showAdminSection(sectionName);
                if (sectionName === 'adminReportsSection') loadDeliveryReports(reportMonthSelect.value);
            });
        });
        userNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showUserSection(e.target.closest('a').dataset.section);
            });
        });
        window.onclick = function(event) {
            if (event.target == restockModal) restockModal.classList.add('hidden');
            if (event.target == userCancelItemModal) userCancelItemModal.classList.add('hidden');
            const confirmModal = document.getElementById('customConfirmModal');
            if (event.target == confirmModal) confirmModal.classList.add('hidden');
        }
        showView('loadingView'); 
    </script>
    <style>
        body { font-family: 'Tajawal', 'Inter', sans-serif; } /* Added Tajawal for Arabic */
        .admin-nav-link.active { background-color: #2563eb; color: white; } 
        .user-nav-link.active { background-color: #059669; color: white; } 
        /* RTL support for Tailwind needs to be managed by `dir` attribute on html tag */
        /* For specific RTL styling if needed: */
        html[dir="rtl"] .space-x-1 > :not([hidden]) ~ :not([hidden]) { margin-right: 0.25rem; margin-left: 0; }
        html[dir="rtl"] .space-x-2 > :not([hidden]) ~ :not([hidden]) { margin-right: 0.5rem; margin-left: 0; }
        html[dir="rtl"] .ms-1 { margin-right: 0.25rem; margin-left:0; }
        html[dir="rtl"] .ms-2 { margin-right: 0.5rem; margin-left:0; }
        html[dir="rtl"] .me-2 { margin-left: 0.5rem; margin-right:0;}


        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fadeInOut { animation: fadeInOut 3s ease-in-out forwards; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loadingView" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold text-gray-700" data-lang-key="loading">লোড হচ্ছে...</p>
        </div>
    </div>

    <div id="toastNotification" class="fixed top-5 start-5 p-4 rounded-md text-white shadow-lg hidden z-50 max-w-sm">
        <p id="toastMessage">Toast message goes here.</p>
    </div>

    <div id="customConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4" data-lang-key="confirmTitle">নিশ্চিত করুন</h3>
            <p id="customConfirmMessage" class="mb-6 text-gray-700" data-lang-key="confirmMessageDefault">আপনি কি নিশ্চিত?</p>
            <div class="flex justify-end space-x-3">
                <button id="customConfirmNo" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400" data-lang-key="confirmNo">না</button>
                <button id="customConfirmYes" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" data-lang-key="confirmYes">হ্যাঁ</button>
            </div>
        </div>
    </div>

    <div id="loginView" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="absolute top-4 end-4 space-x-2">
            <button class="lang-switcher-btn px-3 py-1 bg-gray-200 text-sm rounded hover:bg-gray-300" data-lang="ar" data-lang-key="langArabic">العربية</button>
            <button class="lang-switcher-btn px-3 py-1 bg-gray-200 text-sm rounded hover:bg-gray-300" data-lang="en" data-lang-key="langEnglish">English</button>
        </div>
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8" data-lang-key="loginViewTitle">গুডাউন ম্যানেজমেন্ট সিস্টেম</h1>
            <div class="mb-10">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2" data-lang-key="adminLoginTitle">অ্যাডমিন লগইন</h2>
                <form id="adminLoginForm" class="space-y-4">
                    <div>
                        <label for="adminEmail" class="block text-sm font-medium text-gray-600" data-lang-key="emailLabel">ইমেইল</label>
                        <input type="email" id="adminEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" data-lang-key-placeholder="emailPlaceholder" placeholder="admin@example.com">
                    </div>
                    <div>
                        <label for="adminPassword" class="block text-sm font-medium text-gray-600" data-lang-key="passwordLabel">পাসওয়ার্ড</label>
                        <input type="password" id="adminPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" data-lang-key-placeholder="passwordPlaceholder" placeholder="********">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-lang-key="adminLoginButton">অ্যাডমিন লগইন</button>
                </form>
            </div>
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2" data-lang-key="userLoginTitle">ইউজার লগইন</h2>
                <form id="userLoginForm" class="space-y-4">
                    <div>
                        <label for="userPasscode" class="block text-sm font-medium text-gray-600" data-lang-key="passcodeLabel">পাসকোড</label>
                        <input type="password" id="userPasscode" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" data-lang-key-placeholder="passcodePlaceholder" placeholder="বিভাগের পাসকোড">
                        <p class="mt-1 text-xs text-gray-500" data-lang-key="passcodeHint">কিচেন: KhamerK, পুরুষ: KhamerM, ফ্যামিলি: KhamerF</p>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" data-lang-key="userLoginButton">ইউজার লগইন</button>
                </form>
            </div>
        </div>
    </div>

    <div id="adminDashboardView" class="hidden">
        <div class="min-h-screen flex">
            <div class="w-64 bg-blue-800 text-blue-100 p-6 space-y-6 flex flex-col">
                <h1 class="text-2xl font-semibold text-white border-b border-blue-700 pb-4" data-lang-key="adminPanelTitle">অ্যাডমিন প্যানেল</h1>
                <nav class="space-y-2">
                    <a href="#" data-section="adminProductsSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white" data-lang-key="navProducts">পণ্যসমূহ</a>
                    <a href="#" data-section="adminOrdersSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white" data-lang-key="navOrders">অর্ডারসমূহ</a>
                    <a href="#" data-section="adminRestockSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white" data-lang-key="navRestockLog">রিস্টক লগ (শীঘ্রই আসছে)</a>
                    <a href="#" data-section="adminLowStockSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white" data-lang-key="navLowStockAlert">লো স্টক অ্যালার্ট</a>
                    <a href="#" data-section="adminReportsSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white" data-lang-key="navReports">রিপোর্ট</a>
                    <a href="#" data-section="adminNotificationsSection" class="admin-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-700 hover:text-white" data-lang-key="navNotifications">নোটিফিকেশন</a>
                </nav>
                <div class="mt-auto space-y-2">
                     <div class="flex justify-around">
                        <button class="lang-switcher-btn px-2 py-1 bg-blue-600 text-xs rounded hover:bg-blue-500" data-lang="ar" data-lang-key="langArabic">العربية</button>
                        <button class="lang-switcher-btn px-2 py-1 bg-blue-600 text-xs rounded hover:bg-blue-500" data-lang="en" data-lang-key="langEnglish">English</button>
                    </div>
                    <button id="adminLogoutButton" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 rounded text-white font-medium transition duration-200" data-lang-key="logoutButton">লগ আউট</button>
                </div>
            </div>
            <div class="flex-1 p-10 bg-gray-50 overflow-y-auto">
                <section id="adminProductsSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" data-lang-key="productManagementTitle">পণ্য ব্যবস্থাপনা</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4" data-lang-key="addNewProductTitle">নতুন পণ্য যোগ করুন</h3>
                        <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="productName" class="block text-sm font-medium text-gray-600" data-lang-key="productNameLabel">পণ্যের নাম</label>
                                <input type="text" id="productName" required class="mt-1 input-field">
                            </div>
                            <div>
                                <label for="productQuantity" class="block text-sm font-medium text-gray-600" data-lang-key="productQuantityLabel">পরিমাণ</label>
                                <input type="number" id="productQuantity" step="any" required class="mt-1 input-field">
                            </div>
                            <div>
                                <label for="productUnit" class="block text-sm font-medium text-gray-600" data-lang-key="productUnitLabel">একক</label>
                                <select id="productUnit" class="mt-1 input-field">
                                    {/* Options populated by JS */}
                                </select>
                            </div>
                            <div>
                                <label for="productCategory" class="block text-sm font-medium text-gray-600" data-lang-key="productCategoryLabel">ক্যাটাগরি</label>
                                <input type="text" id="productCategory" required class="mt-1 input-field" data-lang-key-placeholder="productCategoryPlaceholder" placeholder="যেমন: চাল, ডাল, সাবান">
                            </div>
                            <div>
                                <label for="lowStockAlert" class="block text-sm font-medium text-gray-600" data-lang-key="lowStockAlertNumLabel">লো স্টক অ্যালার্ট সংখ্যা</label>
                                <input type="number" id="lowStockAlert" required class="mt-1 input-field">
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="w-full btn-primary" data-lang-key="addProductButton">পণ্য যোগ করুন</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4" data-lang-key="allProductsTitle">সকল পণ্য</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="th-cell" data-lang-key="tableHeaderName">নাম</th>
                                        <th class="th-cell" data-lang-key="tableHeaderStock">স্টক</th>
                                        <th class="th-cell" data-lang-key="tableHeaderCategory">ক্যাটাগরি</th>
                                        <th class="th-cell" data-lang-key="tableHeaderLowStockThreshold">লো স্টক থ্রেশহোল্ড</th>
                                        <th class="th-cell" data-lang-key="tableHeaderActions">কার্যক্রম</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
                <section id="adminOrdersSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" data-lang-key="ordersTitle">অর্ডারসমূহ</h2>
                     <div class="mb-4">
                        <label for="adminOrderFilter" class="me-2 font-medium" data-lang-key="filterByLabel">ফিল্টার করুন:</label>
                        <select id="adminOrderFilter" class="p-2 border rounded-md">
                            <option value="all" data-lang-key="filterAllSections">সকল বিভাগ</option>
                            <option value="Kitchen" data-lang-key="filterKitchen">কিচেন</option>
                            <option value="Men" data-lang-key="filterMen">পুরুষ</option>
                            <option value="Family" data-lang-key="filterFamily">ফ্যামিলি</option>
                        </select>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="th-cell" data-lang-key="tableHeaderOrderId">অর্ডার আইডি</th>
                                    <th class="th-cell" data-lang-key="tableHeaderSection">বিভাগ</th>
                                    <th class="th-cell" data-lang-key="tableHeaderItems">পণ্যসমূহ</th>
                                    <th class="th-cell" data-lang-key="tableHeaderOrderDate">অর্ডারের তারিখ</th>
                                    <th class="th-cell" data-lang-key="tableHeaderStatus">স্ট্যাটাস</th>
                                    <th class="th-cell" data-lang-key="tableHeaderActions">কার্যক্রম</th>
                                </tr>
                            </thead>
                            <tbody id="adminOrdersTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </section>
                <section id="adminRestockSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" data-lang-key="restockLogTitle">রিস্টক লগ</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <p class="text-gray-600" data-lang-key="comingSoon">এই ফিচারটি শীঘ্রই আসছে...</p>
                    </div>
                </section>
                <section id="adminLowStockSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" data-lang-key="lowStockAlertTitle">লো স্টক অ্যালার্ট</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                         <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-red-50">
                                <tr>
                                    <th class="th-cell text-red-700" data-lang-key="tableHeaderName">পণ্যের নাম</th>
                                    <th class="th-cell text-red-700" data-lang-key="tableHeaderStock">বর্তমান স্টক</th>
                                    <th class="th-cell text-red-700" data-lang-key="tableHeaderLowStockThreshold">লো স্টক থ্রেশহোল্ড</th>
                                    <th class="th-cell text-red-700" data-lang-key="tableHeaderActions">কার্যক্রম</th>
                                </tr>
                            </thead>
                            <tbody id="lowStockTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </section>
                <section id="adminReportsSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" data-lang-key="reportsTitle">ডেলিভারি রিপোর্ট</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <label for="reportMonthSelect" class="me-2 font-medium" data-lang-key="selectMonthLabel">মাস নির্বাচন করুন (২০ তারিখ থেকে ২০ তারিখ):</label>
                                <select id="reportMonthSelect" class="p-2 border rounded-md"></select>
                            </div>
                            <button id="cleanupOldRecordsButton" class="btn-danger" data-lang-key="cleanupOldRecordsButton">৩ মাসের পুরনো রেকর্ড মুছুন</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="th-cell" data-lang-key="tableHeaderSection">বিভাগ</th>
                                        <th class="th-cell" data-lang-key="tableHeaderName">পণ্যের নাম</th>
                                        <th class="th-cell" data-lang-key="tableHeaderTotalDeliveredQty">মোট ডেলিভারিকৃত পরিমাণ</th>
                                    </tr>
                                </thead>
                                <tbody id="deliveryReportTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
                <section id="adminNotificationsSection" class="admin-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" data-lang-key="notificationsTitle">নোটিফিকেশন</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <ul id="adminNotificationsList" class="space-y-3"></ul>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="userDashboardView" class="hidden">
        <div class="min-h-screen flex">
            <div class="w-64 bg-green-800 text-green-100 p-6 space-y-6 flex flex-col">
                <h1 id="userSectionTitle" class="text-2xl font-semibold text-white border-b border-green-700 pb-4" data-lang-key="userSectionTitleDefault">ইউজার প্যানেল</h1>
                <nav class="space-y-2">
                    <a href="#" data-section="userPlaceOrderSection" class="user-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-green-700 hover:text-white" data-lang-key="navPlaceOrder">অর্ডার করুন</a>
                    <a href="#" data-section="userMyOrdersSection" class="user-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-green-700 hover:text-white" data-lang-key="navMyOrders">আমার অর্ডারসমূহ</a>
                    <a href="#" data-section="userNotificationsSection" class="user-nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-green-700 hover:text-white" data-lang-key="navNotifications">নোটিফিকেশন</a>
                </nav>
                 <div class="mt-auto space-y-2">
                     <div class="flex justify-around">
                        <button class="lang-switcher-btn px-2 py-1 bg-green-600 text-xs rounded hover:bg-green-500" data-lang="ar" data-lang-key="langArabic">العربية</button>
                        <button class="lang-switcher-btn px-2 py-1 bg-green-600 text-xs rounded hover:bg-green-500" data-lang="en" data-lang-key="langEnglish">English</button>
                    </div>
                    <button id="userLogoutButton" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 rounded text-white font-medium transition duration-200" data-lang-key="logoutButton">লগ আউট</button>
                </div>
            </div>
            <div class="flex-1 p-10 bg-gray-50 overflow-y-auto">
                <section id="userPlaceOrderSection" class="user-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" data-lang-key="placeOrderTitle">পণ্য অর্ডার করুন</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4" data-lang-key="availableProductsTitle">উপলব্ধ পণ্যসমূহ</h3>
                            <div id="userProductsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto p-2"></div>
                        </div>
                        <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4" data-lang-key="shoppingCartTitle">শপিং কার্ট</h3>
                            <div id="userShoppingCart" class="mb-4 max-h-[50vh] overflow-y-auto p-1"></div>
                            <button id="placeOrderButton" class="w-full btn-primary hidden" data-lang-key="placeOrderButton">অর্ডার প্লেস করুন</button>
                        </div>
                    </div>
                </section>
                <section id="userMyOrdersSection" class="user-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" data-lang-key="myOrdersTitle">আমার অর্ডারসমূহ</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="th-cell" data-lang-key="tableHeaderOrderId">অর্ডার আইডি</th>
                                    <th class="th-cell" data-lang-key="tableHeaderItems">পণ্যসমূহ</th>
                                    <th class="th-cell" data-lang-key="tableHeaderOrderDate">অর্ডারের তারিখ</th>
                                    <th class="th-cell" data-lang-key="tableHeaderStatus">স্ট্যাটাস</th>
                                    <th class="th-cell" data-lang-key="tableHeaderActions">কার্যক্রম</th>
                                </tr>
                            </thead>
                            <tbody id="userOrdersTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </section>
                <section id="userNotificationsSection" class="user-content-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" data-lang-key="notificationsTitle">নোটিফিকেশন</h2>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <ul id="userNotificationsList" class="space-y-3"></ul>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="restockModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-30 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-6" data-lang-key="restockButton">পণ্য রিস্টক করুন: <span id="restockProductNameSpan" class="text-blue-600"></span></h3>
            <p class="mb-2 text-sm"><span data-lang-key="currentStockLabel" id="currentStockLabel">বর্তমান স্টক:</span> <span id="currentStockSpan" class="font-semibold"></span></p>
            <form id="restockForm" class="space-y-4">
                <input type="hidden" id="restockProductId">
                <div>
                    <label for="restockQuantity" class="block text-sm font-medium text-gray-700" data-lang-key="newAddedQuantityLabel">নতুন যোগকৃত পরিমাণ</label>
                    <input type="number" id="restockQuantity" step="any" min="0" class="mt-1 input-field" placeholder="0">
                </div>
                <div>
                    <label for="damagedQuantity" class="block text-sm font-medium text-gray-700" data-lang-key="damagedReturnedQuantityLabel">ক্ষতিগ্রস্ত/ফেরতকৃত পরিমাণ</label>
                    <input type="number" id="damagedQuantity" step="any" min="0" class="mt-1 input-field" placeholder="0">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="closeRestockModalButton" class="btn-secondary" data-lang-key="closeButton">বন্ধ করুন</button>
                    <button type="submit" class="btn-primary" data-lang-key="completeRestockButton">রিস্টক সম্পন্ন করুন</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="userCancelItemModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-30 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-6" data-lang-key="cancelDeliveryRequestTitlePrefix">পণ্যের ডেলিভারি বাতিলের অনুরোধ: <span id="userCancelItemNameSpan" class="text-green-600"></span></h3>
            <form id="userCancelItemForm" class="space-y-4">
                <input type="hidden" id="userCancelOrderId">
                <input type="hidden" id="userCancelItemId">
                <div>
                    <label for="userCancelReason" class="block text-sm font-medium text-gray-700" data-lang-key="cancelReasonLabel">বাতিলের কারণ</label>
                    <textarea id="userCancelReason" rows="3" required class="mt-1 input-field" data-lang-key-placeholder="cancelReasonPlaceholder" placeholder="বিস্তারিত লিখুন..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="closeUserCancelModalButton" class="btn-secondary" data-lang-key="closeButton">বন্ধ করুন</button>
                    <button type="submit" class="btn-warning" data-lang-key="submitRequestButton">অনুরোধ জমা দিন</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .input-field { display: block; width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .input-field:focus { outline: none; border-color: #3B82F6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        .btn-primary { padding: 0.5rem 1rem; background-color: #2563EB; color: white; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #1D4ED8; }
        .btn-secondary { padding: 0.5rem 1rem; background-color: #D1D5DB; color: #1F2937; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #9CA3AF; }
        .btn-danger { padding: 0.5rem 1rem; background-color: #DC2626; color: white; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #B91C1C; }
        .btn-warning { padding: 0.5rem 1rem; background-color: #F59E0B; color: white; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; }
        .btn-warning:hover { background-color: #D97706; }
        .th-cell { padding: 0.75rem 1rem; text-align: start; font-size: 0.75rem; font-weight: 600; color: #4B5563; text-transform: uppercase; letter-spacing: 0.05em; }
        html[dir="rtl"] .th-cell { text-align: right; }
    </style>
</body>
</html>